# ç‰©å“å †å è§„åˆ™è¯´æ˜

## ğŸ“‹ å †å è§„åˆ™æ€»è§ˆ

ç‰©å“å †å éµå¾ªä»¥ä¸‹è§„åˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ï¼š

### 1ï¸âƒ£ **å¼ºåˆ¶è§„åˆ™ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰**

#### âŒ å¸¦å®¹å™¨çš„ç‰©å“ä¸å¯å †å 

**è§„åˆ™è¯´æ˜ï¼š**
- å¦‚æœç‰©å“**å®šä¹‰**å£°æ˜äº†å®¹å™¨åŠŸèƒ½ï¼ˆ`bHasContainer == true`ï¼‰ï¼Œåˆ™**å®šä¹‰çº§åˆ«**å¼ºåˆ¶ä¸å¯å †å 
- å¦‚æœç‰©å“**å®ä¾‹**åŒ…å«å®¹å™¨ï¼ˆ`HasContainer() == true`ï¼‰ï¼Œåˆ™**å®ä¾‹çº§åˆ«**å¼ºåˆ¶ä¸å¯å †å 
- æ— è®ºç‰©å“å®šä¹‰ä¸­çš„ `bStackable` è®¾ç½®ä¸ºä½•å€¼ï¼Œéƒ½ä¸èƒ½å †å 

**åŸå› ï¼š**
```
å¸¦å®¹å™¨çš„ç‰©å“ï¼ˆå¦‚ï¼šèƒŒåŒ…ã€ç®±å­ï¼‰æ¯ä¸ªéƒ½æœ‰ç‹¬ç«‹çš„å†…éƒ¨å­˜å‚¨ç©ºé—´ã€‚
å¦‚æœå…è®¸å †å ï¼Œä¼šå¯¼è‡´ï¼š
1. å®¹å™¨UIDå†²çªï¼ˆå¤šä¸ªç‰©å“å¼•ç”¨åŒä¸€ä¸ªå®¹å™¨ï¼‰
2. æ•°æ®ä¸ä¸€è‡´ï¼ˆæ— æ³•ç¡®å®šå“ªä¸ªå®¹å™¨æ˜¯æœ‰æ•ˆçš„ï¼‰
3. åµŒå¥—å®¹å™¨æ•°æ®ä¸¢å¤±é£é™©
```

**ä»£ç ä½ç½®ï¼š**

**1. å®šä¹‰çº§åˆ«æ£€æŸ¥ï¼ˆ`GaiaInventoryTypes.h`ï¼‰ï¼š**
```cpp
// FGaiaItemDefinition::IsStackable()
bool IsStackable() const
{
    if (!bStackable) return false;
    
    // å¦‚æœç‰©å“å®šä¹‰å£°æ˜äº†å®¹å™¨åŠŸèƒ½ï¼Œå¼ºåˆ¶ä¸å¯å †å 
    if (bHasContainer) return false;
    
    return true;
}
```

**2. å®ä¾‹çº§åˆ«æ£€æŸ¥ï¼ˆ`GaiaInventorySubsystem.cpp`ï¼‰ï¼š**
```cpp
// TryStackItems() - è¿è¡Œæ—¶æ£€æŸ¥
if (!ItemDef.IsStackable())
{
    // å®šä¹‰ä¸å…è®¸å †å 
    return Result;
}

if (SourceItem.HasContainer() || TargetItem.HasContainer())
{
    // å®ä¾‹åŒ…å«å®¹å™¨ï¼Œä¸å¯å †å 
    Result.ErrorMessage = TEXT("å¸¦å®¹å™¨çš„ç‰©å“å®ä¾‹ä¸å¯å †å ");
    return Result;
}
```

---

### 2ï¸âƒ£ **ç‰©å“å®šä¹‰è§„åˆ™**

#### âœ… å¯å †å ç‰©å“ï¼ˆ`bStackable = true`ï¼‰

**æ¡ä»¶ï¼š**
- ç‰©å“å®šä¹‰ä¸­ `bStackable = true`
- ç‰©å“**ä¸åŒ…å«å®¹å™¨**
- ç›¸åŒ `ItemDefinitionID`

**å †å é™åˆ¶ï¼š**
- æœ€å¤§å †å æ•°é‡ï¼š`MaxStackSize`ï¼ˆå¦‚ï¼šæœ¨æ 99ï¼Œé‡‘å¸ 9999ï¼‰

**ç¤ºä¾‹ï¼š**
```cpp
// æ•°æ®è¡¨é…ç½®
FGaiaItemDefinition WoodDef;
WoodDef.ItemDefinitionID = "Wood";
WoodDef.bStackable = true;      // âœ… å¯å †å 
WoodDef.MaxStackSize = 99;      // æœ€å¤šå †å  99 ä¸ª
WoodDef.bIsContainer = false;   // âŒ ä¸æ˜¯å®¹å™¨ç‰©å“

// ç»“æœï¼šæœ¨æå¯ä»¥å †å ï¼Œæœ€å¤š 99 ä¸ª
```

---

#### âŒ ä¸å¯å †å ç‰©å“ï¼ˆ`bStackable = false`ï¼‰

**æ¡ä»¶ï¼š**
- ç‰©å“å®šä¹‰ä¸­ `bStackable = false`

**æ•ˆæœï¼š**
- æ¯ä¸ªç‰©å“ç‹¬ç«‹å ç”¨ä¸€ä¸ªæ§½ä½
- æ— æ³•ä¸å…¶ä»–ç›¸åŒç±»å‹çš„ç‰©å“åˆå¹¶

**ç¤ºä¾‹ï¼š**
```cpp
// æ•°æ®è¡¨é…ç½®
FGaiaItemDefinition SwordDef;
SwordDef.ItemDefinitionID = "IronSword";
SwordDef.bStackable = false;    // âŒ ä¸å¯å †å 
SwordDef.MaxStackSize = 1;      // æ— æ„ä¹‰ï¼ˆä¸å¯å †å ï¼‰
SwordDef.bIsContainer = false;  // å¯èƒ½æœ‰è€ä¹…åº¦ç­‰å±æ€§

// ç»“æœï¼šæ¯æŠŠå‰‘å•ç‹¬å ç”¨ä¸€ä¸ªæ§½ä½
```

---

### 3ï¸âƒ£ **å®¹å™¨ç‰©å“ç‰¹æ®Šè§„åˆ™**

#### ğŸ“¦ ç‰©å“å®šä¹‰ä¸ºå®¹å™¨ç±»å‹

**é…ç½®æ–¹å¼ 1ï¼šæ•°æ®è¡¨**
```cpp
FGaiaItemDefinition BackpackDef;
BackpackDef.ItemDefinitionID = "LeatherBackpack";
BackpackDef.bIsContainer = true;         // âœ… æ˜¯å®¹å™¨ç‰©å“
BackpackDef.ContainerDefinition = "SmallBag";  // å®¹å™¨å®šä¹‰ID
BackpackDef.bStackable = false;          // é€šå¸¸è®¾ä¸º false
```

**é…ç½®æ–¹å¼ 2ï¼šåˆ›å»ºæ—¶å…³è”å®¹å™¨**
```cpp
// åˆ›å»ºç‰©å“å®ä¾‹
FGaiaItemInstance BackpackItem = InventorySystem->CreateItemInstance("LeatherBackpack", 1);

// åˆ›å»ºå®¹å™¨å¹¶å…³è”
FGuid ContainerUID = InventorySystem->CreateContainerForPlayer("SmallBag", PlayerController);
BackpackItem.AttachedContainerUID = ContainerUID;
```

**æ•ˆæœï¼š**
- `HasContainer() == true` â†’ **å¼ºåˆ¶ä¸å¯å †å **
- å³ä½¿ `bStackable = true`ï¼Œä¹Ÿä¼šè¢«å †å è§„åˆ™æ‹’ç»

---

## ğŸ”„ å †å æµç¨‹ç¤ºä¾‹

### âœ… æˆåŠŸæ¡ˆä¾‹ï¼šå †å æœ¨æ

```
åˆå§‹çŠ¶æ€ï¼š
- æ§½ä½1: æœ¨æ x50
- æ§½ä½2: æœ¨æ x30

æ‹–åŠ¨æ§½ä½2åˆ°æ§½ä½1ï¼š
1. æ£€æŸ¥ç±»å‹ â†’ ç›¸åŒ âœ…
2. æ£€æŸ¥å®¹å™¨ â†’ éƒ½æ²¡æœ‰å®¹å™¨ âœ…
3. æ£€æŸ¥å®šä¹‰ â†’ bStackable = true âœ…
4. è®¡ç®—ç©ºé—´ â†’ 99 - 50 = 49 âœ…
5. æ‰§è¡Œå †å  â†’ æ§½ä½1: æœ¨æ x80, æ§½ä½2: ç©º

ç»“æœï¼šæˆåŠŸå †å 
```

---

### âŒ å¤±è´¥æ¡ˆä¾‹1ï¼šå †å èƒŒåŒ…

```
åˆå§‹çŠ¶æ€ï¼š
- æ§½ä½1: èƒŒåŒ…Aï¼ˆå†…å«å®¹å™¨UID-123ï¼‰
- æ§½ä½2: èƒŒåŒ…Bï¼ˆå†…å«å®¹å™¨UID-456ï¼‰

æ‹–åŠ¨æ§½ä½2åˆ°æ§½ä½1ï¼š
1. æ£€æŸ¥ç±»å‹ â†’ ç›¸åŒ âœ…
2. æ£€æŸ¥å®¹å™¨ â†’ æºHasContainer=true âŒ

ç»“æœï¼šæ‹’ç»å †å 
é”™è¯¯ä¿¡æ¯ï¼š"å¸¦å®¹å™¨çš„ç‰©å“ä¸å¯å †å "
```

---

### âŒ å¤±è´¥æ¡ˆä¾‹2ï¼šå †å é“å‰‘

```
åˆå§‹çŠ¶æ€ï¼š
- æ§½ä½1: é“å‰‘ï¼ˆè€ä¹…åº¦100%ï¼‰
- æ§½ä½2: é“å‰‘ï¼ˆè€ä¹…åº¦50%ï¼‰

æ‹–åŠ¨æ§½ä½2åˆ°æ§½ä½1ï¼š
1. æ£€æŸ¥ç±»å‹ â†’ ç›¸åŒ âœ…
2. æ£€æŸ¥å®¹å™¨ â†’ éƒ½æ²¡æœ‰å®¹å™¨ âœ…
3. æ£€æŸ¥å®šä¹‰ â†’ bStackable = false âŒ

ç»“æœï¼šæ‹’ç»å †å 
é”™è¯¯ä¿¡æ¯ï¼š"ç‰©å“ä¸å¯å †å "
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•ç”¨ä¾‹1ï¼šéªŒè¯å®¹å™¨ç‰©å“ä¸å¯å †å 

```cpp
// åˆ›å»ºä¸¤ä¸ªç›¸åŒçš„èƒŒåŒ…ç‰©å“
FGaiaItemInstance Backpack1 = CreateItemInstance("LeatherBackpack", 1);
FGaiaItemInstance Backpack2 = CreateItemInstance("LeatherBackpack", 1);

// ä¸ºä¸¤ä¸ªèƒŒåŒ…åˆ†åˆ«åˆ›å»ºå®¹å™¨
Backpack1.AttachedContainerUID = CreateContainer("SmallBag");
Backpack2.AttachedContainerUID = CreateContainer("SmallBag");

// æ·»åŠ åˆ°åŒä¸€ä¸ªå®¹å™¨
AddItemToContainer(Backpack1, TestContainer, 0);
AddItemToContainer(Backpack2, TestContainer, 1);

// å°è¯•å †å 
FMoveItemResult Result = TryStackItems(Backpack2.InstanceUID, Backpack1.InstanceUID, 1);

// æœŸæœ›ç»“æœï¼š
// Result.Result == EMoveItemResult::StackLimitReached
// Result.ErrorMessage == "å¸¦å®¹å™¨çš„ç‰©å“ä¸å¯å †å "
```

---

### æµ‹è¯•ç”¨ä¾‹2ï¼šéªŒè¯å¯å †å ç‰©å“æ­£å¸¸å·¥ä½œ

```cpp
// åˆ›å»ºä¸¤ç»„æœ¨æ
FGaiaItemInstance Wood1 = CreateItemInstance("Wood", 50);
FGaiaItemInstance Wood2 = CreateItemInstance("Wood", 30);

// æ·»åŠ åˆ°åŒä¸€ä¸ªå®¹å™¨
AddItemToContainer(Wood1, TestContainer, 0);
AddItemToContainer(Wood2, TestContainer, 1);

// å°è¯•å †å 
FMoveItemResult Result = TryStackItems(Wood2.InstanceUID, Wood1.InstanceUID, 30);

// æœŸæœ›ç»“æœï¼š
// Result.IsSuccess() == true
// æ§½ä½0: æœ¨æ x80
// æ§½ä½1: ç©º
```

---

## ğŸ“Š é”™è¯¯ç å‚è€ƒ

| é”™è¯¯ç  | å«ä¹‰ | å¸¸è§åŸå›  |
|--------|------|----------|
| `EMoveItemResult::StackLimitReached` | å †å é™åˆ¶ | 1. ç‰©å“åŒ…å«å®¹å™¨<br>2. bStackable = false<br>3. ç›®æ ‡å †å å·²æ»¡ |
| `EMoveItemResult::TypeMismatch` | ç±»å‹ä¸åŒ¹é… | å°è¯•å †å ä¸åŒç±»å‹çš„ç‰©å“ |
| `EMoveItemResult::InvalidTarget` | æ— æ•ˆç›®æ ‡ | æºç‰©å“æˆ–ç›®æ ‡ç‰©å“ä¸å­˜åœ¨ |

---

## âœ… æœ€ä½³å®è·µ

1. **å®¹å™¨ç‰©å“å®šä¹‰**
   ```cpp
   // âœ… æ¨èï¼šå£°æ˜ bHasContainerï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†
   BackpackDef.bHasContainer = true;
   BackpackDef.ContainerDefinitionID = "SmallBag";
   BackpackDef.bStackable = false;  // å¯é€‰ï¼šæ˜¾å¼è®¾ç½®æ›´æ¸…æ™°ï¼ˆä½† IsStackable() ä¼šè‡ªåŠ¨è¿”å› falseï¼‰
   
   // âš ï¸ æ³¨æ„ï¼šå³ä½¿ä½ è®¾ç½® bStackable = trueï¼ŒIsStackable() ä»ä¼šè¿”å› false
   ```

2. **åˆ›å»ºå®¹å™¨ç‰©å“**
   ```cpp
   // âœ… ä½¿ç”¨ CreateContainerForPlayer è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰è€…
   FGuid ContainerUID = InventorySystem->CreateContainerForPlayer(
       TEXT("SmallBag"), 
       PlayerController
   );
   ```

3. **æ•°æ®è¡¨é…ç½®**
   - å®¹å™¨ç‰©å“ï¼š`bIsContainer=true, bStackable=false`
   - å¯å †å æ¶ˆè€—å“ï¼š`bStackable=true, MaxStackSize=99`
   - ç‹¬ç‰¹è£…å¤‡ï¼š`bStackable=false, MaxStackSize=1`

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æ£€æŸ¥ç‰©å“æ˜¯å¦å¯å †å 

```cpp
// 1. æ£€æŸ¥ç‰©å“æ˜¯å¦åŒ…å«å®¹å™¨
bool bHasContainer = Item.HasContainer();
UE_LOG(LogTemp, Log, TEXT("ç‰©å“åŒ…å«å®¹å™¨: %s"), bHasContainer ? TEXT("æ˜¯") : TEXT("å¦"));

// 2. æ£€æŸ¥ç‰©å“å®šä¹‰
FGaiaItemDefinition ItemDef;
if (GetItemDefinition(Item.ItemDefinitionID, ItemDef))
{
    UE_LOG(LogTemp, Log, TEXT("bStackable: %s, MaxStackSize: %d"),
        ItemDef.bStackable ? TEXT("true") : TEXT("false"),
        ItemDef.MaxStackSize);
}

// 3. å°è¯•å †å å¹¶æŸ¥çœ‹æ—¥å¿—
FMoveItemResult Result = TryStackItems(SourceUID, TargetUID, 1);
// æ£€æŸ¥ Result.ErrorMessage è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
```

---

## ğŸ”’ åˆ›å»ºç‰©å“æ—¶çš„æ•°é‡é™åˆ¶

### é—®é¢˜ï¼šå°è¯•åˆ›å»ºå¤šä¸ªå¸¦å®¹å™¨çš„ç‰©å“

```cpp
// å°è¯•åˆ›å»º10ä¸ªèƒŒåŒ…
FGaiaItemInstance Backpack = CreateItemInstance("LeatherBackpack", 10);
```

### ç³»ç»Ÿè¡Œä¸ºï¼ˆå·²ä¿®å¤ï¼‰

**ä¿®å¤å‰çš„é—®é¢˜ï¼š**
```
âŒ å¦‚æœ bStackable=true, bHasContainer=trueï¼ˆé…ç½®é”™è¯¯ï¼‰
   â†’ Quantity = 10
   â†’ OwnedContainerUID = æœ‰æ•ˆï¼ˆä½†åªåˆ›å»º1ä¸ªå®¹å™¨ï¼‰
   â†’ ç»“æœï¼š10ä¸ªèƒŒåŒ…å…±äº«1ä¸ªå®¹å™¨UIDï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰
```

**ä¿®å¤åçš„è¡Œä¸ºï¼š**
```cpp
// CreateItemInstance() ä½¿ç”¨ IsStackable() æ£€æŸ¥
if (ItemDef.IsStackable())  // æ£€æŸ¥å®šä¹‰çº§åˆ«çš„å †å è§„åˆ™
{
    NewItem.Quantity = FMath::Clamp(Quantity, 1, ItemDef.MaxStackSize);
}
else
{
    NewItem.Quantity = 1;  // å¼ºåˆ¶ä¸º1
    
    if (Quantity > 1)
    {
        UE_LOG(Warning, TEXT("åˆ›å»ºç‰©å“: LeatherBackpack ä¸å¯å †å ï¼ˆå¸¦å®¹å™¨ï¼‰ï¼Œæ•°é‡ä» 10 è°ƒæ•´ä¸º 1"));
    }
}
```

**å®é™…ç»“æœï¼š**
```
âœ… Quantity = 1ï¼ˆå¼ºåˆ¶è°ƒæ•´ï¼‰
âœ… OwnedContainerUID = æœ‰æ•ˆï¼ˆåˆ›å»º1ä¸ªå®¹å™¨ï¼‰
âœ… æ—¥å¿—è­¦å‘Šï¼šé€šçŸ¥å¼€å‘è€…æ•°é‡å·²è°ƒæ•´
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-10-28**: ä¿®å¤ `CreateItemInstance` ä½¿ç”¨ `IsStackable()` æ£€æŸ¥
- **2025-10-28**: æ·»åŠ "å¸¦å®¹å™¨ç‰©å“å¼ºåˆ¶ä¸å¯å †å "è§„åˆ™
- **2025-10-28**: åˆ›å»ºæœ¬æ–‡æ¡£

---

## ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿè®¾è®¡è¯´æ˜.md](ç³»ç»Ÿè®¾è®¡è¯´æ˜.md) - äº†è§£æ•´ä½“æ¶æ„
- [æ‰§è¡Œæµç¨‹è¯´æ˜.md](æ‰§è¡Œæµç¨‹è¯´æ˜.md) - äº†è§£ç‰©å“ç§»åŠ¨æµç¨‹
- [GaiaInventoryTypes.h](GaiaInventoryTypes.h) - æŸ¥çœ‹æ•°æ®ç»“æ„å®šä¹‰

