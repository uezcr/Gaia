# 物品堆叠规则说明

## 📋 堆叠规则总览

物品堆叠遵循以下规则（按优先级排序）：

### 1️⃣ **强制规则（最高优先级）**

#### ❌ 带容器的物品不可堆叠

**规则说明：**
- 如果物品**定义**声明了容器功能（`bHasContainer == true`），则**定义级别**强制不可堆叠
- 如果物品**实例**包含容器（`HasContainer() == true`），则**实例级别**强制不可堆叠
- 无论物品定义中的 `bStackable` 设置为何值，都不能堆叠

**原因：**
```
带容器的物品（如：背包、箱子）每个都有独立的内部存储空间。
如果允许堆叠，会导致：
1. 容器UID冲突（多个物品引用同一个容器）
2. 数据不一致（无法确定哪个容器是有效的）
3. 嵌套容器数据丢失风险
```

**代码位置：**

**1. 定义级别检查（`GaiaInventoryTypes.h`）：**
```cpp
// FGaiaItemDefinition::IsStackable()
bool IsStackable() const
{
    if (!bStackable) return false;
    
    // 如果物品定义声明了容器功能，强制不可堆叠
    if (bHasContainer) return false;
    
    return true;
}
```

**2. 实例级别检查（`GaiaInventorySubsystem.cpp`）：**
```cpp
// TryStackItems() - 运行时检查
if (!ItemDef.IsStackable())
{
    // 定义不允许堆叠
    return Result;
}

if (SourceItem.HasContainer() || TargetItem.HasContainer())
{
    // 实例包含容器，不可堆叠
    Result.ErrorMessage = TEXT("带容器的物品实例不可堆叠");
    return Result;
}
```

---

### 2️⃣ **物品定义规则**

#### ✅ 可堆叠物品（`bStackable = true`）

**条件：**
- 物品定义中 `bStackable = true`
- 物品**不包含容器**
- 相同 `ItemDefinitionID`

**堆叠限制：**
- 最大堆叠数量：`MaxStackSize`（如：木材 99，金币 9999）

**示例：**
```cpp
// 数据表配置
FGaiaItemDefinition WoodDef;
WoodDef.ItemDefinitionID = "Wood";
WoodDef.bStackable = true;      // ✅ 可堆叠
WoodDef.MaxStackSize = 99;      // 最多堆叠 99 个
WoodDef.bIsContainer = false;   // ❌ 不是容器物品

// 结果：木材可以堆叠，最多 99 个
```

---

#### ❌ 不可堆叠物品（`bStackable = false`）

**条件：**
- 物品定义中 `bStackable = false`

**效果：**
- 每个物品独立占用一个槽位
- 无法与其他相同类型的物品合并

**示例：**
```cpp
// 数据表配置
FGaiaItemDefinition SwordDef;
SwordDef.ItemDefinitionID = "IronSword";
SwordDef.bStackable = false;    // ❌ 不可堆叠
SwordDef.MaxStackSize = 1;      // 无意义（不可堆叠）
SwordDef.bIsContainer = false;  // 可能有耐久度等属性

// 结果：每把剑单独占用一个槽位
```

---

### 3️⃣ **容器物品特殊规则**

#### 📦 物品定义为容器类型

**配置方式 1：数据表**
```cpp
FGaiaItemDefinition BackpackDef;
BackpackDef.ItemDefinitionID = "LeatherBackpack";
BackpackDef.bIsContainer = true;         // ✅ 是容器物品
BackpackDef.ContainerDefinition = "SmallBag";  // 容器定义ID
BackpackDef.bStackable = false;          // 通常设为 false
```

**配置方式 2：创建时关联容器**
```cpp
// 创建物品实例
FGaiaItemInstance BackpackItem = InventorySystem->CreateItemInstance("LeatherBackpack", 1);

// 创建容器并关联
FGuid ContainerUID = InventorySystem->CreateContainerForPlayer("SmallBag", PlayerController);
BackpackItem.AttachedContainerUID = ContainerUID;
```

**效果：**
- `HasContainer() == true` → **强制不可堆叠**
- 即使 `bStackable = true`，也会被堆叠规则拒绝

---

## 🔄 堆叠流程示例

### ✅ 成功案例：堆叠木材

```
初始状态：
- 槽位1: 木材 x50
- 槽位2: 木材 x30

拖动槽位2到槽位1：
1. 检查类型 → 相同 ✅
2. 检查容器 → 都没有容器 ✅
3. 检查定义 → bStackable = true ✅
4. 计算空间 → 99 - 50 = 49 ✅
5. 执行堆叠 → 槽位1: 木材 x80, 槽位2: 空

结果：成功堆叠
```

---

### ❌ 失败案例1：堆叠背包

```
初始状态：
- 槽位1: 背包A（内含容器UID-123）
- 槽位2: 背包B（内含容器UID-456）

拖动槽位2到槽位1：
1. 检查类型 → 相同 ✅
2. 检查容器 → 源HasContainer=true ❌

结果：拒绝堆叠
错误信息："带容器的物品不可堆叠"
```

---

### ❌ 失败案例2：堆叠铁剑

```
初始状态：
- 槽位1: 铁剑（耐久度100%）
- 槽位2: 铁剑（耐久度50%）

拖动槽位2到槽位1：
1. 检查类型 → 相同 ✅
2. 检查容器 → 都没有容器 ✅
3. 检查定义 → bStackable = false ❌

结果：拒绝堆叠
错误信息："物品不可堆叠"
```

---

## 🧪 测试建议

### 测试用例1：验证容器物品不可堆叠

```cpp
// 创建两个相同的背包物品
FGaiaItemInstance Backpack1 = CreateItemInstance("LeatherBackpack", 1);
FGaiaItemInstance Backpack2 = CreateItemInstance("LeatherBackpack", 1);

// 为两个背包分别创建容器
Backpack1.AttachedContainerUID = CreateContainer("SmallBag");
Backpack2.AttachedContainerUID = CreateContainer("SmallBag");

// 添加到同一个容器
AddItemToContainer(Backpack1, TestContainer, 0);
AddItemToContainer(Backpack2, TestContainer, 1);

// 尝试堆叠
FMoveItemResult Result = TryStackItems(Backpack2.InstanceUID, Backpack1.InstanceUID, 1);

// 期望结果：
// Result.Result == EMoveItemResult::StackLimitReached
// Result.ErrorMessage == "带容器的物品不可堆叠"
```

---

### 测试用例2：验证可堆叠物品正常工作

```cpp
// 创建两组木材
FGaiaItemInstance Wood1 = CreateItemInstance("Wood", 50);
FGaiaItemInstance Wood2 = CreateItemInstance("Wood", 30);

// 添加到同一个容器
AddItemToContainer(Wood1, TestContainer, 0);
AddItemToContainer(Wood2, TestContainer, 1);

// 尝试堆叠
FMoveItemResult Result = TryStackItems(Wood2.InstanceUID, Wood1.InstanceUID, 30);

// 期望结果：
// Result.IsSuccess() == true
// 槽位0: 木材 x80
// 槽位1: 空
```

---

## 📊 错误码参考

| 错误码 | 含义 | 常见原因 |
|--------|------|----------|
| `EMoveItemResult::StackLimitReached` | 堆叠限制 | 1. 物品包含容器<br>2. bStackable = false<br>3. 目标堆叠已满 |
| `EMoveItemResult::TypeMismatch` | 类型不匹配 | 尝试堆叠不同类型的物品 |
| `EMoveItemResult::InvalidTarget` | 无效目标 | 源物品或目标物品不存在 |

---

## ✅ 最佳实践

1. **容器物品定义**
   ```cpp
   // ✅ 推荐：声明 bHasContainer，系统会自动处理
   BackpackDef.bHasContainer = true;
   BackpackDef.ContainerDefinitionID = "SmallBag";
   BackpackDef.bStackable = false;  // 可选：显式设置更清晰（但 IsStackable() 会自动返回 false）
   
   // ⚠️ 注意：即使你设置 bStackable = true，IsStackable() 仍会返回 false
   ```

2. **创建容器物品**
   ```cpp
   // ✅ 使用 CreateContainerForPlayer 自动注册所有者
   FGuid ContainerUID = InventorySystem->CreateContainerForPlayer(
       TEXT("SmallBag"), 
       PlayerController
   );
   ```

3. **数据表配置**
   - 容器物品：`bIsContainer=true, bStackable=false`
   - 可堆叠消耗品：`bStackable=true, MaxStackSize=99`
   - 独特装备：`bStackable=false, MaxStackSize=1`

---

## 🔍 调试技巧

### 检查物品是否可堆叠

```cpp
// 1. 检查物品是否包含容器
bool bHasContainer = Item.HasContainer();
UE_LOG(LogTemp, Log, TEXT("物品包含容器: %s"), bHasContainer ? TEXT("是") : TEXT("否"));

// 2. 检查物品定义
FGaiaItemDefinition ItemDef;
if (GetItemDefinition(Item.ItemDefinitionID, ItemDef))
{
    UE_LOG(LogTemp, Log, TEXT("bStackable: %s, MaxStackSize: %d"),
        ItemDef.bStackable ? TEXT("true") : TEXT("false"),
        ItemDef.MaxStackSize);
}

// 3. 尝试堆叠并查看日志
FMoveItemResult Result = TryStackItems(SourceUID, TargetUID, 1);
// 检查 Result.ErrorMessage 获取详细错误信息
```

---

## 🔒 创建物品时的数量限制

### 问题：尝试创建多个带容器的物品

```cpp
// 尝试创建10个背包
FGaiaItemInstance Backpack = CreateItemInstance("LeatherBackpack", 10);
```

### 系统行为（已修复）

**修复前的问题：**
```
❌ 如果 bStackable=true, bHasContainer=true（配置错误）
   → Quantity = 10
   → OwnedContainerUID = 有效（但只创建1个容器）
   → 结果：10个背包共享1个容器UID（数据不一致）
```

**修复后的行为：**
```cpp
// CreateItemInstance() 使用 IsStackable() 检查
if (ItemDef.IsStackable())  // 检查定义级别的堆叠规则
{
    NewItem.Quantity = FMath::Clamp(Quantity, 1, ItemDef.MaxStackSize);
}
else
{
    NewItem.Quantity = 1;  // 强制为1
    
    if (Quantity > 1)
    {
        UE_LOG(Warning, TEXT("创建物品: LeatherBackpack 不可堆叠（带容器），数量从 10 调整为 1"));
    }
}
```

**实际结果：**
```
✅ Quantity = 1（强制调整）
✅ OwnedContainerUID = 有效（创建1个容器）
✅ 日志警告：通知开发者数量已调整
```

---

## 📝 更新日志

- **2025-10-28**: 修复 `CreateItemInstance` 使用 `IsStackable()` 检查
- **2025-10-28**: 添加"带容器物品强制不可堆叠"规则
- **2025-10-28**: 创建本文档

---

## 相关文档

- [系统设计说明.md](系统设计说明.md) - 了解整体架构
- [执行流程说明.md](执行流程说明.md) - 了解物品移动流程
- [GaiaInventoryTypes.h](GaiaInventoryTypes.h) - 查看数据结构定义

