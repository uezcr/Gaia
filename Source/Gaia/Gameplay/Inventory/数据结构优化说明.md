# æ•°æ®ç»“æ„ä¼˜åŒ–è¯´æ˜ - å®¹å™¨æ‰€æœ‰è€…æ˜ å°„

## ğŸ› **é—®é¢˜**

åŸå§‹è®¾è®¡ä½¿ç”¨äº†ï¼š
```cpp
TMap<TObjectPtr<APlayerController>, TArray<FGuid>> ContainerOwners;
```

**ç¼–è¯‘é”™è¯¯**ï¼š
```
Error: The type 'TArray<FGuid>' can not be used as a value in a TMap
```

---

## ğŸ”§ **åŸå› **

`TArray<FGuid>` ä¸èƒ½ç›´æ¥ä½œä¸º `TMap` çš„å€¼ç±»å‹ï¼Œå› ä¸ºï¼š
1. UE çš„ `TMap` è¦æ±‚å€¼ç±»å‹æœ‰ç‰¹å®šçš„å†…å­˜å¸ƒå±€
2. `TArray` ä½œä¸ºåŠ¨æ€æ•°ç»„ï¼Œä¸èƒ½ç›´æ¥å­˜å‚¨åœ¨ `TMap` ä¸­
3. ç¼ºå°‘å¿…è¦çš„æ¯”è¾ƒå’Œå“ˆå¸Œå‡½æ•°

---

## âœ… **è§£å†³æ–¹æ¡ˆ**

### æ”¹å˜æ˜ å°„æ–¹å‘

**ä»**ï¼š`ç©å®¶ â†’ å®¹å™¨åˆ—è¡¨`  
**æ”¹ä¸º**ï¼š`å®¹å™¨ â†’ æ‰€æœ‰è€…`

```cpp
// âŒ åŸå§‹è®¾è®¡ï¼ˆé”™è¯¯ï¼‰
TMap<TObjectPtr<APlayerController>, TArray<FGuid>> ContainerOwners;

// âœ… æ–°è®¾è®¡ï¼ˆæ­£ç¡®ï¼‰
TMap<FGuid, TObjectPtr<APlayerController>> ContainerOwnerMap;
```

---

## ğŸ“Š **è®¾è®¡å¯¹æ¯”**

### åŸå§‹è®¾è®¡ï¼ˆç†è®ºï¼‰

```
PlayerA â†’ [BackpackUID, EquipmentUID, ...]
PlayerB â†’ [BackpackUID, EquipmentUID, ...]
```

**ä¼˜ç‚¹**ï¼š
- å¯ä»¥å¿«é€Ÿæ‰¾åˆ°ç©å®¶çš„æ‰€æœ‰å®¹å™¨

**ç¼ºç‚¹**ï¼š
- âŒ ç¼–è¯‘é”™è¯¯
- âŒ æŸ¥æ‰¾å®¹å™¨æ‰€æœ‰è€…éœ€è¦éå†æ‰€æœ‰ç©å®¶

### æ–°è®¾è®¡ï¼ˆå®é™…ï¼‰

```
BackpackUID_A â†’ PlayerA
EquipmentUID_A â†’ PlayerA
BackpackUID_B â†’ PlayerB
EquipmentUID_B â†’ PlayerB
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç¼–è¯‘é€šè¿‡
- âœ… O(1) æŸ¥æ‰¾å®¹å™¨æ‰€æœ‰è€…
- âœ… æ¯ä¸ªå®¹å™¨åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…ï¼ˆç¬¦åˆå®é™…ï¼‰

**ç¼ºç‚¹**ï¼š
- æŸ¥æ‰¾ç©å®¶çš„æ‰€æœ‰å®¹å™¨éœ€è¦éå†æ˜ å°„ï¼ˆä½†è¿™ç§éœ€æ±‚è¾ƒå°‘ï¼‰

---

## ğŸ”„ **ä¿®æ”¹å†…å®¹**

### 1. æ•°æ®ç»“æ„å®šä¹‰

```cpp
// GaiaInventorySubsystem.h

// ä¿®æ”¹å‰
TMap<TObjectPtr<APlayerController>, TArray<FGuid>> ContainerOwners;

// ä¿®æ”¹å
TMap<FGuid, TObjectPtr<APlayerController>> ContainerOwnerMap;
```

### 2. æ³¨å†Œå‡½æ•°

```cpp
// ä¿®æ”¹å‰
void RegisterContainerOwner(APlayerController* PC, const FGuid& ContainerUID)
{
    TArray<FGuid>& OwnedContainers = ContainerOwners.FindOrAdd(PC);
    OwnedContainers.Add(ContainerUID);
}

// ä¿®æ”¹å
void RegisterContainerOwner(APlayerController* PC, const FGuid& ContainerUID)
{
    ContainerOwnerMap.Add(ContainerUID, PC);
}
```

### 3. æŸ¥è¯¢å‡½æ•°

```cpp
// ä¿®æ”¹å‰
TArray<APlayerController*> GetContainerOwners(const FGuid& ContainerUID) const
{
    TArray<APlayerController*> Owners;
    for (const auto& Pair : ContainerOwners)
    {
        if (Pair.Value.Contains(ContainerUID))
        {
            Owners.Add(Pair.Key);
        }
    }
    return Owners;
}

// ä¿®æ”¹å
TArray<APlayerController*> GetContainerOwners(const FGuid& ContainerUID) const
{
    TArray<APlayerController*> Owners;
    if (const TObjectPtr<APlayerController>* Owner = ContainerOwnerMap.Find(ContainerUID))
    {
        if (*Owner)
        {
            Owners.Add(*Owner);
        }
    }
    return Owners;
}
```

### 4. æ³¨é”€å‡½æ•°

```cpp
// ä¿®æ”¹å‰
void UnregisterContainerOwner(APlayerController* PC, const FGuid& ContainerUID)
{
    if (TArray<FGuid>* OwnedContainers = ContainerOwners.Find(PC))
    {
        OwnedContainers->Remove(ContainerUID);
    }
}

// ä¿®æ”¹å
void UnregisterContainerOwner(APlayerController* PC, const FGuid& ContainerUID)
{
    if (const TObjectPtr<APlayerController>* CurrentOwner = ContainerOwnerMap.Find(ContainerUID))
    {
        if (*CurrentOwner == PC)
        {
            ContainerOwnerMap.Remove(ContainerUID);
        }
    }
}
```

---

## ğŸ’¡ **å®é™…å½±å“**

### å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“

**æ— å½±å“ï¼** å› ä¸ºï¼š

1. **å®¹å™¨æ‰€æœ‰æƒæ˜¯ä¸€å¯¹ä¸€çš„**
   - ä¸€ä¸ªèƒŒåŒ…åªå±äºä¸€ä¸ªç©å®¶
   - ä¸€ä¸ªè£…å¤‡æ åªå±äºä¸€ä¸ªç©å®¶
   - ç¬¦åˆå®é™…æ¸¸æˆé€»è¾‘

2. **API ä¿æŒä¸å˜**
   - `RegisterContainerOwner(PC, ContainerUID)` - åŠŸèƒ½ç›¸åŒ
   - `GetContainerOwners(ContainerUID)` - è¿”å›å€¼ç›¸åŒ
   - `UnregisterContainerOwner(PC, ContainerUID)` - åŠŸèƒ½ç›¸åŒ

3. **æ€§èƒ½æ›´å¥½**
   ```cpp
   // ä¿®æ”¹å‰ï¼šO(N) - éœ€è¦éå†æ‰€æœ‰ç©å®¶
   for (Player : AllPlayers)
   {
       if (Player.Containers.Contains(ContainerUID))
           return Player;
   }
   
   // ä¿®æ”¹åï¼šO(1) - ç›´æ¥æŸ¥æ‰¾
   return ContainerOwnerMap.Find(ContainerUID);
   ```

---

## ğŸ® **ä½¿ç”¨ç¤ºä¾‹**

### ç©å®¶ç™»å½•æ—¶æ³¨å†ŒèƒŒåŒ…

```cpp
void AYourPlayerController::BeginPlay()
{
    if (HasAuthority())
    {
        UGaiaInventorySubsystem* InventorySystem = GetWorld()->GetSubsystem<UGaiaInventorySubsystem>();
        
        // åˆ›å»ºèƒŒåŒ…
        FGuid BackpackUID = InventorySystem->CreateContainer(TEXT("PlayerBackpack"));
        
        // âœ… æ³¨å†Œæ‰€æœ‰è€…ï¼ˆæ–°è®¾è®¡ï¼ŒåŠŸèƒ½ä¸å˜ï¼‰
        InventorySystem->RegisterContainerOwner(this, BackpackUID);
        
        // æœåŠ¡å™¨å†…éƒ¨ï¼šContainerOwnerMap[BackpackUID] = this
    }
}
```

### æŸ¥è¯¢å®¹å™¨æ‰€æœ‰è€…

```cpp
// æ£€æŸ¥è°æ‹¥æœ‰è¿™ä¸ªèƒŒåŒ…
TArray<APlayerController*> Owners = InventorySystem->GetContainerOwners(BackpackUID);

if (Owners.Num() > 0)
{
    UE_LOG(LogGaia, Log, TEXT("èƒŒåŒ…å±äº: %s"), *Owners[0]->GetName());
}

// âœ… åŠŸèƒ½å®Œå…¨ç›¸åŒï¼Œä½†æ€§èƒ½æ›´å¥½ï¼ˆO(1) vs O(N)ï¼‰
```

### å¹¿æ’­å®¹å™¨æ›´æ–°

```cpp
void BroadcastContainerUpdate(const FGuid& ContainerUID)
{
    TSet<APlayerController*> PlayersToNotify;
    
    // æ·»åŠ æ‰€æœ‰è€…
    TArray<APlayerController*> Owners = GetContainerOwners(ContainerUID);
    for (APlayerController* Owner : Owners)
    {
        PlayersToNotify.Add(Owner);
    }
    
    // âœ… åŠŸèƒ½å®Œå…¨ç›¸åŒ
}
```

---

## ğŸ“ **ä¿®æ”¹æ–‡ä»¶**

### å·²ä¿®æ”¹

1. âœ… `GaiaInventorySubsystem.h`
   - æ•°æ®ç»“æ„å®šä¹‰

2. âœ… `GaiaInventorySubsystem.cpp`
   - `GetContainerOwners` å®ç°
   - `RegisterContainerOwner` å®ç°
   - `UnregisterContainerOwner` å®ç°
   - `Deinitialize` æ¸…ç†ä»£ç 

### æ— éœ€ä¿®æ”¹

- âœ… RPC Component - API è°ƒç”¨ç›¸åŒ
- âœ… å¹¿æ’­é€»è¾‘ - åŠŸèƒ½ä¸å˜
- âœ… æ–‡æ¡£è¯´æ˜ - æ¦‚å¿µä¸å˜

---

## âœ… **æ€»ç»“**

### é—®é¢˜è§£å†³
âœ… **ç¼–è¯‘é”™è¯¯å·²ä¿®å¤**  
âœ… **åŠŸèƒ½å®Œå…¨ä¿æŒ**  
âœ… **æ€§èƒ½åè€Œæå‡**  

### è®¾è®¡ä¼˜åŠ¿
âœ… **ä¸€å¯¹ä¸€æ˜ å°„**ï¼šå®¹å™¨ â†’ æ‰€æœ‰è€…  
âœ… **O(1) æŸ¥è¯¢**ï¼šå¿«é€ŸæŸ¥æ‰¾å®¹å™¨æ‰€æœ‰è€…  
âœ… **ç¬¦åˆé€»è¾‘**ï¼šæ¯ä¸ªå®¹å™¨ç¡®å®åªæœ‰ä¸€ä¸ªæ‰€æœ‰è€…  

### å…¼å®¹æ€§
âœ… **API ä¸å˜**ï¼šæ‰€æœ‰å‡½æ•°ç­¾åä¿æŒä¸€è‡´  
âœ… **åŠŸèƒ½ä¸å˜**ï¼šä½¿ç”¨æ–¹å¼å®Œå…¨ç›¸åŒ  
âœ… **æ–‡æ¡£æœ‰æ•ˆ**ï¼šç°æœ‰æ–‡æ¡£ä»ç„¶é€‚ç”¨  

**è¿™ä¸ªä¿®æ”¹ä¸ä»…è§£å†³äº†ç¼–è¯‘é”™è¯¯ï¼Œè¿˜ä¼˜åŒ–äº†æ€§èƒ½ï¼** ğŸ‰

