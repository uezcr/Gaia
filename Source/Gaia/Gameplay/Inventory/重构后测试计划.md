# 库存系统重构后测试计划

## 概述

本文档详细说明了库存系统重构后的测试计划，包括单机测试和网络测试。

## 测试目标

1. **验证指针版本API正确性** - 所有内部函数已改为指针版本
2. **验证性能提升** - 确认TMap查找次数减少
3. **验证功能完整性** - 所有功能正常工作
4. **验证数据一致性** - 槽位引用和物品位置保持一致
5. **验证网络同步** - 多人游戏中数据正确同步

## 一、单机测试（GaiaInventoryTestActor）

### 1.1 基础功能测试

#### Test_CreateContainerAndItems
- 创建多种类型的容器
- 创建多种类型的物品
- 验证UID唯一性
- 验证数据正确性

**预期结果**：
- ✅ 所有容器和物品创建成功
- ✅ UID不重复
- ✅ 定义数据正确读取

#### Test_AddItemsToContainer
- 使用 `TryAddItemToContainer` 添加物品
- 测试添加到空槽位
- 测试添加到不同容器
- 测试添加失败情况（体积、标签限制）

**预期结果**：
- ✅ 物品成功添加到正确槽位
- ✅ 错误情况返回正确的错误信息
- ✅ 容器状态正确更新

#### Test_FindItems
- 通过UID查找物品
- 查找容器中的所有物品
- 查找游离物品

**预期结果**：
- ✅ 正确找到物品
- ✅ 返回正确的物品列表

#### Test_RemoveItems
- 从容器移除物品
- 验证物品变为游离状态
- 验证槽位引用被清空

**预期结果**：
- ✅ 物品成功移除
- ✅ 槽位引用为空
- ✅ 物品状态正确

#### Test_DestroyItems
- 删除物品
- 验证物品从系统中完全移除
- 验证嵌套容器也被删除

**预期结果**：
- ✅ 物品不再存在
- ✅ 嵌套容器被级联删除

#### Test_DataIntegrity
- 验证数据一致性
- 槽位引用 vs 物品位置
- 嵌套容器引用

**预期结果**：
- ✅ 所有数据一致
- ✅ 无悬空引用

### 1.2 物品移动测试

#### Test_MoveWithinContainer
- 测试容器内移动到空槽位
- 测试容器内移动到有物品的槽位（交换）
- 测试部分移动

**测试代码示例**：
```cpp
// 使用 TryMoveItem
FMoveItemResult Result = InvSys->TryMoveItem(ItemUID, ContainerUID, TargetSlotID, Quantity);
```

**预期结果**：
- ✅ 物品正确移动
- ✅ 部分移动创建新物品实例
- ✅ 槽位引用正确更新

#### Test_MoveToCrossContainerEmptySlot
- 测试跨容器移动到指定空槽位
- 测试源容器槽位清理
- 测试目标容器槽位更新

**预期结果**：
- ✅ 物品移动到目标容器
- ✅ 源容器槽位清空
- ✅ 目标容器槽位更新

#### Test_MoveCrossContainerAutoSlot
- 测试自动分配槽位移动
- 测试优先使用空槽位
- 测试自动堆叠
- 测试自动放入嵌套容器

**预期结果**：
- ✅ 优先使用空槽位
- ✅ 相同物品自动堆叠
- ✅ 自动放入嵌套容器

#### Test_SwapItems
- 测试同容器内物品交换
- 测试跨容器物品交换
- 测试嵌套容器物品交换

**预期结果**：
- ✅ 物品位置正确交换
- ✅ 槽位引用正确交换
- ✅ 嵌套容器父容器更新

#### Test_PartialMove
- 测试部分数量移动
- 验证源物品数量减少
- 验证新物品创建

**预期结果**：
- ✅ 源物品数量正确减少
- ✅ 新物品数量正确
- ✅ 新物品UID唯一

#### Test_QuickMove
- 测试快速移动（全部数量）
- 测试 `QuickMoveItem` 函数

**预期结果**：
- ✅ 全部数量移动
- ✅ 源物品不存在

#### Test_SplitMove
- 测试拆分移动（指定数量）
- 测试 `SplitItem` 函数

**预期结果**：
- ✅ 指定数量移动
- ✅ 源物品剩余数量正确

### 1.3 容器嵌套测试

#### Test_MoveToNestedContainer
- 测试放入物品自带的容器
- 使用旧代码中的逻辑

**预期结果**：
- ✅ 物品放入嵌套容器
- ✅ 嵌套容器父容器更新

#### Test_MultiLevelNesting
- 测试多层嵌套（背包 → 箱子 → 袋子）
- 验证最多3层嵌套限制

**预期结果**：
- ✅ 支持3层嵌套
- ✅ 超过3层被拒绝

#### Test_CycleDetection
- 测试循环引用检测
- 尝试将容器放入自己的子容器

**预期结果**：
- ✅ 循环引用被检测
- ✅ 操作被拒绝

### 1.4 堆叠测试

#### Test_StackSameItems
- 测试相同物品堆叠
- 测试完全堆叠
- 测试部分堆叠

**预期结果**：
- ✅ 相同物品可堆叠
- ✅ 源物品数量减少或删除
- ✅ 目标物品数量增加

#### Test_PartialStacking
- 测试堆叠限制
- 目标物品接近堆叠上限

**预期结果**：
- ✅ 部分数量堆叠
- ✅ 剩余数量留在源物品

#### Test_StackLimit
- 测试堆叠上限
- 验证不能超过 MaxStackSize

**预期结果**：
- ✅ 堆叠不超过上限
- ✅ 超过部分返回失败

### 1.5 边界情况测试

#### Test_EmptyContainerOperations
- 对空容器的各种操作
- 从空槽位移动物品

**预期结果**：
- ✅ 返回正确的错误信息
- ✅ 不崩溃

#### Test_FullContainerOperations
- 对满容器添加物品
- 对满容器移动物品

**预期结果**：
- ✅ 返回 ContainerFull 错误
- ✅ 容器状态不变

#### Test_InvalidUIDs
- 使用无效的物品UID
- 使用无效的容器UID

**预期结果**：
- ✅ 返回 InvalidTarget 错误
- ✅ 不崩溃

#### Test_ContainerVolumeLimit
- 测试容器体积限制
- 添加超过容量的物品

**预期结果**：
- ✅ 返回体积不足错误
- ✅ 物品不被添加

#### Test_ContainerTagRestrictions
- 测试容器标签限制
- 添加不符合标签的物品

**预期结果**：
- ✅ 返回标签限制错误
- ✅ 物品不被添加

### 1.6 性能测试

#### Test_Performance_BulkCreation
- 批量创建1000个物品
- 测量创建时间

**性能目标**：
- ✅ < 100ms（1000个物品）

#### Test_Performance_BulkMovement
- 批量移动1000个物品
- 测量移动时间

**性能目标**：
- ✅ < 500ms（1000次移动）

#### Test_Performance_SearchEfficiency
- 测试TMap查找效率
- 比较指针版本 vs UID版本

**性能目标**：
- ✅ 指针版本查找次数减少50%+

## 二、网络测试（GaiaInventoryNetworkTestActor）

### 2.1 RPC组件测试

#### Test_RPCComponentInitialization
- 验证每个玩家都有RPC组件
- 验证组件正确初始化

**预期结果**：
- ✅ 服务器和客户端都有组件
- ✅ 组件状态正常

#### Test_ContainerRegistration
- 测试容器注册到RPC组件
- 测试 `AddOwnedContainerUID`

**预期结果**：
- ✅ 容器成功注册
- ✅ 客户端可以请求数据

#### Test_DataRefresh
- 测试客户端请求数据刷新
- 测试 `ServerRequestRefreshInventory`

**预期结果**：
- ✅ 客户端收到完整数据
- ✅ 嵌套容器自动包含

### 2.2 容器同步测试

#### Test_ContainerCreationSync
- 服务器创建容器
- 验证客户端收到通知

**预期结果**：
- ✅ 客户端UI更新
- ✅ 数据一致

#### Test_ItemAdditionSync
- 服务器添加物品
- 验证客户端收到更新

**预期结果**：
- ✅ 客户端显示新物品
- ✅ 数据一致

#### Test_ItemRemovalSync
- 服务器移除物品
- 验证客户端更新

**预期结果**：
- ✅ 客户端物品消失
- ✅ 数据一致

#### Test_ContainerDataConsistency
- 比较服务器和客户端数据
- 验证完全一致

**预期结果**：
- ✅ 槽位数据一致
- ✅ 物品数据一致

### 2.3 物品移动同步测试

#### Test_WithinContainerMoveSync
- 服务器容器内移动物品
- 验证客户端同步

**预期结果**：
- ✅ 客户端物品位置更新
- ✅ 动画流畅

#### Test_CrossContainerMoveSync
- 服务器跨容器移动
- 验证客户端同步

**预期结果**：
- ✅ 两个容器都同步
- ✅ 数据一致

#### Test_ItemSwapSync
- 服务器交换物品
- 验证客户端同步

**预期结果**：
- ✅ 两个物品位置都更新
- ✅ 交换流畅

#### Test_StackingSync
- 服务器堆叠物品
- 验证客户端同步

**预期结果**：
- ✅ 数量更新
- ✅ 源物品消失（如果完全堆叠）

### 2.4 嵌套容器同步测试

#### Test_NestedContainerAutoSync
- 服务器添加带容器的物品
- 验证嵌套容器自动同步

**预期结果**：
- ✅ 嵌套容器自动发送给客户端
- ✅ 递归收集所有层级

#### Test_MultiLevelNestedSync
- 测试多层嵌套同步
- 验证所有层级都同步

**预期结果**：
- ✅ 所有层级都同步
- ✅ 无遗漏

#### Test_NestedContainerMoveSync
- 移动带容器的物品
- 验证嵌套容器状态更新

**预期结果**：
- ✅ 嵌套容器父容器更新
- ✅ 客户端数据正确

### 2.5 服务器广播测试

#### Test_BroadcastItemChanges
- 服务器修改物品
- 验证所有客户端收到通知

**预期结果**：
- ✅ 所有客户端收到更新
- ✅ 广播高效

#### Test_MultiClientSync
- 多个客户端同时操作
- 验证数据一致性

**预期结果**：
- ✅ 数据保持一致
- ✅ 无冲突

## 三、测试执行计划

### 阶段1：单机基础测试
1. 运行基础功能测试
2. 修复发现的问题
3. 验证数据完整性

### 阶段2：单机移动测试
1. 运行所有移动测试
2. 验证指针版本API正确性
3. 测量性能提升

### 阶段3：单机高级测试
1. 嵌套容器测试
2. 边界情况测试
3. 性能测试

### 阶段4：网络测试
1. RPC组件测试
2. 同步测试
3. 多客户端测试

## 四、测试指标

### 功能指标
- ✅ 所有测试通过率 > 95%
- ✅ 无崩溃
- ✅ 无内存泄漏

### 性能指标
- ✅ 物品创建 < 0.1ms/个
- ✅ 物品移动 < 0.5ms/次
- ✅ TMap查找减少 50%+
- ✅ 内存使用无明显增加

### 网络指标
- ✅ 同步延迟 < 100ms
- ✅ 数据包大小 < 1KB/次
- ✅ 客户端-服务器一致性 100%

## 五、问题报告模板

发现问题时，使用以下模板：

```
## 问题标题

**测试名称**：Test_xxx
**重现步骤**：
1. ...
2. ...

**预期结果**：...
**实际结果**：...
**日志**：
```log
...
```

**严重程度**：Critical / High / Medium / Low
```

## 六、下一步行动

1. ✅ 实现单机测试Actor的所有测试函数
2. ✅ 实现网络测试Actor的所有测试函数
3. ✅ 运行测试并记录结果
4. ✅ 修复发现的问题
5. ✅ 生成测试报告

---

**文档版本**：1.0
**最后更新**：2025-10-31
**负责人**：开发团队

