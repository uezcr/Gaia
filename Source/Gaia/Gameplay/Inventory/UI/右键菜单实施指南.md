# å³é”®èœå•å®æ–½æŒ‡å— - Phase 1 å®Œæˆ

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®ç»“æ„å®šä¹‰
- âœ… `EItemContextMenuType` - èœå•ç±»å‹æšä¸¾
- âœ… `EItemContextAction` - æ“ä½œç±»å‹æšä¸¾
- âœ… `FItemContextMenuItem` - èœå•é¡¹é…ç½®ç»“æ„
- âœ… `FGaiaItemDefinition` - æ·»åŠ äº† `ContextMenuType` å’Œ `CustomMenuItems` å­—æ®µ

### 2. Widget ç±»å®ç°
- âœ… `UGaiaContextMenuButton` - èœå•é¡¹æŒ‰é’®Widget
- âœ… `UGaiaItemContextMenu` - å³é”®èœå•Widget

### 3. é¢„å®šä¹‰èœå•é…ç½®
- âœ… Consumableï¼ˆæ¶ˆè€—å“ï¼‰ï¼šä½¿ç”¨ã€ä¸¢å¼ƒã€é”€æ¯
- âœ… Equipmentï¼ˆè£…å¤‡ï¼‰ï¼šè£…å¤‡ã€ä¸¢å¼ƒã€é”€æ¯
- âœ… Containerï¼ˆå®¹å™¨ï¼‰ï¼šæ‰“å¼€ã€æ¸…ç©ºã€ä¸¢å¼ƒ
- âœ… Materialï¼ˆææ–™ï¼‰ï¼šæ‹†åˆ†ã€ä¸¢å¼ƒã€é”€æ¯
- âœ… QuestItemï¼ˆä»»åŠ¡ç‰©å“ï¼‰ï¼šæŸ¥çœ‹è¯¦æƒ…

## ğŸ“‹ å¾…å®Œæˆçš„é›†æˆå·¥ä½œ

### æ­¥éª¤ 1: ä¿®æ”¹ GaiaUIManagerSubsystem

éœ€è¦æ·»åŠ é€šè¿‡ ItemUID æ‰“å¼€å®¹å™¨çš„æ–¹æ³•ï¼š

```cpp
// GaiaUIManagerSubsystem.h
public:
	/**
	 * é€šè¿‡ç‰©å“UIDæ‰“å¼€å®¹å™¨ï¼ˆå³é”®èœå•è°ƒç”¨ï¼‰
	 * @param ItemUID ç‰©å“UID
	 */
	UFUNCTION(BlueprintCallable, Category = "Gaia|UI")
	void OpenContainerByItemUID(const FGuid& ItemUID);

// GaiaUIManagerSubsystem.cpp
void UGaiaUIManagerSubsystem::OpenContainerByItemUID(const FGuid& ItemUID)
{
	// 1. ä»åº“å­˜å­ç³»ç»Ÿè·å–ç‰©å“
	UGaiaInventorySubsystem* InvSys = UGaiaInventorySubsystem::Get(this);
	if (!InvSys)
	{
		return;
	}

	FGaiaItemInstance Item;
	if (!InvSys->FindItemByUID(ItemUID, Item))
	{
		UE_LOG(LogGaia, Warning, TEXT("OpenContainerByItemUID: Item not found"));
		return;
	}

	// 2. æ£€æŸ¥ç‰©å“æ˜¯å¦æœ‰å®¹å™¨
	if (!Item.HasContainer())
	{
		UE_LOG(LogGaia, Warning, TEXT("OpenContainerByItemUID: Item has no container"));
		return;
	}

	// 3. æ‰“å¼€å®¹å™¨
	OpenContainer(Item.OwnedContainerUID);
}
```

### æ­¥éª¤ 2: ä¿®æ”¹ GaiaItemSlotWidget

éœ€è¦æ·»åŠ å³é”®äº‹ä»¶å¤„ç†å’Œèœå•æ˜¾ç¤ºï¼š

```cpp
// GaiaItemSlotWidget.h
protected:
	/** å³é”®èœå•Widgetç±» */
	UPROPERTY(EditDefaultsOnly, Category = "Gaia|UI")
	TSubclassOf<UGaiaItemContextMenu> ContextMenuClass;

	/**
	 * æ˜¾ç¤ºå³é”®èœå•
	 * @param ScreenPosition å±å¹•ä½ç½®
	 */
	void ShowContextMenu(FVector2D ScreenPosition);

	/**
	 * è·å–ç‰©å“å®šä¹‰
	 * @param OutItemDef è¾“å‡ºçš„ç‰©å“å®šä¹‰
	 * @return æ˜¯å¦æˆåŠŸè·å–
	 */
	bool GetItemDefinition(FGaiaItemDefinition& OutItemDef) const;

// GaiaItemSlotWidget.cpp
FReply UGaiaItemSlotWidget::NativeOnMouseButtonDown(const FGeometry& InGeometry, const FPointerEvent& InMouseEvent)
{
	// å¤„ç†å³é”®
	if (InMouseEvent.IsMouseButtonDown(EKeys::RightMouseButton) && !SlotInfo.IsEmpty())
	{
		ShowContextMenu(InMouseEvent.GetScreenSpacePosition());
		return FReply::Handled();
	}

	// ç°æœ‰çš„å·¦é”®é€»è¾‘...
	return Super::NativeOnMouseButtonDown(InGeometry, InMouseEvent);
}

void UGaiaItemSlotWidget::ShowContextMenu(FVector2D ScreenPosition)
{
	// è·å–ç‰©å“å®šä¹‰
	FGaiaItemDefinition ItemDef;
	if (!GetItemDefinition(ItemDef))
	{
		return;
	}

	// æ£€æŸ¥èœå•ç±»å‹
	if (ItemDef.ContextMenuType == EItemContextMenuType::None)
	{
		return;
	}

	// åˆ›å»ºèœå•Widget
	if (!ContextMenuClass)
	{
		UE_LOG(LogGaia, Warning, TEXT("ContextMenuClass not set in ItemSlotWidget"));
		return;
	}

	UGaiaItemContextMenu* ContextMenu = CreateWidget<UGaiaItemContextMenu>(
		GetOwningPlayer(), ContextMenuClass);

	if (ContextMenu)
	{
		// åˆå§‹åŒ–èœå•
		ContextMenu->InitializeMenu(SlotInfo.ItemInstanceUID, ItemDef);
		ContextMenu->SetMenuPosition(ScreenPosition);

		// æ·»åŠ åˆ°Menu Layer
		if (UGaiaUIManagerSubsystem* UIManager = UGaiaUIManagerSubsystem::Get(this))
		{
			UIManager->PushWidgetToLayer(
				FGameplayTag::RequestGameplayTag(TEXT("UI.Layer.Menu")),
				ContextMenu
			);
		}
	}
}

bool UGaiaItemSlotWidget::GetItemDefinition(FGaiaItemDefinition& OutItemDef) const
{
	if (SlotInfo.IsEmpty())
	{
		return false;
	}

	// ä»åº“å­˜å­ç³»ç»Ÿè·å–ç‰©å“
	UGaiaInventorySubsystem* InvSys = UGaiaInventorySubsystem::Get(this);
	if (!InvSys)
	{
		return false;
	}

	FGaiaItemInstance Item;
	if (!InvSys->FindItemByUID(SlotInfo.ItemInstanceUID, Item))
	{
		return false;
	}

	// è·å–ç‰©å“å®šä¹‰
	return InvSys->GetItemDefinition(Item.ItemDefinitionID, OutItemDef);
}
```

### æ­¥éª¤ 3: åˆ›å»ºUMGè“å›¾

#### 3.1 åˆ›å»ºèœå•é¡¹æŒ‰é’® (WBP_ContextMenuButton)

ç»§æ‰¿è‡ª `UGaiaContextMenuButton`

**Widgetç»“æ„**ï¼š
```
- Horizontal Box
  - Image: Icon (å¯è§æ€§: Collapsed)
  - Text Block: Text
```

**æ ·å¼è®¾ç½®**ï¼š
- èƒŒæ™¯ï¼šåŠé€æ˜é»‘è‰²
- Hoverï¼šæµ…ç°è‰²é«˜äº®
- Paddingï¼šå·¦å³10ï¼Œä¸Šä¸‹5
- å­—ä½“å¤§å°ï¼š14

#### 3.2 åˆ›å»ºå³é”®èœå• (WBP_ItemContextMenu)

ç»§æ‰¿è‡ª `UGaiaItemContextMenu`

**Widgetç»“æ„**ï¼š
```
- Canvas Panel
  - Border (MenuBackground)
    - Vertical Box: MenuItemsContainer (ç»‘å®š)
```

**æ ·å¼è®¾ç½®**ï¼š
- BorderèƒŒæ™¯ï¼šæ·±è‰²åŠé€æ˜
- Border Paddingï¼š8
- åœ†è§’ï¼š4
- é˜´å½±ï¼šOffset(2,2), æ¨¡ç³Š8

#### 3.3 é…ç½® ItemSlotWidget (WBP_ItemSlot)

åœ¨ `WBP_ItemSlot` çš„è¯¦æƒ…é¢æ¿ä¸­ï¼š
1. è®¾ç½® `Context Menu Class` = `WBP_ItemContextMenu`

### æ­¥éª¤ 4: é…ç½®æµ‹è¯•ç‰©å“

åœ¨ DataTable ä¸­è®¾ç½®ç‰©å“çš„ `ContextMenuType`ï¼š

| ç‰©å“ | ContextMenuType | è¯´æ˜ |
|------|----------------|------|
| TestItem | Material | æ™®é€šææ–™ |
| TestItem2 | Consumable | æ¶ˆè€—å“ |
| TestItem3 (å¸¦å®¹å™¨) | Container | å®¹å™¨ç‰©å“ |

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•
1. âœ… å³é”®ç‚¹å‡»ç‰©å“æ§½ä½æ˜¾ç¤ºèœå•
2. âœ… èœå•é¡¹æ ¹æ®ç‰©å“ç±»å‹æ­£ç¡®æ˜¾ç¤º
3. âœ… ç‚¹å‡»èœå•é¡¹è¾“å‡ºæ­£ç¡®çš„æ—¥å¿—
4. âœ… ç‚¹å‡»èœå•å¤–å…³é—­èœå•
5. âœ… ESCé”®å…³é—­èœå•

### 2. å®¹å™¨æ“ä½œæµ‹è¯•
1. âœ… å³é”®å®¹å™¨ç‰©å“æ˜¾ç¤º"æ‰“å¼€"é€‰é¡¹
2. âœ… ç‚¹å‡»"æ‰“å¼€"æ­£ç¡®æ‰“å¼€å®¹å™¨çª—å£
3. âœ… å¤šä¸ªå®¹å™¨å¯ä»¥åŒæ—¶æ‰“å¼€

### 3. è¾¹ç•Œæµ‹è¯•
1. âœ… ç©ºæ§½ä½å³é”®æ— ååº”
2. âœ… èœå•ä¸è¶…å‡ºå±å¹•è¾¹ç•Œ
3. âœ… å¿«é€Ÿå³é”®ä¸å¡é¡¿

## ğŸ“ æ³¨æ„äº‹é¡¹

### å½“å‰é™åˆ¶
1. **éƒ¨åˆ†æ“ä½œæœªå®ç°**ï¼š
   - ä½¿ç”¨ç‰©å“ï¼ˆéœ€è¦ç‰©å“æ•ˆæœç³»ç»Ÿï¼‰
   - è£…å¤‡ç³»ç»Ÿï¼ˆéœ€è¦è£…å¤‡æ§½ä½ï¼‰
   - æ‹†åˆ†å¯¹è¯æ¡†ï¼ˆPhase 3ï¼‰
   - ç¡®è®¤å¯¹è¯æ¡†ï¼ˆPhase 3ï¼‰
   - ä¸¢å¼ƒç‰©å“ï¼ˆéœ€è¦ä¸–ç•ŒActorç”Ÿæˆï¼‰

2. **èœå•å®šä½**ï¼š
   - å½“å‰ç‰ˆæœ¬èœå•ä½ç½®ç”±UMG Canvasæ§åˆ¶
   - æœªå®ç°æ™ºèƒ½é¿è®©å±å¹•è¾¹ç•Œ
   - å»ºè®®åœ¨è“å›¾ä¸­å®ç°å®šä½é€»è¾‘

3. **è¾“å…¥å¤„ç†**ï¼š
   - ä½¿ç”¨ CommonUI çš„ Layer ç³»ç»Ÿ
   - ESCé”®å…³é—­ç”± CommonActivatableWidget è‡ªåŠ¨å¤„ç†
   - ç‚¹å‡»å¤–éƒ¨å…³é—­éœ€è¦åœ¨UMGä¸­é…ç½®

### æœ€ä½³å®è·µ
1. **åœ¨ç‰©å“å®šä¹‰è¡¨ä¸­é…ç½®èœå•ç±»å‹**
2. **å®¹å™¨ç‰©å“ä½¿ç”¨ Container ç±»å‹**
3. **å¯å †å ææ–™ä½¿ç”¨ Material ç±»å‹**
4. **ä»»åŠ¡ç‰©å“ä½¿ç”¨ QuestItem ç±»å‹**
5. **ç‰¹æ®Šç‰©å“å¯ä»¥ä½¿ç”¨ Custom è‡ªå®šä¹‰èœå•**

## ğŸ”œ ä¸‹ä¸€æ­¥è®¡åˆ’

### Phase 2: æ ¸å¿ƒæ“ä½œå®ç°
1. å®ç°"æ‰“å¼€å®¹å™¨"æ“ä½œï¼ˆå·²å®Œæˆæ¡†æ¶ï¼‰
2. å®ç°"ä¸¢å¼ƒç‰©å“"æ“ä½œ
3. å®ç°"é”€æ¯ç‰©å“"æ“ä½œï¼ˆå¸¦ç¡®è®¤ï¼‰

### Phase 3: é«˜çº§åŠŸèƒ½
1. æ‹†åˆ†å¯¹è¯æ¡†
2. ä½¿ç”¨ç‰©å“ç³»ç»Ÿ
3. è£…å¤‡ç³»ç»Ÿé›†æˆ
4. è‡ªå®šä¹‰èœå•é¡¹æ”¯æŒ

## ğŸ“š ç›¸å…³æ–‡æ¡£
- [å³é”®èœå•ç³»ç»Ÿè®¾è®¡.md](å³é”®èœå•ç³»ç»Ÿè®¾è®¡.md) - å®Œæ•´è®¾è®¡æ–‡æ¡£
- [UIç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ.md](UIç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ.md) - UIç³»ç»Ÿæ€»è§ˆ

