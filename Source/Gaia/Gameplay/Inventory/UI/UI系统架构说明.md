# UIç³»ç»Ÿæ¶æ„è¯´æ˜

> **æ·±å…¥ç†è§£åº“å­˜UIç³»ç»Ÿçš„è®¾è®¡ç†å¿µå’ŒæŠ€æœ¯æ¶æ„**

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
4. [ç»„ä»¶è¯´æ˜](#ç»„ä»¶è¯´æ˜)
5. [æ•°æ®æµ](#æ•°æ®æµ)
6. [è®¾è®¡ç†å¿µ](#è®¾è®¡ç†å¿µ)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

### è®¾è®¡ç›®æ ‡

1. **ç°ä»£åŒ–** - å®Œå…¨åŸºäºUE5 CommonUIæ’ä»¶
2. **å¯æ‰©å±•** - æ¸…æ™°çš„å±‚çº§ç»“æ„ï¼Œæ˜“äºæ‰©å±•
3. **é«˜æ€§èƒ½** - äº‹ä»¶é©±åŠ¨ï¼Œé¿å…è½®è¯¢
4. **ç½‘ç»œå°±ç»ª** - å®Œæ•´çš„å¤šäººæ¸¸æˆæ”¯æŒ

### æ ¸å¿ƒç‰¹æ€§

- âœ… **Layer System** - 4å±‚UIäº’ä¸å¹²æ‰°
- âœ… **è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸ** - Widgetè‡ªåŠ¨ç®¡ç†æ¿€æ´»/åœç”¨
- âœ… **è‡ªåŠ¨è¾“å…¥è·¯ç”±** - ESCé”®ã€æ‰‹æŸ„å¯¼èˆª
- âœ… **è‡ªåŠ¨Z-Order** - ç‚¹å‡»çª—å£è‡ªåŠ¨ç½®é¡¶
- âœ… **äº‹ä»¶é©±åŠ¨æ›´æ–°** - RPCäº‹ä»¶è§¦å‘UIåˆ·æ–°
- âœ… **æƒé™é›†æˆ** - è‡ªåŠ¨æ£€æŸ¥å®¹å™¨è®¿é—®æƒé™

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              UGameInstance                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    UGaiaInventoryUIManager (UIManagerSubsystem) â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â€¢ ç®¡ç†UIç”Ÿå‘½å‘¨æœŸ                                â”‚   â”‚
â”‚  â”‚  â€¢ æ‰“å¼€/å…³é—­å®¹å™¨çª—å£                            â”‚   â”‚
â”‚  â”‚  â€¢ ä¸PrimaryGameLayoutäº¤äº’                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            LocalPlayer + PlayerController                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      UGaiaPrimaryGameLayout (PrimaryGameLayout)â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ GameLayer (WidgetStack)                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ ç©å®¶èƒŒåŒ…ã€è£…å¤‡æ                       â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ ContainerLayer (WidgetStack)              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ å®¹å™¨çª—å£1ã€çª—å£2ã€çª—å£3...           â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ MenuLayer (WidgetStack)                   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ å³é”®èœå•ã€Tooltip                     â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ ModalLayer (WidgetStack)                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ æ•°é‡è¾“å…¥ã€ç¡®è®¤å¯¹è¯æ¡†                  â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å®¹å™¨çª—å£ (GaiaContainerWindowWidget)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ æ ‡é¢˜æ ã€å…³é—­æŒ‰é’®                               â”‚   â”‚
â”‚  â”‚ â€¢ GaiaContainerGridWidget (ç½‘æ ¼)                â”‚   â”‚
â”‚  â”‚ â€¢ GaiaContainerDebugInfoWidget (è°ƒè¯•ä¿¡æ¯)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å®¹å™¨ç½‘æ ¼ (GaiaContainerGridWidget)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ è‡ªåŠ¨åˆ›å»ºæ§½ä½                                   â”‚   â”‚
â”‚  â”‚ â€¢ UniformGridPanel / WrapBoxå¸ƒå±€                â”‚   â”‚
â”‚  â”‚ â€¢ åˆ·æ–°æœºåˆ¶                                       â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚ [æ§½ä½1] [æ§½ä½2] [æ§½ä½3] ...                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç‰©å“æ§½ä½ (GaiaItemSlotWidget)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ æ˜¾ç¤ºç‰©å“å›¾æ ‡ã€æ•°é‡                             â”‚   â”‚
â”‚  â”‚ â€¢ é¼ æ ‡äº¤äº’ï¼ˆæ‚¬åœã€ç‚¹å‡»ï¼‰                        â”‚   â”‚
â”‚  â”‚ â€¢ æ‹–æ”¾æ“ä½œ (GaiaItemDragDropOperation)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» æŠ€æœ¯æ ˆ

### CommonUIæ’ä»¶ç»„ä»¶

| ç±» | ç”¨é€” |
|-----|------|
| `UGameUIManagerSubsystem` | UIç”Ÿå‘½å‘¨æœŸç®¡ç† |
| `UGameUIPolicy` | UIç­–ç•¥å’Œè§„åˆ™ |
| `UPrimaryGameLayout` | é¡¶å±‚å¸ƒå±€å®¹å™¨ |
| `UCommonActivatableWidget` | å¯æ¿€æ´»WidgetåŸºç±» |
| `UCommonActivatableWidgetStack` | Widgetæ ˆå®¹å™¨ |
| `UCommonUserWidget` | é€šç”¨WidgetåŸºç±» |

### GameplayTagç³»ç»Ÿ

ç”¨äºæ ‡è¯†UIå±‚çº§ï¼š
- `UI.Layer.Inventory.Game`
- `UI.Layer.Inventory.Container`
- `UI.Layer.Inventory.Menu`
- `UI.Layer.Inventory.Modal`

### ç½‘ç»œåŒæ­¥

- `UGaiaInventoryRPCComponent` - å®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡
- `Blueprint Events` - UIæ›´æ–°é€šçŸ¥
- `UGaiaInventorySubsystem` - æœåŠ¡å™¨æƒå¨æ•°æ®

---

## ğŸ§© ç»„ä»¶è¯´æ˜

### 1. GaiaUIPolicy

**èŒè´£ï¼š** å®šä¹‰UIçš„å…¨å±€è¡Œä¸ºå’Œç­–ç•¥

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- æŒ‡å®šä½¿ç”¨å“ªä¸ªPrimaryGameLayout
- å®šä¹‰UIçš„å…¨å±€è§„åˆ™
- å¤„ç†å¤šç©å®¶UIï¼ˆæœ¬åœ°å¤šäººæ¸¸æˆï¼‰

**ä»£ç ï¼š**
```cpp
UCLASS(Blueprintable)
class UGaiaUIPolicy : public UGameUIPolicy
{
    GENERATED_BODY()
};
```

### 2. GaiaPrimaryGameLayout

**èŒè´£ï¼š** ç®¡ç†UIçš„å±‚çº§ç»“æ„

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- åŒ…å«4ä¸ªWidget Stackä½œä¸ºUIå±‚
- æ³¨å†ŒLayeråˆ°GameplayTagç³»ç»Ÿ
- æä¾›æ¨å…¥/ç§»é™¤Widgetçš„API

**å…³é”®ä»£ç ï¼š**
```cpp
// æ¨å…¥Widgetåˆ°Layer
template<typename T>
T* PushWidgetToLayerStack(FGameplayTag LayerTag, TSubclassOf<T> WidgetClass)
{
    return PrimaryGameLayout->PushWidgetToLayerStack<T>(
        LayerTag, WidgetClass
    );
}
```

### 3. GaiaInventoryUIManager

**èŒè´£ï¼š** åº“å­˜UIçš„ä¸“ç”¨ç®¡ç†å™¨

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- æ‰“å¼€/å…³é—­å®¹å™¨çª—å£
- ç®¡ç†æ‰“å¼€çš„çª—å£åˆ—è¡¨
- æä¾›ä¾¿æ·çš„API

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```cpp
// æ‰“å¼€çª—å£
UGaiaContainerWindowWidget* Window = UIManager->OpenContainerWindow(ContainerUID);

// å…³é—­çª—å£
UIManager->CloseContainerWindow(Window);

// æ£€æŸ¥çŠ¶æ€
bool bIsOpen = UIManager->IsContainerWindowOpen(ContainerUID);
```

### 4. GaiaContainerWindowWidget

**èŒè´£ï¼š** å•ä¸ªå®¹å™¨çª—å£

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- æ˜¾ç¤ºå®¹å™¨å†…å®¹
- å¤„ç†å…³é—­æŒ‰é’®
- æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
- è‡ªåŠ¨ç®¡ç†æ¿€æ´»/åœç”¨

**ç”Ÿå‘½å‘¨æœŸï¼š**
```cpp
void NativeOnActivated()    // çª—å£æ¿€æ´»æ—¶
void NativeOnDeactivated()  // çª—å£åœç”¨æ—¶
UWidget* NativeGetDesiredFocusTarget() // ç„¦ç‚¹ç®¡ç†
```

### 5. GaiaContainerGridWidget

**èŒè´£ï¼š** å®¹å™¨çš„æ§½ä½ç½‘æ ¼

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- è‡ªåŠ¨åˆ›å»ºæ§½ä½Widget
- æ”¯æŒç½‘æ ¼/è‡ªåŠ¨æ¢è¡Œå¸ƒå±€
- åˆ·æ–°æ§½ä½æ˜¾ç¤º
- ç®¡ç†æ§½ä½ç”Ÿå‘½å‘¨æœŸ

**å¸ƒå±€é€‰é¡¹ï¼š**
- `UniformGridPanel` - å›ºå®šç½‘æ ¼ï¼ˆå¦‚ï¼š10Ã—10ï¼‰
- `WrapBox` - è‡ªåŠ¨æ¢è¡Œ

### 6. GaiaItemSlotWidget

**èŒè´£ï¼š** å•ä¸ªç‰©å“æ§½ä½

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- æ˜¾ç¤ºç‰©å“å›¾æ ‡ã€æ•°é‡
- å¤„ç†é¼ æ ‡äº¤äº’ï¼ˆæ‚¬åœã€ç‚¹å‡»ï¼‰
- æ”¯æŒæ‹–æ”¾æ“ä½œ
- å¤šç§è§†è§‰çŠ¶æ€ï¼ˆç©ºã€æ­£å¸¸ã€é«˜äº®ã€é€‰ä¸­ã€æ‹–æ”¾ç›®æ ‡ï¼‰

**äº¤äº’ï¼š**
```cpp
// é¼ æ ‡æ‚¬åœ â†’ é«˜äº®
NativeOnMouseEnter() { SetHighlighted(true); }

// å·¦é”®æ‹–åŠ¨ â†’ å¼€å§‹æ‹–æ”¾
NativeOnDragDetected() { OutOperation = CreateDragDropOperation(); }

// å³é”®ç‚¹å‡» â†’ æ˜¾ç¤ºèœå•
OnRightClick() { ShowContextMenu(); }
```

### 7. GaiaItemDragDropOperation

**èŒè´£ï¼š** ç‰©å“æ‹–æ”¾æ“ä½œ

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- å­˜å‚¨æ‹–æ”¾æ•°æ®ï¼ˆæºæ§½ä½ã€ç‰©å“UIDï¼‰
- æ‰§è¡Œç§»åŠ¨/äº¤æ¢/å †å 
- æƒé™æ£€æŸ¥
- ç½‘ç»œRPCè°ƒç”¨

**æ“ä½œç±»å‹ï¼š**
```cpp
MoveItemToSlot()    // ç§»åŠ¨åˆ°ç©ºæ§½ä½
SwapItemWithSlot()  // äº¤æ¢ç‰©å“
StackItemToSlot()   // å †å ç‰©å“
```

---

## ğŸ”„ æ•°æ®æµ

### æ‰“å¼€å®¹å™¨çª—å£æµç¨‹

```
ç”¨æˆ·æ“ä½œ (æŒ‰Eé”®)
    â†“
GaiaInventoryUIManager::OpenContainerWindow(ContainerUID)
    â†“
æ£€æŸ¥æ˜¯å¦å·²æ‰“å¼€
    â†“ No
PrimaryGameLayout::PushWidgetToLayerStack(ContainerLayerTag, WindowClass)
    â†“
åˆ›å»ºWidgetå®ä¾‹
    â†“
Widget::InitializeWindow(ContainerUID)
    â†“
ContainerGrid::InitializeContainer(ContainerUID)
    â†“
æŸ¥è¯¢InventorySubsystemè·å–å®¹å™¨æ•°æ®
    â†“
åˆ›å»ºæ§½ä½Widgets
    â†“
æ˜¾ç¤ºåœ¨å±å¹•ä¸Š
```

### æ‹–æ”¾ç‰©å“æµç¨‹

```
ç”¨æˆ·å·¦é”®æŒ‰ä¸‹å¹¶æ‹–åŠ¨
    â†“
ItemSlot::NativeOnDragDetected()
    â†“
åˆ›å»º DragDropOperation
    â†“
ç”¨æˆ·æ‹–åˆ°ç›®æ ‡æ§½ä½
    â†“
TargetSlot::NativeOnDragEnter()
    â†“
æ£€æŸ¥æ˜¯å¦å¯æ‹–æ”¾ (CanDropToSlot)
    â†“ Yes â†’ æ˜¾ç¤ºç»¿è‰²
ç”¨æˆ·æ¾å¼€é¼ æ ‡
    â†“
TargetSlot::NativeOnDrop()
    â†“
DragDropOperation::ExecuteDropToSlot()
    â†“
åˆ¤æ–­æ“ä½œç±»å‹ (ç§»åŠ¨/äº¤æ¢/å †å )
    â†“
RPCComponent::RequestMoveItem()
    â†“
æœåŠ¡å™¨å¤„ç† (InventorySubsystem)
    â†“
æœåŠ¡å™¨å¹¿æ’­æ›´æ–°
    â†“
RPC Event: OnInventoryUpdated
    â†“
UIåˆ·æ–°æ˜¾ç¤º
```

### ç½‘ç»œåŒæ­¥æµç¨‹

```
Client: æ‹–æ”¾æ“ä½œ
    â†“
Client: RPCComponent->RequestMoveItem()
    â†“
[RPC] â†’ Server
    â†“
Server: éªŒè¯æƒé™
    â†“
Server: InventorySubsystem->MoveItem()
    â†“
Server: ä¿®æ”¹æ•°æ® (AllItems)
    â†“
Server: BroadcastContainerUpdate()
    â†“
Server: æŸ¥æ‰¾ç›¸å…³ç©å®¶ (æ‰€æœ‰è€…+è®¿é—®è€…)
    â†“
[RPC] â†’ Clients (åªé€šçŸ¥ç›¸å…³ç©å®¶)
    â†“
Client: OnRep / ClientEvent
    â†“
Client: UIè‡ªåŠ¨åˆ·æ–°
```

---

## ğŸ’¡ è®¾è®¡ç†å¿µ

### 1. äº‹ä»¶é©±åŠ¨ï¼Œè€Œéè½®è¯¢

**ä¼ ç»Ÿåšæ³•ï¼ˆâŒï¼‰ï¼š**
```cpp
void Tick(float DeltaTime)
{
    // æ¯å¸§æ£€æŸ¥æ•°æ®å˜åŒ–
    if (HasDataChanged())
    {
        RefreshUI();
    }
}
```

**æˆ‘ä»¬çš„åšæ³•ï¼ˆâœ…ï¼‰ï¼š**
```cpp
// ç»‘å®šRPCäº‹ä»¶
RPCComponent->OnInventoryUpdated.AddDynamic(this, &Widget::RefreshUI);

// åªåœ¨æ•°æ®å˜åŒ–æ—¶è§¦å‘
void RefreshUI() {
    // åˆ·æ–°æ˜¾ç¤º
}
```

### 2. Layer Systemåˆ†å±‚ç®¡ç†

**ä¼˜åŠ¿ï¼š**
- äº’ä¸å¹²æ‰° - å„å±‚ç‹¬ç«‹ç®¡ç†
- è‡ªåŠ¨Z-Order - ç‚¹å‡»çª—å£è‡ªåŠ¨ç½®é¡¶
- è‡ªåŠ¨è¾“å…¥è·¯ç”± - ESCé”®é€å±‚å…³é—­
- ç„¦ç‚¹ç®¡ç† - è‡ªåŠ¨è®¾ç½®ç„¦ç‚¹

**å®ç°ï¼š**
```cpp
// å®¹å™¨çª—å£æ¨å…¥ ContainerLayer
UIManager->PushWidgetToLayer(GetContainerLayerTag(), WindowClass);

// å³é”®èœå•æ¨å…¥ MenuLayer
UIManager->PushWidgetToLayer(GetMenuLayerTag(), ContextMenuClass);

// å¯¹è¯æ¡†æ¨å…¥ ModalLayer
UIManager->PushWidgetToLayer(GetModalLayerTag(), DialogClass);
```

### 3. è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

**ä¼˜åŠ¿ï¼š**
- æ— éœ€æ‰‹åŠ¨ç®¡ç†Widgetåˆ›å»º/é”€æ¯
- è‡ªåŠ¨å¤„ç†æ¿€æ´»/åœç”¨
- è‡ªåŠ¨å†…å­˜ç®¡ç†

**å®ç°ï¼š**
```cpp
// Widgetæ¨å…¥æ—¶è‡ªåŠ¨è°ƒç”¨
void NativeOnActivated()
{
    // åˆ·æ–°æ•°æ®
    RefreshData();
}

// Widgetç§»é™¤æ—¶è‡ªåŠ¨è°ƒç”¨
void NativeOnDeactivated()
{
    // ä¿å­˜çŠ¶æ€
    SaveState();
}
```

### 4. æƒé™é›†æˆ

**ä¼˜åŠ¿ï¼š**
- æ‹–æ”¾å‰è‡ªåŠ¨æ£€æŸ¥æƒé™
- æœåŠ¡å™¨ç«¯äºŒæ¬¡éªŒè¯
- æ¸…æ™°çš„é”™è¯¯æç¤º

**å®ç°ï¼š**
```cpp
bool CanDropToSlot(TargetSlot, ErrorMsg)
{
    // æ£€æŸ¥å®¹å™¨æƒé™
    if (!InventorySystem->CanPlayerAccessContainer(TargetContainerUID))
    {
        ErrorMsg = "æ— æƒè®¿é—®è¯¥å®¹å™¨";
        return false;
    }
    return true;
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. äº‹ä»¶é©±åŠ¨æ›´æ–°

**é¿å…æ¯å¸§åˆ·æ–°ï¼š**
- âœ… åªåœ¨æ•°æ®å˜åŒ–æ—¶åˆ·æ–°
- âœ… ä½¿ç”¨RPCäº‹ä»¶è§¦å‘
- âœ… æ‰¹é‡æ›´æ–°è€Œéå•ä¸ªæ›´æ–°

### 2. å»¶è¿ŸåŠ è½½

**Widgetç±»å»¶è¿ŸåŠ è½½ï¼š**
```cpp
// ä½¿ç”¨TSoftClassPtr
UPROPERTY(config)
TSoftClassPtr<UGaiaContainerWindowWidget> ContainerWindowClass;

// ä½¿ç”¨æ—¶æ‰åŠ è½½
UClass* WidgetClass = ContainerWindowClass.LoadSynchronous();
```

### 3. å¯¹è±¡æ± ï¼ˆå¯é€‰ï¼‰

**ç¼“å­˜å·²åˆ›å»ºçš„Widgetï¼š**
```cpp
// åœ¨UIManagerä¸­
TMap<FGuid, TWeakObjectPtr<UGaiaContainerWindowWidget>> CachedWindows;

// å¤ç”¨è€Œéé‡æ–°åˆ›å»º
UGaiaContainerWindowWidget* GetOrCreateWindow(FGuid UID)
{
    if (CachedWindows.Contains(UID) && CachedWindows[UID].IsValid())
    {
        return CachedWindows[UID].Get();
    }
    // åˆ›å»ºæ–°çš„...
}
```

### 4. å¼‚æ­¥åŠ è½½

**å¤§é‡æ§½ä½æ—¶ä½¿ç”¨å¼‚æ­¥åŠ è½½ï¼š**
```cpp
Layout->PushWidgetToLayerStackAsync<T>(
    LayerTag,
    true, // æš‚åœè¾“å…¥
    WidgetClass,
    Callback
);
```

### 5. è™šæ‹ŸåŒ–åˆ—è¡¨ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

å¯¹äºè¶…å¤§å®¹å™¨ï¼ˆ100+æ§½ä½ï¼‰ï¼Œè€ƒè™‘ä½¿ç”¨ `UListView` è™šæ‹ŸåŒ–ï¼š
- åªæ¸²æŸ“å¯è§æ§½ä½
- æ»šåŠ¨æ—¶åŠ¨æ€åˆ›å»º/é”€æ¯
- å¤§å¹…å‡å°‘å†…å­˜å’Œæ¸²æŸ“å¼€é”€

---

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### ä¸ä¼ ç»ŸUMGå¯¹æ¯”

| ç‰¹æ€§ | ä¼ ç»ŸUMG | æˆ‘ä»¬çš„ç³»ç»Ÿ |
|------|---------|-----------|
| çª—å£ç®¡ç† | æ‰‹åŠ¨Add/Remove | Layer Systemè‡ªåŠ¨ç®¡ç† |
| Z-Order | æ‰‹åŠ¨è®¾ç½®ZOrder | è‡ªåŠ¨ç®¡ç†ï¼Œç‚¹å‡»ç½®é¡¶ |
| ESCé”® | æ‰‹åŠ¨ç»‘å®š | è‡ªåŠ¨å¤„ç† |
| ç„¦ç‚¹ç®¡ç† | æ‰‹åŠ¨è®¾ç½® | è‡ªåŠ¨ç®¡ç† |
| ç”Ÿå‘½å‘¨æœŸ | æ‰‹åŠ¨Construct/Destruct | è‡ªåŠ¨Activate/Deactivate |
| å¤šçª—å£ | å¤æ‚çš„ç®¡ç†å™¨ | Layer Stackè‡ªåŠ¨å¤„ç† |
| æ‰‹æŸ„æ”¯æŒ | éœ€è¦å¤§é‡ä»£ç  | CommonUIè‡ªå¸¦ |

### å¯æ‰©å±•æ€§

**æ·»åŠ æ–°Widgetç±»å‹ï¼š**
1. ç»§æ‰¿ `UCommonActivatableWidget`
2. å®ç° `NativeOnActivated` / `NativeOnDeactivated`
3. ä½¿ç”¨ `PushWidgetToLayer` æ¨å…¥å¯¹åº”Layer

**æ·»åŠ æ–°Layerï¼š**
1. åœ¨ `GaiaPrimaryGameLayout` æ·»åŠ æ–°çš„ WidgetStack
2. æ³¨å†Œåˆ°GameplayTagç³»ç»Ÿ
3. æä¾›é™æ€è®¿é—®æ–¹æ³•

---

## ğŸ“– å‚è€ƒèµ„æ–™

### å®˜æ–¹æ–‡æ¡£
- [CommonUI Plugin](https://docs.unrealengine.com/5.0/en-US/common-ui-plugin-for-advanced-input-in-unreal-engine/)
- [GameplayTag System](https://docs.unrealengine.com/5.0/en-US/gameplay-tags-in-unreal-engine/)
- [UMG Best Practices](https://docs.unrealengine.com/5.0/en-US/umg-ui-designer-best-practices-in-unreal-engine/)

### ç›¸å…³æ–‡æ¡£
- [UIç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ.md](UIç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ.md) - å¿«é€Ÿä¸Šæ‰‹
- [README.md](README.md) - ç³»ç»Ÿæ¦‚è§ˆ
- [../README.md](../README.md) - åº“å­˜ç³»ç»Ÿä¸»æ–‡æ¡£

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **å…³æ³¨ç‚¹åˆ†ç¦»** - æ¯ä¸ªç»„ä»¶èŒè´£å•ä¸€
2. **äº‹ä»¶é©±åŠ¨** - é¿å…è½®è¯¢ï¼Œä½¿ç”¨äº‹ä»¶
3. **è‡ªåŠ¨åŒ–** - è®©ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
4. **å¯æ‰©å±•** - æ¸…æ™°çš„å±‚çº§ï¼Œæ˜“äºæ‰©å±•

### æŠ€æœ¯äº®ç‚¹

- âœ… å®Œå…¨åŸºäºCommonUIæ’ä»¶
- âœ… Layer Systemè‡ªåŠ¨ç®¡ç†
- âœ… äº‹ä»¶é©±åŠ¨æ›´æ–°æœºåˆ¶
- âœ… å®Œæ•´çš„ç½‘ç»œæ”¯æŒ
- âœ… æƒé™ç³»ç»Ÿé›†æˆ

### æœªæ¥æ‰©å±•æ–¹å‘

1. **å¢å¼ºåŠŸèƒ½**
   - å³é”®èœå•ç³»ç»Ÿ
   - Tooltipç³»ç»Ÿ
   - æ‹–æ”¾è§†è§‰åé¦ˆ

2. **æ€§èƒ½ä¼˜åŒ–**
   - è™šæ‹ŸåŒ–å¤§åˆ—è¡¨
   - å¼‚æ­¥åŠ è½½
   - å¯¹è±¡æ± 

3. **ç”¨æˆ·ä½“éªŒ**
   - åŠ¨ç”»æ•ˆæœ
   - éŸ³æ•ˆåé¦ˆ
   - æ‰‹æŸ„å®Œæ•´æ”¯æŒ

---

**æœ€åæ›´æ–°ï¼š** 2025-10-27  
**ç‰ˆæœ¬ï¼š** 1.0  
**çŠ¶æ€ï¼š** æ ¸å¿ƒæ¶æ„å®Œæˆ

