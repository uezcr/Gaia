# 紧急修复清单

> 修复 "无法获取PrimaryGameLayout" 问题

---

## ✅ 我刚刚修复了什么

### 1. 修改了 Config/DefaultGame.ini

**问题：** `DefaultUIPolicyClass` 配置在错误的section下

**修复前：**
```ini
[/Script/GaiaGame.GaiaUIManagerSubsystem]
DefaultUIPolicyClass=/Game/UI/BP_GaiaUIPolicy.BP_GaiaUIPolicy_C
```

**修复后：**
```ini
[/Script/CommonGame.GameUIManagerSubsystem]  ⭐ 修改了这里
DefaultUIPolicyClass=/Game/UI/BP_GaiaUIPolicy.BP_GaiaUIPolicy_C

[/Script/GaiaGame.GaiaUIManagerSubsystem]
ContainerWindowClass=/Game/UI/WBP_ContainerWindow.WBP_ContainerWindow_C
```

### 2. 添加了 ShouldCreateSubsystem 覆盖

**问题：** GaiaUIManagerSubsystem可能没有被创建

**修复：** 在 `GaiaUIManagerSubsystem.h/.cpp` 中添加了：

```cpp
virtual bool ShouldCreateSubsystem(UObject* Outer) const override;
```

---

## 🔧 你现在需要做的

### 步骤1：重新编译C++代码 ⭐⭐⭐

1. **关闭UE编辑器**
2. **在VS/Rider中重新编译项目**
3. **重新打开UE编辑器**

### 步骤2：配置BP_GaiaUIPolicy ⭐⭐⭐

1. 打开 `Content/UI/BP_GaiaUIPolicy`
2. Details面板 → 找到 **Layout Class** 属性
3. 设置为：`WBP_GaiaPrimaryGameLayout`
4. **编译并保存**

### 步骤3：重启编辑器

配置修改后必须重启！

### 步骤4：测试

运行PIE，查看日志。

---

## ✅ 预期的正确日志

```
LogCommonGame: Log: AddLocalPlayer: Set GaiaLocalPlayer_0 to Primary Player
LogGaia: Log: [Gaia UI管理器] 初始化
LogGaia: Log: [UI Policy] ✅ 玩家布局已添加到Viewport: Player=GaiaLocalPlayer_0, Layout=WBP_GaiaPrimaryGameLayout_C_0
LogGaia: Log: [Gaia UI] 打开容器窗口: [容器GUID]
```

---

## ❌ 如果还是失败

使用诊断工具（见 `UI诊断工具.md`），把诊断日志发给我：

```cpp
// 在PlayerController或测试Actor的BeginPlay中添加
DiagnoseUISystem();  // 函数代码在 UI诊断工具.md
```

告诉我在哪一步失败了（[1/7] ~ [7/7]）。

---

## 📋 完整配置检查

### Config/DefaultEngine.ini
```ini
[/Script/EngineSettings.GameMapsSettings]
GameInstanceClass=/Script/GaiaGame.GaiaGameInstance  ✅

[/Script/Engine.Engine]
GameViewportClientClassName=/Script/CommonUI.CommonGameViewportClient  ✅
LocalPlayerClassName=/Script/GaiaGame.GaiaLocalPlayer  ✅
```

### Config/DefaultGame.ini
```ini
[/Script/CommonGame.GameUIManagerSubsystem]  ⭐ 注意section名称
DefaultUIPolicyClass=/Game/UI/BP_GaiaUIPolicy.BP_GaiaUIPolicy_C
```

### BP_GaiaUIPolicy（蓝图配置）
- Layout Class = `WBP_GaiaPrimaryGameLayout`  ⭐⭐⭐

---

**现在去编译和配置吧！**


