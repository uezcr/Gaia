# å³é”®èœå•å®ç°è¯´æ˜ - ä¸´æ—¶æ–¹æ¡ˆ

## âš ï¸ å½“å‰å®ç°çŠ¶æ€

### é—®é¢˜èƒŒæ™¯
åœ¨å®ç°å³é”®èœå•æ—¶ï¼Œé‡åˆ°äº†å°†å·²åˆ›å»ºçš„Widgetå®ä¾‹æ·»åŠ åˆ° CommonUI Layer çš„æŠ€æœ¯éš¾é¢˜ã€‚

### å°è¯•çš„æ–¹æ³•åŠå¤±è´¥åŸå› 

#### æ–¹æ³• 1: `PushWidgetToLayer` âŒ
```cpp
// æœŸæœ›ï¼šä¼ å…¥Widgetå®ä¾‹
UIManager->PushWidgetToLayer(LayerTag, ContextMenu);

// å®é™…ï¼šè¿™ä¸ªæ–¹æ³•æ¥æ”¶çš„æ˜¯ç±»ï¼Œä¸æ˜¯å®ä¾‹
UCommonActivatableWidget* PushWidgetToLayer(
    FGameplayTag LayerTag,
    TSubclassOf<UCommonActivatableWidget> WidgetClass  // â† éœ€è¦ç±»ï¼
);
```
**å¤±è´¥åŸå› **ï¼šç±»å‹ä¸åŒ¹é…

---

#### æ–¹æ³• 2: `UCommonActivatableWidgetStack::AddWidget` âŒ
```cpp
UCommonActivatableWidgetStack* Stack = Cast<UCommonActivatableWidgetStack>(LayerWidget);
Stack->AddWidget(Widget);
```
**å¤±è´¥åŸå› **ï¼š`AddWidget` æ–¹æ³•ç­¾åä¸åŒ¹é…æˆ–ä¸å­˜åœ¨å…¬å…±æ¥å£

---

#### æ–¹æ³• 3: `UPrimaryGameLayout::AddToLayerStack` âŒ
```cpp
Layout->AddToLayerStack(LayerTag, Widget);
```
**å¤±è´¥åŸå› **ï¼š`UPrimaryGameLayout` æ²¡æœ‰ `AddToLayerStack` æ–¹æ³•

---

### âœ… å½“å‰ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

```cpp
void UGaiaUIManagerSubsystem::PushWidgetInstanceToLayer(
    FGameplayTag LayerTag,
    UCommonActivatableWidget* Widget)
{
    // ... å‰ç½®æ£€æŸ¥ ...
    
    // ç›´æ¥å°†Widgetæ·»åŠ åˆ°Viewportï¼Œç„¶åæ¿€æ´»
    Widget->AddToViewport(1000); // ä½¿ç”¨é«˜Z-Orderç¡®ä¿åœ¨ä¸Šå±‚
    Widget->ActivateWidget();
}
```

**å·¥ä½œåŸç†ï¼š**
- ç»•è¿‡ CommonUI Layer ç³»ç»Ÿ
- ç›´æ¥ä½¿ç”¨ UMG çš„ `AddToViewport` æ–¹æ³•
- æ‰‹åŠ¨è°ƒç”¨ `ActivateWidget` æ¿€æ´»

**ä¼˜ç‚¹ï¼š**
- âœ… ç¼–è¯‘é€šè¿‡
- âœ… å¯ä»¥æ­£å¸¸æ˜¾ç¤ºWidget
- âœ… Widgetå¯ä»¥æ­£å¸¸æ¿€æ´»å’Œæ¥æ”¶è¾“å…¥

**ç¼ºç‚¹ï¼š**
- âŒ ä¸ä½¿ç”¨ CommonUI Layer ç®¡ç†
- âŒ Z-Orderéœ€è¦æ‰‹åŠ¨ç®¡ç†
- âŒ æ— æ³•åˆ©ç”¨ Layer çš„è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âŒ ESCé”®å¤„ç†å¯èƒ½éœ€è¦é¢å¤–å®ç°

---

## ğŸ¯ æ¨èçš„é•¿æœŸè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä½¿ç”¨å›è°ƒæ–¹å¼ï¼ˆæ¨èï¼‰

ä¸é¢„å…ˆåˆ›å»ºWidgetï¼Œè€Œæ˜¯è®© CommonUI åˆ›å»ºï¼š

```cpp
void UGaiaItemSlotWidget::ShowContextMenu(FVector2D ScreenPosition)
{
    // ä¸åˆ›å»ºWidgetå®ä¾‹
    // UGaiaItemContextMenu* ContextMenu = CreateWidget<UGaiaItemContextMenu>(...);
    
    // è·å–ç‰©å“å®šä¹‰ï¼ˆç”¨äºå›è°ƒï¼‰
    FGaiaItemDefinition ItemDef;
    if (!GetItemDefinition(ItemDef))
    {
        return;
    }
    
    FGuid CapturedItemUID = ItemUID;
    FVector2D CapturedScreenPos = ScreenPosition;
    
    // è®©CommonUIåˆ›å»ºWidgetï¼Œåœ¨å›è°ƒä¸­åˆå§‹åŒ–
    UGaiaUIManagerSubsystem* UIManager = UGaiaUIManagerSubsystem::Get(this);
    if (UIManager)
    {
        UGaiaItemContextMenu* ContextMenu = UIManager->PushWidgetToLayerTyped<UGaiaItemContextMenu>(
            FGameplayTag::RequestGameplayTag(TEXT("UI.Layer.Menu")),
            ContextMenuClass,
            [CapturedItemUID, ItemDef, CapturedScreenPos](UGaiaItemContextMenu& Menu)
            {
                Menu.InitializeMenu(CapturedItemUID, ItemDef);
                Menu.SetMenuPosition(CapturedScreenPos);
            }
        );
    }
}
```

**å®ç°æ­¥éª¤ï¼š**
1. åœ¨ `GaiaUIManagerSubsystem` æ·»åŠ æ³›å‹æ–¹æ³•ï¼š
```cpp
template<typename T>
T* PushWidgetToLayerTyped(
    FGameplayTag LayerTag,
    TSubclassOf<T> WidgetClass,
    TFunctionRef<void(T&)> InitFunc = [](T&){})
{
    UGaiaPrimaryGameLayout* Layout = GetPrimaryGameLayout();
    if (!Layout || !WidgetClass)
    {
        return nullptr;
    }
    
    return Layout->PushWidgetToLayerStack<T>(LayerTag, WidgetClass, InitFunc);
}
```

2. ä¿®æ”¹ `ShowContextMenu` ä½¿ç”¨æ–°API

**ä¼˜ç‚¹ï¼š**
- âœ… å®Œå…¨ä½¿ç”¨ CommonUI Layer ç³»ç»Ÿ
- âœ… è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- âœ… Z-Order è‡ªåŠ¨å¤„ç†
- âœ… ESCé”®è‡ªåŠ¨å·¥ä½œ

**ç¼ºç‚¹ï¼š**
- éœ€è¦ä½¿ç”¨Lambdaæ•è·å˜é‡
- ä»£ç ç¨å¤æ‚

---

### æ–¹æ¡ˆ B: åœ¨UMGä¸­åˆå§‹åŒ–

å°†åˆå§‹åŒ–é€»è¾‘ç§»åˆ°Widgetçš„ `NativeOnActivated`ï¼š

```cpp
void UGaiaItemContextMenu::NativeOnActivated()
{
    Super::NativeOnActivated();
    
    // ä»æŸå¤„è·å–æ•°æ®å¹¶åˆå§‹åŒ–
    // éœ€è¦é¢å¤–çš„æ•°æ®ä¼ é€’æœºåˆ¶
}
```

**ç¼ºç‚¹ï¼š**
- éœ€è¦é¢å¤–çš„æ•°æ®ä¼ é€’æœºåˆ¶
- ä¸å¤Ÿç›´è§‚

---

## ğŸ“‹ å½“å‰çŠ¶æ€æ€»ç»“

| æ–¹é¢ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **ç¼–è¯‘** | âœ… é€šè¿‡ | ä½¿ç”¨ä¸´æ—¶æ–¹æ¡ˆ |
| **åŠŸèƒ½** | âš ï¸ åŸºæœ¬å¯ç”¨ | ç»•è¿‡äº†Layerç³»ç»Ÿ |
| **æ¶æ„** | âŒ ä¸ç†æƒ³ | æœªä½¿ç”¨CommonUIæœ€ä½³å®è·µ |
| **æ¨è** | ğŸ”„ éœ€è¦é‡æ„ | åº”ä½¿ç”¨æ–¹æ¡ˆA |

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åšï¼ˆä½¿ç”¨ä¸´æ—¶æ–¹æ¡ˆï¼‰
1. âœ… ç»§ç»­åˆ›å»º UMG è“å›¾
2. âœ… æµ‹è¯•å³é”®èœå•åŸºæœ¬åŠŸèƒ½
3. âœ… éªŒè¯æ˜¾ç¤ºã€ç‚¹å‡»ã€å…³é—­

### åç»­ä¼˜åŒ–ï¼ˆæ¨èï¼‰
1. å®ç° `PushWidgetToLayerTyped` æ³›å‹æ–¹æ³•
2. é‡æ„ `ShowContextMenu` ä½¿ç”¨æ–°æ–¹æ³•
3. ç§»é™¤ `PushWidgetInstanceToLayer` ä¸´æ—¶æ–¹æ¡ˆ
4. æµ‹è¯•éªŒè¯æ‰€æœ‰åŠŸèƒ½

---

## ğŸ’¡ å­¦åˆ°çš„ç»éªŒ

### CommonUI çš„è®¾è®¡ç†å¿µ
- CommonUI å€¾å‘äº**æ§åˆ¶Widgetçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**
- æ¨èåœ¨åˆ›å»ºæ—¶é€šè¿‡å›è°ƒåˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯é¢„åˆ›å»ºåæ·»åŠ 
- Layer ç³»ç»Ÿè®¾è®¡ç”¨äºç®¡ç†ç”±å®ƒåˆ›å»ºçš„Widget

### ä¸ºä»€ä¹ˆæ²¡æœ‰"æ·»åŠ å®ä¾‹"çš„æ–¹æ³•ï¼Ÿ
å› ä¸º CommonUI çš„è®¾è®¡å“²å­¦æ˜¯ï¼š
1. **åˆ›å»ºå’Œç®¡ç†ç»‘å®š**ï¼šLayeråˆ›å»ºWidgetï¼Œå› æ­¤çŸ¥é“å¦‚ä½•ç®¡ç†å®ƒ
2. **ç”Ÿå‘½å‘¨æœŸä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰Widgetéƒ½ç»è¿‡ç›¸åŒçš„æ¿€æ´»æµç¨‹
3. **é¿å…çŠ¶æ€ä¸ä¸€è‡´**ï¼šé¢„åˆ›å»ºçš„Widgetå¯èƒ½å¤„äºæœªçŸ¥çŠ¶æ€

### æ­£ç¡®çš„ä½¿ç”¨æ¨¡å¼
```
åˆ›å»ºè¯·æ±‚ â†’ Layeråˆ›å»ºWidget â†’ å›è°ƒåˆå§‹åŒ– â†’ è‡ªåŠ¨æ¿€æ´»å’Œç®¡ç†
```

è€Œä¸æ˜¯ï¼š
```
æ‰‹åŠ¨åˆ›å»º â†’ æ‰‹åŠ¨åˆå§‹åŒ– â†’ å°è¯•æ·»åŠ åˆ°Layer â†’ âŒ ä¸æ”¯æŒ
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- CommonUI Plugin æºç ï¼š`Engine/Plugins/Experimental/CommonUI/`
- `UPrimaryGameLayout::PushWidgetToLayerStack` æ–¹æ³•
- `UCommonActivatableWidget` ç”Ÿå‘½å‘¨æœŸ

---

**ç»“è®º**ï¼šå½“å‰ä¸´æ—¶æ–¹æ¡ˆå¯ç”¨äºæµ‹è¯•å’Œå¼€å‘ï¼Œä½†å»ºè®®åœ¨å®ŒæˆåŸºæœ¬åŠŸèƒ½éªŒè¯åï¼ŒæŒ‰æ–¹æ¡ˆAè¿›è¡Œé‡æ„ä»¥ç¬¦åˆ CommonUI æœ€ä½³å®è·µã€‚

