# å³é”®èœå•ä½¿ç”¨æŒ‡å—

## ğŸ¯ å‰ç½®æ¡ä»¶

âœ… **å·²å®Œæˆ**ï¼š
- C++ ä»£ç å·²ç¼–è¯‘é€šè¿‡
- æšä¸¾å’Œæ•°æ®ç»“æ„å·²å®šä¹‰
- Widget ç±»å·²åˆ›å»º

â³ **å¾…å®Œæˆ**ï¼ˆæœ¬æŒ‡å—å†…å®¹ï¼‰ï¼š
1. åˆ›å»º UMG è“å›¾
2. ä¿®æ”¹ ItemSlotWidget é›†æˆå³é”®åŠŸèƒ½
3. é…ç½®ç‰©å“çš„èœå•ç±»å‹
4. æµ‹è¯•åŠŸèƒ½

---

## ğŸ“ æ­¥éª¤ 1: åˆ›å»ºèœå•é¡¹æŒ‰é’®è“å›¾

### 1.1 åˆ›å»ºè“å›¾

1. åœ¨ `Content/UI/` ç›®å½•ä¸‹ï¼Œå³é”® â†’ **User Interface** â†’ **Widget Blueprint**
2. å‘½åä¸º `WBP_ContextMenuButton`
3. æ‰“å¼€è“å›¾ï¼Œåœ¨ **Graph** æ ‡ç­¾é¡µï¼Œç‚¹å‡» **File** â†’ **Reparent Blueprint**
4. æœç´¢å¹¶é€‰æ‹© `GaiaContextMenuButton`

### 1.2 è®¾è®¡ UI ç»“æ„

åœ¨ **Designer** æ ‡ç­¾é¡µï¼Œåˆ›å»ºä»¥ä¸‹ç»“æ„ï¼š

```
Root (Canvas Panel)
â””â”€ Horizontal Box
   â”œâ”€ Image: Icon (å‘½åä¸º "Icon")
   â”‚   â””â”€ å¯è§æ€§: Collapsed
   â”‚   â””â”€ å¤§å°: 24x24
   â””â”€ Text Block: Text (å‘½åä¸º "Text")
       â””â”€ å­—ä½“å¤§å°: 14
       â””â”€ é¢œè‰²: ç™½è‰²
```

### 1.3 æ ·å¼è®¾ç½®

**Horizontal Box**ï¼š
- Padding: (10, 5, 10, 5)
- Size: Fill / Auto

**Text Block**ï¼š
- Font Size: 14
- Color: (R=1, G=1, B=1, A=1)
- Auto Wrap Text: False

**æ•´ä½“å¤§å°**ï¼š
- Width: 200
- Height: 40

### 1.4 æŒ‰é’®æ ·å¼ï¼ˆå¯é€‰ï¼‰

åœ¨ **Details** é¢æ¿ï¼Œæ‰¾åˆ° **Style** è®¾ç½®ï¼š

- **Normal**: é€æ˜èƒŒæ™¯
- **Hovered**: 
  - Background Color: (R=0.2, G=0.2, B=0.2, A=0.8)
- **Pressed**: 
  - Background Color: (R=0.1, G=0.1, B=0.1, A=0.9)

ç¼–è¯‘å¹¶ä¿å­˜ã€‚

---

## ğŸ“ æ­¥éª¤ 2: åˆ›å»ºå³é”®èœå•è“å›¾

### 2.1 åˆ›å»ºè“å›¾

1. åœ¨ `Content/UI/` ç›®å½•ä¸‹ï¼Œåˆ›å»ºæ–°çš„ **Widget Blueprint**
2. å‘½åä¸º `WBP_ItemContextMenu`
3. **Reparent** åˆ° `GaiaItemContextMenu`

### 2.2 è®¾è®¡ UI ç»“æ„

```
Root (Canvas Panel)
â””â”€ Border: MenuBackground
   â””â”€ Vertical Box: MenuItemsContainer (å‘½åå¿…é¡»ä¸º "MenuItemsContainer")
```

### 2.3 æ ·å¼è®¾ç½®

**Canvas Panel**ï¼š
- é»˜è®¤å³å¯

**Border (MenuBackground)**ï¼š
- **Appearance**:
  - Background Color: (R=0.05, G=0.05, B=0.05, A=0.95)
  - Brush â†’ Draw As: Rounded Box
  - Brush â†’ Rounding: (4, 4, 4, 4)
- **Padding**: (8, 8, 8, 8)
- **Size**: Auto Ã— Auto

**Vertical Box (MenuItemsContainer)**ï¼š
- ç¡®ä¿å‘½åä¸º `MenuItemsContainer`ï¼ˆä¸ C++ ä»£ç ä¸­çš„ç»‘å®šåŒ¹é…ï¼‰
- Size: Fill Ã— Auto

### 2.4 é…ç½®èœå•é¡¹æŒ‰é’®ç±»

1. é€‰ä¸­ `WBP_ItemContextMenu` çš„æ ¹èŠ‚ç‚¹
2. åœ¨ **Details** é¢æ¿æ‰¾åˆ° **Gaia | UI** åˆ†ç±»
3. è®¾ç½® **Menu Item Button Class** = `WBP_ContextMenuButton`

ç¼–è¯‘å¹¶ä¿å­˜ã€‚

---

## ğŸ“ æ­¥éª¤ 3: ä¿®æ”¹ ItemSlotWidget é›†æˆå³é”®åŠŸèƒ½

### 3.1 æ‰“å¼€ WBP_ItemSlot

1. æ‰¾åˆ°å¹¶æ‰“å¼€ä½ ç°æœ‰çš„ `WBP_ItemSlot` è“å›¾

### 3.2 é…ç½®å³é”®èœå•ç±»

1. é€‰ä¸­æ ¹èŠ‚ç‚¹
2. åœ¨ **Details** é¢æ¿ï¼Œæ‰¾åˆ° **Gaia | UI** åˆ†ç±»
3. è®¾ç½® **Context Menu Class** = `WBP_ItemContextMenu`

### 3.3 æ·»åŠ å³é”®äº‹ä»¶å¤„ç†ï¼ˆC++ æ–¹å¼ï¼‰

éœ€è¦ä¿®æ”¹ `GaiaItemSlotWidget.h` å’Œ `.cpp`ï¼š

**GaiaItemSlotWidget.h** - æ·»åŠ å£°æ˜ï¼š

```cpp
protected:
	/** å³é”®èœå•Widgetç±» */
	UPROPERTY(EditDefaultsOnly, Category = "Gaia|UI")
	TSubclassOf<UGaiaItemContextMenu> ContextMenuClass;

	/**
	 * æ˜¾ç¤ºå³é”®èœå•
	 * @param ScreenPosition å±å¹•ä½ç½®
	 */
	void ShowContextMenu(FVector2D ScreenPosition);

	/**
	 * è·å–ç‰©å“å®šä¹‰
	 * @param OutItemDef è¾“å‡ºçš„ç‰©å“å®šä¹‰
	 * @return æ˜¯å¦æˆåŠŸè·å–
	 */
	bool GetItemDefinition(FGaiaItemDefinition& OutItemDef) const;
```

**GaiaItemSlotWidget.cpp** - ä¿®æ”¹ `NativeOnMouseButtonDown`ï¼š

```cpp
FReply UGaiaItemSlotWidget::NativeOnMouseButtonDown(const FGeometry& InGeometry, const FPointerEvent& InMouseEvent)
{
	// å¤„ç†å³é”®
	if (InMouseEvent.IsMouseButtonDown(EKeys::RightMouseButton) && !SlotInfo.IsEmpty())
	{
		ShowContextMenu(InMouseEvent.GetScreenSpacePosition());
		return FReply::Handled();
	}

	// ç°æœ‰çš„å·¦é”®é€»è¾‘...
	// ... ä¿æŒä¸å˜ ...
	
	return Super::NativeOnMouseButtonDown(InGeometry, InMouseEvent);
}

void UGaiaItemSlotWidget::ShowContextMenu(FVector2D ScreenPosition)
{
	// è·å–ç‰©å“å®šä¹‰
	FGaiaItemDefinition ItemDef;
	if (!GetItemDefinition(ItemDef))
	{
		return;
	}

	// æ£€æŸ¥èœå•ç±»å‹
	if (ItemDef.ContextMenuType == EItemContextMenuType::None)
	{
		return;
	}

	// åˆ›å»ºèœå•Widget
	if (!ContextMenuClass)
	{
		UE_LOG(LogGaia, Warning, TEXT("ContextMenuClass not set in ItemSlotWidget"));
		return;
	}

	UGaiaItemContextMenu* ContextMenu = CreateWidget<UGaiaItemContextMenu>(
		GetOwningPlayer(), ContextMenuClass);

	if (ContextMenu)
	{
		// åˆå§‹åŒ–èœå•
		ContextMenu->InitializeMenu(SlotInfo.ItemInstanceUID, ItemDef);
		ContextMenu->SetMenuPosition(ScreenPosition);

		// æ·»åŠ åˆ°Menu Layer
		if (UGaiaUIManagerSubsystem* UIManager = UGaiaUIManagerSubsystem::Get(this))
		{
			UIManager->PushWidgetToLayer(
				FGameplayTag::RequestGameplayTag(TEXT("UI.Layer.Menu")),
				ContextMenu
			);
		}
	}
}

bool UGaiaItemSlotWidget::GetItemDefinition(FGaiaItemDefinition& OutItemDef) const
{
	if (SlotInfo.IsEmpty())
	{
		return false;
	}

	// ä»åº“å­˜å­ç³»ç»Ÿè·å–ç‰©å“
	UGaiaInventorySubsystem* InvSys = UGaiaInventorySubsystem::Get(this);
	if (!InvSys)
	{
		return false;
	}

	FGaiaItemInstance Item;
	if (!InvSys->FindItemByUID(SlotInfo.ItemInstanceUID, Item))
	{
		return false;
	}

	// è·å–ç‰©å“å®šä¹‰
	return InvSys->GetItemDefinition(Item.ItemDefinitionID, OutItemDef);
}
```

### 3.4 æ·»åŠ å¿…è¦çš„ Include

åœ¨ `GaiaItemSlotWidget.cpp` é¡¶éƒ¨æ·»åŠ ï¼š

```cpp
#include "UI/Inventory/GaiaItemContextMenu.h"
#include "UI/GaiaUIManagerSubsystem.h"
#include "Gameplay/Inventory/GaiaInventorySubsystem.h"
```

---

## ğŸ“ æ­¥éª¤ 4: é…ç½®ç‰©å“çš„èœå•ç±»å‹

### 4.1 æ‰“å¼€ç‰©å“å®šä¹‰è¡¨

1. æ‰¾åˆ°ä½ çš„ ItemDefinition DataTableï¼ˆä¾‹å¦‚ `DT_ItemDefinitions`ï¼‰
2. åŒå‡»æ‰“å¼€

### 4.2 é…ç½®æ¯ä¸ªç‰©å“çš„èœå•ç±»å‹

| ç‰©å“ ID | Context Menu Type | è¯´æ˜ |
|---------|------------------|------|
| TestItem | Material | æ™®é€šææ–™ - æ˜¾ç¤ºï¼šæ‹†åˆ†ã€ä¸¢å¼ƒã€é”€æ¯ |
| TestItem2 | Consumable | æ¶ˆè€—å“ - æ˜¾ç¤ºï¼šä½¿ç”¨ã€ä¸¢å¼ƒã€é”€æ¯ |
| TestItem3 | Container | å®¹å™¨ç‰©å“ - æ˜¾ç¤ºï¼šæ‰“å¼€ã€æ¸…ç©ºã€ä¸¢å¼ƒ |
| QuestKey | Quest Item | ä»»åŠ¡ç‰©å“ - æ˜¾ç¤ºï¼šæŸ¥çœ‹è¯¦æƒ… |

**é‡è¦**ï¼šå¸¦å®¹å™¨çš„ç‰©å“ï¼ˆ`bHasContainer = true`ï¼‰åº”è¯¥è®¾ç½®ä¸º `Container` ç±»å‹ï¼

---

## ğŸ§ª æ­¥éª¤ 5: æµ‹è¯•

### 5.1 ç¼–è¯‘ä»£ç 

```bash
# åœ¨ Unreal Editor ä¸­
Build â†’ Compile [YourProject]
```

### 5.2 å¯åŠ¨æ¸¸æˆ

1. ç‚¹å‡» **Play** å¯åŠ¨ PIE
2. åˆ›å»ºä¸€ä¸ªå®¹å™¨å¹¶æ·»åŠ ç‰©å“ï¼ˆä½¿ç”¨ç°æœ‰çš„æµ‹è¯•ä»£ç ï¼‰

### 5.3 æµ‹è¯•å³é”®èœå•

#### æµ‹è¯• 1: åŸºç¡€æ˜¾ç¤º
1. **å³é”®ç‚¹å‡»ç‰©å“æ§½ä½**
2. âœ… åº”è¯¥å¼¹å‡ºèœå•
3. âœ… èœå•å†…å®¹æ ¹æ®ç‰©å“ç±»å‹æ­£ç¡®æ˜¾ç¤º

#### æµ‹è¯• 2: æ‰“å¼€å®¹å™¨
1. **å³é”®ç‚¹å‡»å®¹å™¨ç±»ç‰©å“**ï¼ˆå¦‚ TestItem3ï¼‰
2. âœ… èœå•æ˜¾ç¤º"æ‰“å¼€"é€‰é¡¹
3. **ç‚¹å‡»"æ‰“å¼€"**
4. âœ… å®¹å™¨çª—å£æ‰“å¼€
5. âœ… æ—¥å¿—è¾“å‡ºï¼š
   ```
   LogGaia: Opening container from item: [ItemUID], container: [ContainerUID]
   ```

#### æµ‹è¯• 3: å…¶ä»–æ“ä½œ
1. **ç‚¹å‡»å…¶ä»–èœå•é¡¹**ï¼ˆä½¿ç”¨ã€ä¸¢å¼ƒç­‰ï¼‰
2. âœ… æ—¥å¿—è¾“å‡ºå¯¹åº”æ“ä½œ
3. âœ… èœå•å…³é—­

#### æµ‹è¯• 4: å…³é—­èœå•
1. **ç‚¹å‡»èœå•å¤–çš„åŒºåŸŸ**
2. âœ… èœå•å…³é—­
3. **æŒ‰ ESC é”®**
4. âœ… èœå•å…³é—­

#### æµ‹è¯• 5: ç©ºæ§½ä½
1. **å³é”®ç‚¹å‡»ç©ºæ§½ä½**
2. âœ… æ— ååº”ï¼ˆä¸æ˜¾ç¤ºèœå•ï¼‰

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: å³é”®ç‚¹å‡»æ— ååº”

**åŸå› **ï¼š
- ItemSlotWidget æ²¡æœ‰æ­£ç¡®é›†æˆå³é”®å¤„ç†ä»£ç 
- ContextMenuClass æœªè®¾ç½®

**è§£å†³**ï¼š
1. æ£€æŸ¥ `NativeOnMouseButtonDown` æ˜¯å¦æ­£ç¡®ä¿®æ”¹
2. åœ¨ WBP_ItemSlot ä¸­è®¾ç½® Context Menu Class

### é—®é¢˜ 2: èœå•é¡¹ä¸æ˜¾ç¤º

**åŸå› **ï¼š
- MenuItemsContainer å‘½åä¸æ­£ç¡®
- Menu Item Button Class æœªè®¾ç½®

**è§£å†³**ï¼š
1. ç¡®ä¿ Vertical Box å‘½åä¸º `MenuItemsContainer`
2. åœ¨ WBP_ItemContextMenu ä¸­è®¾ç½® Menu Item Button Class

### é—®é¢˜ 3: ç‚¹å‡»èœå•é¡¹æ— ååº”

**åŸå› **ï¼š
- å§”æ‰˜ç»‘å®šå¤±è´¥
- HandleButtonClicked æœªæ­£ç¡®é‡å†™

**è§£å†³**ï¼š
1. æ£€æŸ¥ç¼–è¯‘æ˜¯å¦æˆåŠŸ
2. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### é—®é¢˜ 4: èœå•ä¸å…³é—­

**åŸå› **ï¼š
- CommonUI Layer é…ç½®é—®é¢˜
- è¾“å…¥æ¨¡å¼è®¾ç½®é—®é¢˜

**è§£å†³**ï¼š
1. ç¡®ä¿èœå•æ·»åŠ åˆ° Menu Layer
2. æ£€æŸ¥ NativeOnActivated ä¸­çš„è¾“å…¥æ¨¡å¼è®¾ç½®

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨æµ‹è¯•å‰ï¼Œç¡®ä¿ï¼š

- [ ] WBP_ContextMenuButton å·²åˆ›å»ºå¹¶é…ç½®
- [ ] WBP_ItemContextMenu å·²åˆ›å»ºå¹¶é…ç½®
- [ ] MenuItemsContainer å‘½åæ­£ç¡®
- [ ] Menu Item Button Class å·²è®¾ç½®
- [ ] GaiaItemSlotWidget ä»£ç å·²ä¿®æ”¹
- [ ] WBP_ItemSlot ä¸­ Context Menu Class å·²è®¾ç½®
- [ ] ç‰©å“å®šä¹‰è¡¨ä¸­é…ç½®äº† Context Menu Type
- [ ] ä»£ç ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

---

## ğŸ¨ å¯é€‰ä¼˜åŒ–

### 1. æ·»åŠ èœå•åŠ¨ç”»

åœ¨ WBP_ItemContextMenu ä¸­ï¼š
1. åˆ›å»ºåŠ¨ç”»ï¼šæ·¡å…¥æ•ˆæœ
2. åœ¨ Event Construct ä¸­æ’­æ”¾åŠ¨ç”»

### 2. æ™ºèƒ½å®šä½

ä¿®æ”¹ `SetMenuPosition` å®ç°ï¼š
```cpp
void UGaiaItemContextMenu::SetMenuPosition(FVector2D ScreenPosition)
{
    // è·å–å±å¹•å¤§å°
    FVector2D ViewportSize;
    if (GEngine && GEngine->GameViewport)
    {
        GEngine->GameViewport->GetViewportSize(ViewportSize);
    }

    // è·å–èœå•å¤§å°
    FVector2D MenuSize = GetDesiredSize();

    // è°ƒæ•´ä½ç½®é¿å…è¶…å‡ºå±å¹•
    FVector2D AdjustedPosition = ScreenPosition;
    if (ScreenPosition.X + MenuSize.X > ViewportSize.X)
    {
        AdjustedPosition.X = ViewportSize.X - MenuSize.X;
    }
    if (ScreenPosition.Y + MenuSize.Y > ViewportSize.Y)
    {
        AdjustedPosition.Y = ViewportSize.Y - MenuSize.Y;
    }

    // è®¾ç½®ä½ç½®ï¼ˆéœ€è¦åœ¨ UMG ä¸­ä½¿ç”¨ Canvas Panel Slotï¼‰
    if (UCanvasPanelSlot* CanvasSlot = Cast<UCanvasPanelSlot>(Slot))
    {
        CanvasSlot->SetPosition(AdjustedPosition);
    }
}
```

### 3. æ·»åŠ éŸ³æ•ˆ

åœ¨ HandleButtonClicked ä¸­ï¼š
```cpp
void UGaiaContextMenuButton::HandleButtonClicked()
{
    Super::HandleButtonClicked();
    
    // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
    // PlaySound(ClickSound);
    
    OnMenuButtonClicked.Broadcast(this);
}
```

### 4. æ·»åŠ å¿«æ·é”®

åœ¨ WBP_ItemContextMenu ä¸­æ·»åŠ è¾“å…¥å¤„ç†ï¼Œæ”¯æŒæ•°å­—é”®å¿«é€Ÿé€‰æ‹©ã€‚

---

## ğŸ¯ ä¸‹ä¸€æ­¥

å®ŒæˆåŸºç¡€åŠŸèƒ½æµ‹è¯•åï¼Œå¯ä»¥ï¼š

1. **å®ç°æ›´å¤šæ“ä½œ**ï¼š
   - ä¸¢å¼ƒç‰©å“ï¼ˆéœ€è¦ä¸–ç•Œ Actor ç”Ÿæˆï¼‰
   - é”€æ¯ç‰©å“ï¼ˆéœ€è¦ç¡®è®¤å¯¹è¯æ¡†ï¼‰
   - æ‹†åˆ†ç‰©å“ï¼ˆéœ€è¦æ•°é‡è¾“å…¥å¯¹è¯æ¡†ï¼‰

2. **ä¼˜åŒ–ä½“éªŒ**ï¼š
   - æ·»åŠ èœå•åŠ¨ç”»
   - æ™ºèƒ½å®šä½
   - éŸ³æ•ˆåé¦ˆ

3. **æ‰©å±•åŠŸèƒ½**ï¼š
   - ä½¿ç”¨ç‰©å“ç³»ç»Ÿ
   - è£…å¤‡ç³»ç»Ÿé›†æˆ
   - è‡ªå®šä¹‰èœå•é¡¹

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼** ğŸš€

å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—è¾“å‡ºæˆ–å‚è€ƒï¼š
- [å³é”®èœå•ç³»ç»Ÿè®¾è®¡.md](å³é”®èœå•ç³»ç»Ÿè®¾è®¡.md)
- [Phase1å®Œæˆæ€»ç»“.md](Phase1å®Œæˆæ€»ç»“.md)

