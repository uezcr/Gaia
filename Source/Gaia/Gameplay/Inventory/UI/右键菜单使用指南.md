# 右键菜单使用指南

## 🎯 前置条件

✅ **已完成**：
- C++ 代码已编译通过
- 枚举和数据结构已定义
- Widget 类已创建

⏳ **待完成**（本指南内容）：
1. 创建 UMG 蓝图
2. 修改 ItemSlotWidget 集成右键功能
3. 配置物品的菜单类型
4. 测试功能

---

## 📝 步骤 1: 创建菜单项按钮蓝图

### 1.1 创建蓝图

1. 在 `Content/UI/` 目录下，右键 → **User Interface** → **Widget Blueprint**
2. 命名为 `WBP_ContextMenuButton`
3. 打开蓝图，在 **Graph** 标签页，点击 **File** → **Reparent Blueprint**
4. 搜索并选择 `GaiaContextMenuButton`

### 1.2 设计 UI 结构

在 **Designer** 标签页，创建以下结构：

```
Root (Canvas Panel)
└─ Horizontal Box
   ├─ Image: Icon (命名为 "Icon")
   │   └─ 可见性: Collapsed
   │   └─ 大小: 24x24
   └─ Text Block: Text (命名为 "Text")
       └─ 字体大小: 14
       └─ 颜色: 白色
```

### 1.3 样式设置

**Horizontal Box**：
- Padding: (10, 5, 10, 5)
- Size: Fill / Auto

**Text Block**：
- Font Size: 14
- Color: (R=1, G=1, B=1, A=1)
- Auto Wrap Text: False

**整体大小**：
- Width: 200
- Height: 40

### 1.4 按钮样式（可选）

在 **Details** 面板，找到 **Style** 设置：

- **Normal**: 透明背景
- **Hovered**: 
  - Background Color: (R=0.2, G=0.2, B=0.2, A=0.8)
- **Pressed**: 
  - Background Color: (R=0.1, G=0.1, B=0.1, A=0.9)

编译并保存。

---

## 📝 步骤 2: 创建右键菜单蓝图

### 2.1 创建蓝图

1. 在 `Content/UI/` 目录下，创建新的 **Widget Blueprint**
2. 命名为 `WBP_ItemContextMenu`
3. **Reparent** 到 `GaiaItemContextMenu`

### 2.2 设计 UI 结构

```
Root (Canvas Panel)
└─ Border: MenuBackground
   └─ Vertical Box: MenuItemsContainer (命名必须为 "MenuItemsContainer")
```

### 2.3 样式设置

**Canvas Panel**：
- 默认即可

**Border (MenuBackground)**：
- **Appearance**:
  - Background Color: (R=0.05, G=0.05, B=0.05, A=0.95)
  - Brush → Draw As: Rounded Box
  - Brush → Rounding: (4, 4, 4, 4)
- **Padding**: (8, 8, 8, 8)
- **Size**: Auto × Auto

**Vertical Box (MenuItemsContainer)**：
- 确保命名为 `MenuItemsContainer`（与 C++ 代码中的绑定匹配）
- Size: Fill × Auto

### 2.4 配置菜单项按钮类

1. 选中 `WBP_ItemContextMenu` 的根节点
2. 在 **Details** 面板找到 **Gaia | UI** 分类
3. 设置 **Menu Item Button Class** = `WBP_ContextMenuButton`

编译并保存。

---

## 📝 步骤 3: 修改 ItemSlotWidget 集成右键功能

### 3.1 打开 WBP_ItemSlot

1. 找到并打开你现有的 `WBP_ItemSlot` 蓝图

### 3.2 配置右键菜单类

1. 选中根节点
2. 在 **Details** 面板，找到 **Gaia | UI** 分类
3. 设置 **Context Menu Class** = `WBP_ItemContextMenu`

### 3.3 添加右键事件处理（C++ 方式）

需要修改 `GaiaItemSlotWidget.h` 和 `.cpp`：

**GaiaItemSlotWidget.h** - 添加声明：

```cpp
protected:
	/** 右键菜单Widget类 */
	UPROPERTY(EditDefaultsOnly, Category = "Gaia|UI")
	TSubclassOf<UGaiaItemContextMenu> ContextMenuClass;

	/**
	 * 显示右键菜单
	 * @param ScreenPosition 屏幕位置
	 */
	void ShowContextMenu(FVector2D ScreenPosition);

	/**
	 * 获取物品定义
	 * @param OutItemDef 输出的物品定义
	 * @return 是否成功获取
	 */
	bool GetItemDefinition(FGaiaItemDefinition& OutItemDef) const;
```

**GaiaItemSlotWidget.cpp** - 修改 `NativeOnMouseButtonDown`：

```cpp
FReply UGaiaItemSlotWidget::NativeOnMouseButtonDown(const FGeometry& InGeometry, const FPointerEvent& InMouseEvent)
{
	// 处理右键
	if (InMouseEvent.IsMouseButtonDown(EKeys::RightMouseButton) && !SlotInfo.IsEmpty())
	{
		ShowContextMenu(InMouseEvent.GetScreenSpacePosition());
		return FReply::Handled();
	}

	// 现有的左键逻辑...
	// ... 保持不变 ...
	
	return Super::NativeOnMouseButtonDown(InGeometry, InMouseEvent);
}

void UGaiaItemSlotWidget::ShowContextMenu(FVector2D ScreenPosition)
{
	// 获取物品定义
	FGaiaItemDefinition ItemDef;
	if (!GetItemDefinition(ItemDef))
	{
		return;
	}

	// 检查菜单类型
	if (ItemDef.ContextMenuType == EItemContextMenuType::None)
	{
		return;
	}

	// 创建菜单Widget
	if (!ContextMenuClass)
	{
		UE_LOG(LogGaia, Warning, TEXT("ContextMenuClass not set in ItemSlotWidget"));
		return;
	}

	UGaiaItemContextMenu* ContextMenu = CreateWidget<UGaiaItemContextMenu>(
		GetOwningPlayer(), ContextMenuClass);

	if (ContextMenu)
	{
		// 初始化菜单
		ContextMenu->InitializeMenu(SlotInfo.ItemInstanceUID, ItemDef);
		ContextMenu->SetMenuPosition(ScreenPosition);

		// 添加到Menu Layer
		if (UGaiaUIManagerSubsystem* UIManager = UGaiaUIManagerSubsystem::Get(this))
		{
			UIManager->PushWidgetToLayer(
				FGameplayTag::RequestGameplayTag(TEXT("UI.Layer.Menu")),
				ContextMenu
			);
		}
	}
}

bool UGaiaItemSlotWidget::GetItemDefinition(FGaiaItemDefinition& OutItemDef) const
{
	if (SlotInfo.IsEmpty())
	{
		return false;
	}

	// 从库存子系统获取物品
	UGaiaInventorySubsystem* InvSys = UGaiaInventorySubsystem::Get(this);
	if (!InvSys)
	{
		return false;
	}

	FGaiaItemInstance Item;
	if (!InvSys->FindItemByUID(SlotInfo.ItemInstanceUID, Item))
	{
		return false;
	}

	// 获取物品定义
	return InvSys->GetItemDefinition(Item.ItemDefinitionID, OutItemDef);
}
```

### 3.4 添加必要的 Include

在 `GaiaItemSlotWidget.cpp` 顶部添加：

```cpp
#include "UI/Inventory/GaiaItemContextMenu.h"
#include "UI/GaiaUIManagerSubsystem.h"
#include "Gameplay/Inventory/GaiaInventorySubsystem.h"
```

---

## 📝 步骤 4: 配置物品的菜单类型

### 4.1 打开物品定义表

1. 找到你的 ItemDefinition DataTable（例如 `DT_ItemDefinitions`）
2. 双击打开

### 4.2 配置每个物品的菜单类型

| 物品 ID | Context Menu Type | 说明 |
|---------|------------------|------|
| TestItem | Material | 普通材料 - 显示：拆分、丢弃、销毁 |
| TestItem2 | Consumable | 消耗品 - 显示：使用、丢弃、销毁 |
| TestItem3 | Container | 容器物品 - 显示：打开、清空、丢弃 |
| QuestKey | Quest Item | 任务物品 - 显示：查看详情 |

**重要**：带容器的物品（`bHasContainer = true`）应该设置为 `Container` 类型！

---

## 🧪 步骤 5: 测试

### 5.1 编译代码

```bash
# 在 Unreal Editor 中
Build → Compile [YourProject]
```

### 5.2 启动游戏

1. 点击 **Play** 启动 PIE
2. 创建一个容器并添加物品（使用现有的测试代码）

### 5.3 测试右键菜单

#### 测试 1: 基础显示
1. **右键点击物品槽位**
2. ✅ 应该弹出菜单
3. ✅ 菜单内容根据物品类型正确显示

#### 测试 2: 打开容器
1. **右键点击容器类物品**（如 TestItem3）
2. ✅ 菜单显示"打开"选项
3. **点击"打开"**
4. ✅ 容器窗口打开
5. ✅ 日志输出：
   ```
   LogGaia: Opening container from item: [ItemUID], container: [ContainerUID]
   ```

#### 测试 3: 其他操作
1. **点击其他菜单项**（使用、丢弃等）
2. ✅ 日志输出对应操作
3. ✅ 菜单关闭

#### 测试 4: 关闭菜单
1. **点击菜单外的区域**
2. ✅ 菜单关闭
3. **按 ESC 键**
4. ✅ 菜单关闭

#### 测试 5: 空槽位
1. **右键点击空槽位**
2. ✅ 无反应（不显示菜单）

---

## 🐛 常见问题

### 问题 1: 右键点击无反应

**原因**：
- ItemSlotWidget 没有正确集成右键处理代码
- ContextMenuClass 未设置

**解决**：
1. 检查 `NativeOnMouseButtonDown` 是否正确修改
2. 在 WBP_ItemSlot 中设置 Context Menu Class

### 问题 2: 菜单项不显示

**原因**：
- MenuItemsContainer 命名不正确
- Menu Item Button Class 未设置

**解决**：
1. 确保 Vertical Box 命名为 `MenuItemsContainer`
2. 在 WBP_ItemContextMenu 中设置 Menu Item Button Class

### 问题 3: 点击菜单项无反应

**原因**：
- 委托绑定失败
- HandleButtonClicked 未正确重写

**解决**：
1. 检查编译是否成功
2. 查看日志是否有错误信息

### 问题 4: 菜单不关闭

**原因**：
- CommonUI Layer 配置问题
- 输入模式设置问题

**解决**：
1. 确保菜单添加到 Menu Layer
2. 检查 NativeOnActivated 中的输入模式设置

---

## 📋 检查清单

在测试前，确保：

- [ ] WBP_ContextMenuButton 已创建并配置
- [ ] WBP_ItemContextMenu 已创建并配置
- [ ] MenuItemsContainer 命名正确
- [ ] Menu Item Button Class 已设置
- [ ] GaiaItemSlotWidget 代码已修改
- [ ] WBP_ItemSlot 中 Context Menu Class 已设置
- [ ] 物品定义表中配置了 Context Menu Type
- [ ] 代码编译成功，无错误

---

## 🎨 可选优化

### 1. 添加菜单动画

在 WBP_ItemContextMenu 中：
1. 创建动画：淡入效果
2. 在 Event Construct 中播放动画

### 2. 智能定位

修改 `SetMenuPosition` 实现：
```cpp
void UGaiaItemContextMenu::SetMenuPosition(FVector2D ScreenPosition)
{
    // 获取屏幕大小
    FVector2D ViewportSize;
    if (GEngine && GEngine->GameViewport)
    {
        GEngine->GameViewport->GetViewportSize(ViewportSize);
    }

    // 获取菜单大小
    FVector2D MenuSize = GetDesiredSize();

    // 调整位置避免超出屏幕
    FVector2D AdjustedPosition = ScreenPosition;
    if (ScreenPosition.X + MenuSize.X > ViewportSize.X)
    {
        AdjustedPosition.X = ViewportSize.X - MenuSize.X;
    }
    if (ScreenPosition.Y + MenuSize.Y > ViewportSize.Y)
    {
        AdjustedPosition.Y = ViewportSize.Y - MenuSize.Y;
    }

    // 设置位置（需要在 UMG 中使用 Canvas Panel Slot）
    if (UCanvasPanelSlot* CanvasSlot = Cast<UCanvasPanelSlot>(Slot))
    {
        CanvasSlot->SetPosition(AdjustedPosition);
    }
}
```

### 3. 添加音效

在 HandleButtonClicked 中：
```cpp
void UGaiaContextMenuButton::HandleButtonClicked()
{
    Super::HandleButtonClicked();
    
    // 播放点击音效
    // PlaySound(ClickSound);
    
    OnMenuButtonClicked.Broadcast(this);
}
```

### 4. 添加快捷键

在 WBP_ItemContextMenu 中添加输入处理，支持数字键快速选择。

---

## 🎯 下一步

完成基础功能测试后，可以：

1. **实现更多操作**：
   - 丢弃物品（需要世界 Actor 生成）
   - 销毁物品（需要确认对话框）
   - 拆分物品（需要数量输入对话框）

2. **优化体验**：
   - 添加菜单动画
   - 智能定位
   - 音效反馈

3. **扩展功能**：
   - 使用物品系统
   - 装备系统集成
   - 自定义菜单项

---

**祝测试顺利！** 🚀

如有问题，查看日志输出或参考：
- [右键菜单系统设计.md](右键菜单系统设计.md)
- [Phase1完成总结.md](Phase1完成总结.md)

