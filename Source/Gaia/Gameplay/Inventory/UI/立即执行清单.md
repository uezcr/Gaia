# ç«‹å³æ‰§è¡Œæ¸…å•

> åŸºäºCommonUIæºç åˆ†æåçš„å…³é”®ä¿®å¤

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**RootViewportLayouts ä¸ºç©ºçš„æ ¹æœ¬åŸå› ï¼š**

Epicçš„CommonUIè®¾è®¡ä¸­ï¼Œ`LayoutClass` æ˜¯ `UGameUIPolicy` çš„ä¸€ä¸ª **è“å›¾å¯ç¼–è¾‘å±æ€§**ï¼ˆ`UPROPERTY(EditAnywhere)`ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè™šå‡½æ•°ï¼

```cpp
// GameUIPolicy.h (Epicæºç )
UCLASS(MinimalAPI, Abstract, Blueprintable, Within = GameUIManagerSubsystem)
class UGameUIPolicy : public UObject
{
private:
    UPROPERTY(EditAnywhere)  // â­ è“å›¾å±æ€§ï¼Œä¸æ˜¯è™šå‡½æ•°ï¼
    TSoftClassPtr<UPrimaryGameLayout> LayoutClass;
    
    // è¿™åªæ˜¯è¯»å–ä¸Šé¢çš„å±æ€§ï¼Œä¸éœ€è¦è¦†ç›–ï¼
    TSubclassOf<UPrimaryGameLayout> GetLayoutWidgetClass(UCommonLocalPlayer* LocalPlayer);
};
```

**å¦‚æœ `LayoutClass` æœªè®¾ç½®ï¼š**
- `GetLayoutWidgetClass()` è¿”å› null
- `CreateLayoutWidget()` ä¸­çš„ `ensure()` å¤±è´¥
- ä¸ä¼šåˆ›å»º `PrimaryGameLayout`
- `RootViewportLayouts` ä¿æŒä¸ºç©º

---

## âœ… æˆ‘å·²ç»ä¿®å¤çš„é—®é¢˜

### 1. é…ç½®Sectioné”™è¯¯

```ini
# ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
[/Script/GaiaGame.GaiaUIManagerSubsystem]
DefaultUIPolicyClass=/Game/UI/BP_GaiaUIPolicy.BP_GaiaUIPolicy_C

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
[/Script/CommonGame.GameUIManagerSubsystem]  â­ å¿…é¡»æ˜¯çˆ¶ç±»çš„section
DefaultUIPolicyClass=/Game/UI/BP_GaiaUIPolicy.BP_GaiaUIPolicy_C
```

**åŸå› ï¼š** `UGameUIManagerSubsystem::Initialize()` è¯»å–é…ç½®æ—¶ä½¿ç”¨è‡ªå·±çš„ç±»åï¼Œä¸æ˜¯å­ç±»çš„ç±»åã€‚

### 2. æ·»åŠ  ShouldCreateSubsystem è¦†ç›–

```cpp
// GaiaUIManagerSubsystem.cpp
bool UGaiaUIManagerSubsystem::ShouldCreateSubsystem(UObject* Outer) const
{
    if (UGameInstance* GameInstance = Cast<UGameInstance>(Outer))
    {
        return !GameInstance->IsDedicatedServerInstance();
    }
    return false;
}
```

---

## âš ï¸ ä½ ç°åœ¨å¿…é¡»åšçš„äº‹

### æ­¥éª¤1ï¼šæ£€æŸ¥ GameMode çš„ PlayerController è®¾ç½® â­â­â­â­â­

**è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼ä½ è¯´ PlayerController ä¸º nullï¼**

1. æ‰“å¼€ `Content/Test/TestLevel`
2. å·¥å…·æ  â†’ **Settings** â†’ **World Settings**
3. **Game Mode Override** â†’ æ‰“å¼€å¯¹åº”çš„ GameMode
4. **Player Controller Class** â†’ è®¾ç½®ä¸º `PlayerController` æˆ– `GaiaPlayerController`
5. **ç¼–è¯‘å¹¶ä¿å­˜**

è¯¦è§ï¼š`å¿«é€Ÿä¿®å¤-PlayerControllerä¸ºnull.md`

---

### æ­¥éª¤2ï¼šé‡æ–°ç¼–è¯‘C++ â­â­â­

æˆ‘ä¿®æ”¹äº† `GaiaUIPolicy.h/.cpp`ã€`GaiaUIManagerSubsystem.cpp` å’Œ `DefaultGame.ini`

1. å…³é—­UEç¼–è¾‘å™¨
2. åœ¨VS/Riderä¸­ç¼–è¯‘é¡¹ç›®
3. é‡æ–°æ‰“å¼€UEç¼–è¾‘å™¨

---

### æ­¥éª¤3ï¼šé…ç½® BP_GaiaUIPolicy â­â­â­â­â­

**è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼**

1. æ‰“å¼€ `Content/UI/BP_GaiaUIPolicy`

2. **Class Defaults** æˆ– **Details** é¢æ¿

3. æ‰¾åˆ° **Layout Class** å±æ€§
   - å¯èƒ½åœ¨ "Game UI Policy" åˆ†ç±»ä¸‹
   - å¯èƒ½åœ¨ "Config" åˆ†ç±»ä¸‹
   - ç±»å‹æ˜¯ `TSoftClassPtr<UPrimaryGameLayout>`

4. è®¾ç½®ä¸ºï¼š**WBP_GaiaPrimaryGameLayout**

5. **ç¼–è¯‘å¹¶ä¿å­˜** â­

---

### æ­¥éª¤4ï¼šéªŒè¯ WBP_GaiaPrimaryGameLayout

æ‰“å¼€ `Content/UI/WBP_GaiaPrimaryGameLayout`

**ç¡®è®¤Widget Hierarchyï¼š**
```
Canvas Panel (Root)
â”œâ”€â”€ GameLayer (CommonActivatableWidgetStack) âœ… Is Variable
â”œâ”€â”€ ContainerLayer (CommonActivatableWidgetStack) âœ… Is Variable
â”œâ”€â”€ MenuLayer (CommonActivatableWidgetStack) âœ… Is Variable
â””â”€â”€ ModalLayer (CommonActivatableWidgetStack) âœ… Is Variable
```

**ç¡®è®¤æ¯ä¸ªStackéƒ½å‹¾é€‰äº† "Is Variable"ï¼**

---

### æ­¥éª¤5ï¼šé‡å¯ç¼–è¾‘å™¨

é…ç½®ä¿®æ”¹åå¿…é¡»å®Œå…¨é‡å¯ï¼

---

### æ­¥éª¤6ï¼šæµ‹è¯•å¹¶æ£€æŸ¥æ—¥å¿—

è¿è¡ŒPIEï¼ŒæŸ¥çœ‹è¾“å‡ºæ—¥å¿—ï¼š

#### âœ… æˆåŠŸçš„æ—¥å¿—åº”è¯¥æ˜¯ï¼š

```
LogGaia: Log: [Gaia UIç®¡ç†å™¨] åˆå§‹åŒ–
LogGaia: Log: [Gaia UIç®¡ç†å™¨] âœ… UIPolicyå·²åˆ›å»º: BP_GaiaUIPolicy_C_0

LogCommonGame: Log: AddLocalPlayer: Set GaiaLocalPlayer_0 to Primary Player

LogGaia: Log: [UI Policy] CreateLayoutWidget è¢«è°ƒç”¨: Player=GaiaLocalPlayer_0
LogGaia: Log: [UI Policy] âœ… PlayerControllerå­˜åœ¨: PlayerController_0ï¼Œç»§ç»­åˆ›å»ºLayout

LogCommonGame: Log: [BP_GaiaUIPolicy_C] is adding player [GaiaLocalPlayer_0]'s root layout [WBP_GaiaPrimaryGameLayout_C_0] to the viewport
LogGaia: Log: [UI Policy] âœ… ç©å®¶å¸ƒå±€å·²æ·»åŠ åˆ°Viewport: Player=GaiaLocalPlayer_0, Layout=WBP_GaiaPrimaryGameLayout_C_0
```

#### âŒ å¦‚æœçœ‹åˆ° "PlayerControllerä¸ºnull" é”™è¯¯ï¼š

```
LogGaia: Error: [UI Policy] âŒ PlayerControllerä¸ºnullï¼
```

**â†’ è¿”å›æ­¥éª¤1ï¼Œæ£€æŸ¥ GameMode çš„ PlayerControllerClass é…ç½®ï¼**

è¯¦è§ï¼š`å¿«é€Ÿä¿®å¤-PlayerControllerä¸ºnull.md`

#### âŒ å¦‚æœçœ‹åˆ°å…¶ä»–é”™è¯¯ï¼š

ä½¿ç”¨è¯Šæ–­å·¥å…·ï¼ˆè§ `UIè¯Šæ–­å·¥å…·.md`ï¼‰ï¼ŒæŠŠå®Œæ•´çš„è¯Šæ–­æ—¥å¿—å‘ç»™æˆ‘ã€‚

---

## ğŸ“– å…³é”®çŸ¥è¯†ç‚¹

### Epicçš„CommonUIè®¾è®¡å“²å­¦

#### 1. é…ç½®å±äºçˆ¶ç±»ï¼Œä¸æ˜¯å­ç±»

```ini
# çˆ¶ç±»çš„å±æ€§ï¼ˆDefaultUIPolicyClassï¼‰å¿…é¡»æ”¾åœ¨çˆ¶ç±»çš„sectionä¸‹
[/Script/CommonGame.GameUIManagerSubsystem]
DefaultUIPolicyClass=/Game/UI/BP_GaiaUIPolicy.BP_GaiaUIPolicy_C

# å­ç±»è‡ªå·±çš„å±æ€§æ‰æ”¾åœ¨å­ç±»çš„sectionä¸‹
[/Script/GaiaGame.GaiaUIManagerSubsystem]
ContainerWindowClass=/Game/UI/WBP_ContainerWindow.WBP_ContainerWindow_C
```

#### 2. é…ç½®é©±åŠ¨ > ä»£ç è¦†ç›–

- `LayoutClass` æ˜¯è“å›¾å±æ€§ï¼Œåœ¨è“å›¾ä¸­è®¾ç½®
- ä¸æ˜¯è™šå‡½æ•°ï¼Œä¸éœ€è¦åœ¨C++ä¸­è¦†ç›–

#### 3. å®Œæ•´çš„åˆå§‹åŒ–é“¾è·¯

```
å¼•æ“å¯åŠ¨
  â†“
åˆ›å»º GameInstance
  â†“
UGameUIManagerSubsystem::Initialize()
  â””â”€â”€ è¯»å– DefaultUIPolicyClass é…ç½®
  â””â”€â”€ åˆ›å»º UIPolicy å¯¹è±¡
  â†“
UCommonGameInstance::AddLocalPlayer()  â­ å¿…é¡»æ˜¯ CommonGameInstance
  â†“
UGameUIManagerSubsystem::NotifyPlayerAdded()
  â†“
UGameUIPolicy::NotifyPlayerAdded()
  â†“
UGameUIPolicy::CreateLayoutWidget()
  â””â”€â”€ è°ƒç”¨ GetLayoutWidgetClass()
      â””â”€â”€ è¯»å–è“å›¾å±æ€§ LayoutClass  â­ å¿…é¡»åœ¨BPä¸­è®¾ç½®
  â””â”€â”€ CreateWidget<UPrimaryGameLayout>()
  â””â”€â”€ æ·»åŠ åˆ° RootViewportLayouts æ•°ç»„
  â””â”€â”€ AddToPlayerScreen()
```

**å¦‚æœ `LayoutClass` æœªè®¾ç½® â†’ RootViewportLayouts ä¸ºç©ºï¼**

---

## ğŸ” å¦‚ä½•æ£€æŸ¥ LayoutClass æ˜¯å¦è®¾ç½®

### æ–¹æ³•1ï¼šåœ¨è“å›¾ç¼–è¾‘å™¨ä¸­æ£€æŸ¥

1. æ‰“å¼€ `BP_GaiaUIPolicy`
2. Window â†’ Class Defaultsï¼ˆæˆ–ç‚¹å‡»å·¥å…·æ çš„"Class Defaults"æŒ‰é’®ï¼‰
3. åœ¨Detailsé¢æ¿ä¸­æœç´¢ "Layout"
4. æŸ¥çœ‹ **Layout Class** æ˜¯å¦æœ‰å€¼

### æ–¹æ³•2ï¼šæŸ¥çœ‹ .uasset æ–‡ä»¶ï¼ˆé«˜çº§ï¼‰

å¦‚æœè“å›¾æŸåæˆ–æ— æ³•æ‰“å¼€ï¼Œå¯ä»¥å°è¯•åœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­æ‰“å¼€ `.uasset` æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶+æ–‡æœ¬æ··åˆæ ¼å¼ï¼‰ï¼Œæœç´¢ "LayoutClass"ã€‚

### æ–¹æ³•3ï¼šä½¿ç”¨è¯Šæ–­ä»£ç 

åœ¨C++ä¸­æ·»åŠ è°ƒè¯•ä»£ç ï¼š

```cpp
void AYourActor::BeginPlay()
{
    Super::BeginPlay();
    
    UGameUIManagerSubsystem* UIManager = GetGameInstance()->GetSubsystem<UGameUIManagerSubsystem>();
    if (UIManager)
    {
        UGameUIPolicy* Policy = UIManager->GetCurrentUIPolicy();
        if (Policy)
        {
            // å°è¯•è·å–Layout
            UPrimaryGameLayout* Layout = UPrimaryGameLayout::GetPrimaryGameLayoutForPrimaryPlayer(this);
            if (!Layout)
            {
                UE_LOG(LogTemp, Error, TEXT("âŒ Layoutä¸ºnullï¼æ£€æŸ¥BP_GaiaUIPolicyçš„LayoutClassæ˜¯å¦è®¾ç½®ï¼"));
            }
            else
            {
                UE_LOG(LogTemp, Log, TEXT("âœ… Layoutå·²åˆ›å»º: %s"), *Layout->GetClass()->GetName());
            }
        }
    }
}
```

---

## ğŸ“‹ æœ€ç»ˆæ£€æŸ¥æ¸…å•

- [ ] âœ… å·²ä¿®å¤ `Config/DefaultGame.ini` çš„sectionï¼ˆæˆ‘å·²å®Œæˆï¼‰
- [ ] âœ… å·²æ·»åŠ  `ShouldCreateSubsystem` è¦†ç›–ï¼ˆæˆ‘å·²å®Œæˆï¼‰
- [ ] âš ï¸ å·²é‡æ–°ç¼–è¯‘C++ä»£ç ï¼ˆä½ éœ€è¦åšï¼‰
- [ ] âš ï¸ å·²è®¾ç½® `BP_GaiaUIPolicy` çš„ `Layout Class` å±æ€§ï¼ˆä½ éœ€è¦åšï¼‰
- [ ] âš ï¸ å·²éªŒè¯ `WBP_GaiaPrimaryGameLayout` çš„4ä¸ªLayer Stacksï¼ˆä½ éœ€è¦åšï¼‰
- [ ] âš ï¸ å·²é‡å¯ç¼–è¾‘å™¨ï¼ˆä½ éœ€è¦åšï¼‰
- [ ] âš ï¸ æµ‹è¯•å¹¶æŸ¥çœ‹æ—¥å¿—ï¼ˆä½ éœ€è¦åšï¼‰

---

**é‡ç‚¹ï¼šå» BP_GaiaUIPolicy è®¾ç½® Layout Class å±æ€§ï¼è¿™æ˜¯æœ€å¯èƒ½çš„é—®é¢˜ï¼**

