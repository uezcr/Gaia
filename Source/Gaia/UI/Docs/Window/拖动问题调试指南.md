# 可拖拽窗口拖动问题调试指南

## 问题描述

用户报告：**DraggableWindow无法拖动，鼠标按下没反应**

## 已添加的调试日志

### 1. GaiaDraggableTitleBar 构造函数

```cpp
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] 构造函数调用，Visibility已设置为Visible"));
```

**检查点**：
- 确认 TitleBar 被正确创建
- 确认 Visibility 设置为 Visible

### 2. GaiaDraggableTitleBar::NativeConstruct

```cpp
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] NativeConstruct 调用"));
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] bIsDraggable = %s"), bIsDraggable ? TEXT("true") : TEXT("false"));
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] Visibility = %d"), (int32)GetVisibility());
```

**检查点**：
- `bIsDraggable` 应该为 `true`
- `Visibility` 应该为 `0` (Visible) 或 `2` (SelfHitTestInvisible)

**Visibility 枚举值**：
- `0` = Visible（可见，可交互）
- `1` = Collapsed（折叠，不可见）
- `2` = Hidden（隐藏，不可见）
- `3` = HitTestInvisible（可见，但不响应输入）
- `4` = SelfHitTestInvisible（自身不响应输入，但子控件可以）

### 3. GaiaDraggableTitleBar::NativeOnMouseButtonDown

```cpp
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] NativeOnMouseButtonDown 调用"));
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] 按键: %s"), *InMouseEvent.GetEffectingButton().ToString());
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] bIsDraggable: %s"), bIsDraggable ? TEXT("true") : TEXT("false"));
```

**检查点**：
- **如果这个日志没有输出**，说明鼠标事件没有传递到 TitleBar
- 按键应该是 `LeftMouseButton`

### 4. GaiaDraggableTitleBar::StartDragging

```cpp
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] StartDragging 调用"));
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] 父Widget: %s"), *ParentWidget->GetClass()->GetName());
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] 鼠标位置: (%.2f, %.2f)"), MousePosition.X, MousePosition.Y);
```

**检查点**：
- 父Widget应该是 `GaiaDraggableWindow` 或其子类
- 鼠标位置应该是合理的屏幕坐标

### 5. GaiaDraggableTitleBar::UpdateDragging

```cpp
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableTitleBar] 更新拖动: Position=(%.2f, %.2f)"), NewPosition.X, NewPosition.Y);
```

**检查点**：
- 在拖动时应该持续输出
- 位置应该随鼠标移动而变化

### 6. GaiaDraggableWindow::InitializeWindow

```cpp
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableWindow] InitializeWindow 调用"));
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableWindow] 找到TitleBar组件"));
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableWindow] TitleBar类: %s"), *TitleBar->GetClass()->GetName());
UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableWindow] TitleBar Visibility: %d"), (int32)TitleBar->GetVisibility());
```

**检查点**：
- 确认所有必需组件（TitleBar, WindowBorder, ContentSlot）都存在
- TitleBar 的 Visibility 应该允许交互

---

## 可能的问题和解决方案

### 问题 1: 鼠标事件没有传递到 TitleBar

**症状**：`NativeOnMouseButtonDown` 没有被调用

**可能原因**：
1. **TitleBar 的 Visibility 设置错误**
   - 如果设置为 `HitTestInvisible` 或 `SelfHitTestInvisible`，则不会响应鼠标输入

2. **TitleBar 被其他 Widget 遮挡**
   - 检查 UMG 层级结构，确保 TitleBar 在最上层
   - 检查是否有透明的 Overlay 或 Border 覆盖在 TitleBar 上

3. **TitleBar 的尺寸为零或太小**
   - 在 UMG Designer 中检查 TitleBar 的实际尺寸
   - 确保 TitleBar 有足够的大小来接收鼠标点击

4. **子控件（如 TitleText 或 CloseButton）阻挡了输入**
   - 子控件的 Visibility 可能设置为 Visible，导致父控件无法接收输入
   - 解决方案：将子控件的 Visibility 设置为 `HitTestInvisible`

**解决方案**：

```cpp
// 在 Blueprint 的 UMG Designer 中：
1. 选择 TitleBar
2. 在 Details 面板中，找到 Behavior → Visibility
3. 设置为 "Visible"

// 或者在 C++ 中强制设置：
TitleBar->SetVisibility(ESlateVisibility::Visible);

// 同时确保 TitleBarBorder 不阻挡输入：
if (TitleBarBorder)
{
    TitleBarBorder->SetVisibility(ESlateVisibility::SelfHitTestInvisible);
}
```

### 问题 2: TitleBar 的尺寸或布局问题

**症状**：日志显示 TitleBar 存在，但点击没有反应

**检查方法**：

1. 在 UMG Designer 中选中 TitleBar
2. 查看 Details → Slot → Size
3. 确保尺寸不是 (0, 0)

**解决方案**：

```
在 UMG Designer 中：
1. TitleBar 应该设置为 "Fill" 或固定高度（如 40px）
2. 确保父容器（Vertical Box）正确分配了空间
```

### 问题 3: 必需的组件缺失或命名错误

**症状**：InitializeWindow 输出 "组件不存在" 的错误

**原因**：`meta = (BindWidget)` 要求 UMG 中的组件名称必须精确匹配

**必需的组件名称**（区分大小写）：

| C++ 变量名 | UMG 组件名称（必须精确匹配） | 类型 |
|------------|----------------------------|------|
| `WindowBorder` | **WindowBorder** | Border |
| `TitleBar` | **TitleBar** | GaiaDraggableTitleBar |
| `ContentSlot` | **ContentSlot** | Named Slot |

**在 TitleBar Blueprint 中（如果自定义）**：

| C++ 变量名 | UMG 组件名称（必须精确匹配） | 类型 |
|------------|----------------------------|------|
| `TitleBarBorder` | **TitleBarBorder** | Border |
| `TitleText` | **TitleText** | CommonTextBlock |
| `CloseButton` | **CloseButton** | CommonButtonBase |

**解决方案**：
1. 在 UMG Designer 中检查组件名称
2. 确保名称完全匹配（包括大小写）
3. 如果使用的是自定义 Blueprint，确保继承链正确

### 问题 4: GetParentWidget() 返回 nullptr

**症状**：StartDragging 输出 "无法获取父Widget"

**原因**：TitleBar 无法找到父级的 UUserWidget

**解决方案**：

```cpp
// 检查 Widget 层级结构：
GaiaDraggableWindow (UUserWidget)
  └─ WindowBorder (UBorder)
      └─ Vertical Box
          ├─ TitleBar (UGaiaDraggableTitleBar) ← 应该能找到父级
          └─ ContentSlot (NamedSlot)

// 如果层级结构正确但仍然找不到，可能需要在 ShowWindow 后再初始化
```

---

## 调试步骤

### 第 1 步：检查日志输出

运行游戏并尝试拖动窗口，查看输出日志：

```
1. 是否输出了 "[GaiaDraggableTitleBar] 构造函数调用"？
   - 如果没有 → TitleBar 没有被创建
   - 检查 Blueprint 是否正确继承和设置

2. 是否输出了 "[GaiaDraggableWindow] 找到TitleBar组件"？
   - 如果输出 "TitleBar组件不存在" → 组件名称错误或未添加
   - 检查 UMG Designer 中的组件名称

3. 点击 TitleBar 时，是否输出了 "[GaiaDraggableTitleBar] NativeOnMouseButtonDown 调用"？
   - 如果没有 → 鼠标事件没有传递到 TitleBar
   - 检查 Visibility 设置和 Widget 层级

4. 是否输出了 "[GaiaDraggableTitleBar] 开始拖动检测"？
   - 如果没有但有 NativeOnMouseButtonDown → bIsDraggable 为 false 或不是左键
   - 检查配置

5. 拖动时是否输出了 "[GaiaDraggableTitleBar] 更新拖动"？
   - 如果没有 → 拖动逻辑没有执行
   - 检查 GetParentWidget() 返回值
```

### 第 2 步：在 UMG Designer 中检查

1. **打开 Window Blueprint**
2. **检查层级结构**：
   ```
   Canvas Panel
     └─ WindowBorder (Border)
         └─ Vertical Box
             ├─ TitleBar (GaiaDraggableTitleBar)
             └─ ContentSlot (Named Slot)
   ```

3. **选中 TitleBar**：
   - Details → Behavior → Visibility = **Visible**
   - Details → Slot → Size = **Fill** 或固定高度（如 40）

4. **选中 TitleBarBorder（TitleBar 内部）**：
   - Visibility = **Self Hit Test Invisible**（允许点击穿透到父级）

5. **选中 TitleText**：
   - Visibility = **Hit Test Invisible**（不阻挡鼠标事件）

### 第 3 步：强制设置 Visibility

如果问题仍然存在，在 C++ 中强制设置：

```cpp
// 在 GaiaDraggableWindow::InitializeWindow() 中添加：
if (TitleBar)
{
    TitleBar->SetVisibility(ESlateVisibility::Visible);
    UE_LOG(LogTemp, Warning, TEXT("[GaiaDraggableWindow] 强制设置TitleBar为Visible"));
}
```

---

## 常见错误模式

### 错误 1: TitleBar 在 UMG 中没有设置正确的尺寸

```
TitleBar (Size: 0x0) ❌  
↓
TitleBar (Fill / 40px) ✅
```

### 错误 2: TitleText 或 CloseButton 遮挡了输入

```
TitleText (Visibility: Visible) ❌  
↓
TitleText (Visibility: Hit Test Invisible) ✅
```

### 错误 3: 组件名称不匹配

```cpp
// C++ 中
UPROPERTY(BlueprintReadOnly, meta = (BindWidget))
TObjectPtr<UGaiaDraggableTitleBar> TitleBar;

// UMG 中组件名称
"MyTitleBar" ❌  
"TitleBar" ✅  // 必须精确匹配
```

---

## 快速检查清单

- [ ] TitleBar 组件存在且命名正确
- [ ] TitleBar Visibility 设置为 Visible
- [ ] TitleBar 有足够的尺寸（至少 40px 高度）
- [ ] TitleBarBorder (如果有) 设置为 SelfHitTestInvisible
- [ ] TitleText 和 CloseButton 设置为 HitTestInvisible
- [ ] bIsDraggable 为 true
- [ ] GetParentWidget() 能正确返回父Widget
- [ ] 没有其他透明的 Widget 遮挡 TitleBar

---

## 下一步

运行游戏，查看日志输出，根据上述调试步骤逐步排查问题。

如果所有日志都正常输出，但仍然无法拖动，可能是 `SetPositionInViewport` 没有生效，需要进一步检查窗口的添加方式（必须使用 `ShowWindow()` 而不是直接 `AddToViewport()`）。

