# å¯æ‹–æ‹½çª—å£ç³»ç»Ÿå®Œæˆæ€»ç»“

## å·²å®Œæˆå·¥ä½œ

### 1. æ ¸å¿ƒç±»å®ç° âœ…

#### UGaiaDraggableWindow (çª—å£åŸºç±»)

**æ–‡ä»¶**ï¼š
- `Source/Gaia/UI/GaiaDraggableWindow.h` (202è¡Œ)
- `Source/Gaia/UI/GaiaDraggableWindow.cpp` (311è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… ä½¿ç”¨ `GaiaDraggableTitleBar` å®ç°æ‹–åŠ¨
- âœ… å®Œç¾è§£å†³ `AddToViewport()` çš„æ»¡å±é—®é¢˜
- âœ… è‡ªåŠ¨å¤§å°å’Œä½ç½®æ§åˆ¶
- âœ… å±…ä¸­æ˜¾ç¤ºæ”¯æŒ
- âœ… å†…å®¹æ§½ä½ï¼ˆ`NamedSlot`ï¼‰
- âœ… å…³é—­æŒ‰é’®å’Œäº‹ä»¶
- âœ… å¤§å°é™åˆ¶ï¼ˆæœ€å°/æœ€å¤§ï¼‰
- âœ… ä½ç½®ä¿å­˜æ¥å£ï¼ˆé¢„ç•™ï¼‰
- âœ… å®Œå…¨å¯é…ç½®çš„çª—å£æ ·å¼

---

## æ ¸å¿ƒç‰¹æ€§è¯¦è§£

### 1. è§£å†³ `AddToViewport` æ»¡å±é—®é¢˜

**é—®é¢˜**ï¼š
```cpp
// ç”¨æˆ·çš„å›°æƒ‘
CreateWidget(...)
  â†“
AddToViewport()  // ä¸ºä»€ä¹ˆçª—å£æ€»æ˜¯æ»¡å±ï¼Ÿ
```

**åŸå› **ï¼š
`AddToViewport()` é»˜è®¤å°† Widget çš„ Desired Size è®¾ç½®ä¸ºæ•´ä¸ªè§†å£å¤§å°ï¼Œå¹¶ä¸”ï¼š
- `SetAlignmentInViewport` é»˜è®¤ä¸º `(0, 0)`ï¼ˆä½†å®é™…ä¼šå¡«å……æ•´ä¸ªè§†å£ï¼‰
- æ²¡æœ‰è°ƒç”¨ `SetDesiredSizeInViewport()`
- æ²¡æœ‰è°ƒç”¨ `SetPositionInViewport()`

**è§£å†³æ–¹æ¡ˆ**ï¼š

`ShowWindow()` å‡½æ•°æ­£ç¡®åœ°è®¾ç½®äº†è¿™ä¸‰ä¸ªå…³é”®å±æ€§ï¼š

```cpp
void UGaiaDraggableWindow::ShowWindow()
{
    // 1. æ·»åŠ åˆ°è§†å£
    AddToViewport();

    // 2. è®¾ç½®å¯¹é½æ–¹å¼ä¸ºå·¦ä¸Šè§’ï¼ˆå…³é”®ï¼ï¼‰
    SetAlignmentInViewport(FVector2D(0.0f, 0.0f));

    // 3. è®¾ç½®çª—å£å¤§å°ï¼ˆå…³é”®ï¼ï¼‰
    FVector2D ClampedSize = ClampWindowSize(DefaultWindowSize);
    SetDesiredSizeInViewport(ClampedSize);

    // 4. è®¾ç½®çª—å£ä½ç½®ï¼ˆå…³é”®ï¼ï¼‰
    if (bAutoCenterOnShow)
    {
        CenterWindow(); // å±…ä¸­æ˜¾ç¤º
    }
    else
    {
        SetPositionInViewport(DefaultWindowPosition, false);
    }
}
```

**å…³é”®API**ï¼š
- `SetAlignmentInViewport(FVector2D(0, 0))` - å·¦ä¸Šè§’å¯¹é½
- `SetDesiredSizeInViewport(Size)` - è®¾ç½®æœŸæœ›å¤§å°
- `SetPositionInViewport(Position)` - è®¾ç½®ä½ç½®

### 2. å±…ä¸­æ˜¾ç¤º

```cpp
void UGaiaDraggableWindow::CenterWindow()
{
    // è·å–è§†å£å¤§å°
    FVector2D ViewportSize;
    GEngine->GameViewport->GetViewportSize(ViewportSize);

    // è®¡ç®—å±…ä¸­ä½ç½®
    FVector2D WindowSize = DefaultWindowSize;
    FVector2D Position = (ViewportSize - WindowSize) * 0.5f;

    // ç¡®ä¿ä¸å‡ºå±å¹•
    Position.X = FMath::Max(0.0f, Position.X);
    Position.Y = FMath::Max(0.0f, Position.Y);

    // è®¾ç½®ä½ç½®
    SetPositionInViewport(Position, false);
}
```

### 3. ç»„ä»¶ç»“æ„

ä½¿ç”¨ `BindWidget` ç¡®ä¿ UMG ä¸­çš„ç»„ä»¶å¿…é¡»å­˜åœ¨ï¼š

```cpp
// çª—å£è¾¹æ¡†
UPROPERTY(BlueprintReadOnly, meta = (BindWidget))
TObjectPtr<UBorder> WindowBorder;

// æ ‡é¢˜æ 
UPROPERTY(BlueprintReadOnly, meta = (BindWidget))
TObjectPtr<UGaiaDraggableTitleBar> TitleBar;

// å†…å®¹æ§½ä½ï¼ˆåœ¨Blueprintä¸­æ·»åŠ å†…å®¹ï¼‰
UPROPERTY(BlueprintReadOnly, meta = (BindWidget))
TObjectPtr<UNamedSlot> ContentSlot;
```

**UMG ç»“æ„**ï¼š
```
Canvas Panel (æ ¹)
  â””â”€ WindowBorder (Border) â­ å¿…é¡»å‘½åä¸º "WindowBorder"
      â””â”€ Vertical Box
          â”œâ”€ TitleBar (GaiaDraggableTitleBar) â­ å¿…é¡»å‘½åä¸º "TitleBar"
          â””â”€ ContentSlot (Named Slot) â­ å¿…é¡»å‘½åä¸º "ContentSlot"
```

### 4. äº‹ä»¶ç³»ç»Ÿ

```cpp
/** çª—å£å…³é—­äº‹ä»¶ */
DECLARE_DYNAMIC_MULTICAST_DELEGATE(FOnWindowClosed);
UPROPERTY(BlueprintAssignable, Category = "Window|Events")
FOnWindowClosed OnWindowClosed;

/** çª—å£æ˜¾ç¤ºäº‹ä»¶ */
DECLARE_DYNAMIC_MULTICAST_DELEGATE(FOnWindowShown);
UPROPERTY(BlueprintAssignable, Category = "Window|Events")
FOnWindowShown OnWindowShown;
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```cpp
// C++ ç»‘å®šäº‹ä»¶
MyWindow->OnWindowClosed.AddDynamic(this, &AMyController::OnWindowClosed);

// Blueprint ç»‘å®šäº‹ä»¶
// åœ¨ Event Graph ä¸­ç›´æ¥æ‹–å‡º OnWindowClosed èŠ‚ç‚¹
```

---

## å®Œæ•´ API åˆ—è¡¨

### çª—å£æ§åˆ¶

| å‡½æ•° | è¯´æ˜ | Blueprint |
|------|------|-----------|
| `ShowWindow()` | æ˜¾ç¤ºçª—å£ï¼ˆæ·»åŠ åˆ°è§†å£å¹¶è®¾ç½®ä½ç½®ï¼‰ | âœ… |
| `CloseWindow()` | å…³é—­çª—å£ï¼ˆä»çˆ¶çº§ç§»é™¤ï¼‰ | âœ… |

### çª—å£å±æ€§

| å‡½æ•° | è¯´æ˜ | Blueprint |
|------|------|-----------|
| `SetWindowTitle(FText)` | è®¾ç½®çª—å£æ ‡é¢˜ | âœ… |
| `GetWindowTitle()` | è·å–çª—å£æ ‡é¢˜ | âœ… |
| `SetWindowSize(FVector2D)` | è®¾ç½®çª—å£å¤§å° | âœ… |
| `GetWindowSize()` | è·å–çª—å£å¤§å° | âœ… |
| `SetWindowPosition(FVector2D)` | è®¾ç½®çª—å£ä½ç½® | âœ… |
| `GetWindowPosition()` | è·å–çª—å£ä½ç½® | âœ… |
| `CenterWindow()` | å±…ä¸­æ˜¾ç¤ºçª—å£ | âœ… |
| `SetCloseButtonVisible(bool)` | è®¾ç½®æ˜¯å¦æ˜¾ç¤ºå…³é—­æŒ‰é’® | âœ… |
| `SetDraggable(bool)` | è®¾ç½®æ˜¯å¦å¯æ‹–åŠ¨ | âœ… |

### å¯é…ç½®å±æ€§

| å±æ€§ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `DefaultWindowTitle` | FText | "Window" | é»˜è®¤çª—å£æ ‡é¢˜ |
| `DefaultWindowSize` | FVector2D | (800, 600) | é»˜è®¤çª—å£å¤§å° |
| `DefaultWindowPosition` | FVector2D | (-1, -1) | é»˜è®¤çª—å£ä½ç½®ï¼ˆ-1è¡¨ç¤ºå±…ä¸­ï¼‰ |
| `bAutoCenterOnShow` | bool | true | æ˜¯å¦åœ¨æ˜¾ç¤ºæ—¶è‡ªåŠ¨å±…ä¸­ |
| `MinWindowSize` | FVector2D | (400, 300) | æœ€å°çª—å£å¤§å° |
| `MaxWindowSize` | FVector2D | (0, 0) | æœ€å¤§çª—å£å¤§å°ï¼ˆ0è¡¨ç¤ºä¸é™åˆ¶ï¼‰ |
| `bShowCloseButton` | bool | true | æ˜¯å¦æ˜¾ç¤ºå…³é—­æŒ‰é’® |
| `WindowBorderColor` | FLinearColor | é‡‘è‰² | çª—å£è¾¹æ¡†é¢œè‰² |
| `WindowBorderThickness` | float | 2.0 | çª—å£è¾¹æ¡†å®½åº¦ |
| `bSaveWindowPosition` | bool | false | æ˜¯å¦ä¿å­˜çª—å£ä½ç½® |
| `WindowPositionSaveKey` | FString | "" | çª—å£ä½ç½®ä¿å­˜Key |

---

## ä½¿ç”¨æµç¨‹

### 1. åˆ›å»º Widget Blueprint

```
Content Browser å³é”®
  â†’ User Interface
  â†’ Widget Blueprint
  â†’ çˆ¶ç±»é€‰æ‹© GaiaDraggableWindow
  â†’ å‘½åä¸º WBP_MyWindow
```

### 2. è®¾è®¡ UI ç»“æ„

åœ¨ UMG Designer ä¸­æ·»åŠ å¿…éœ€çš„ç»„ä»¶ï¼š

```
1. æ·»åŠ  Borderï¼Œå‘½åä¸º "WindowBorder"
2. åœ¨ Border å†…æ·»åŠ  Vertical Box
3. åœ¨ Vertical Box ä¸­æ·»åŠ ï¼š
   - GaiaDraggableTitleBarï¼Œå‘½åä¸º "TitleBar"
   - Named Slotï¼Œå‘½åä¸º "ContentSlot"
4. åœ¨ ContentSlot ä¸­æ·»åŠ ä½ çš„å†…å®¹
```

### 3. é…ç½®çª—å£å±æ€§

åœ¨ Details é¢æ¿ä¸­è®¾ç½®ï¼š
- Default Window Title = "æˆ‘çš„çª—å£"
- Default Window Size = (1000, 700)
- Auto Center On Show = true

### 4. æ˜¾ç¤ºçª—å£

**C++**ï¼š
```cpp
UGaiaDraggableWindow* Window = CreateWidget<UGaiaDraggableWindow>(GetWorld(), WindowClass);
Window->ShowWindow(); // ä½¿ç”¨è¿™ä¸ªï¼Œä¸è¦ç”¨ AddToViewport()
```

**Blueprint**ï¼š
```
Create Widget (WBP_MyWindow)
  â†“
Show Window (è°ƒç”¨æ­¤èŠ‚ç‚¹)
```

---

## ç¼–è¯‘çŠ¶æ€

âœ… **ç¼–è¯‘æˆåŠŸ**ï¼š

```
[3/4] Link [x64] GaiaGame.exe
[4/4] WriteMetadata GaiaGame.target
Result: Succeeded
Total execution time: 29.89 seconds
```

---

## è®¾è®¡äº®ç‚¹

### 1. å½»åº•è§£å†³ AddToViewport çš„æ»¡å±é—®é¢˜

é€šè¿‡æ­£ç¡®ä½¿ç”¨ï¼š
- `SetAlignmentInViewport()`
- `SetDesiredSizeInViewport()`
- `SetPositionInViewport()`

å®Œç¾æ§åˆ¶çª—å£å¤§å°å’Œä½ç½®ã€‚

### 2. ç»„ä»¶è‡ªåŠ¨ç»‘å®š

ä½¿ç”¨ `meta = (BindWidget)` ç¡®ä¿ UMG ç»„ä»¶ç»“æ„æ­£ç¡®ï¼š
```cpp
UPROPERTY(BlueprintReadOnly, meta = (BindWidget))
TObjectPtr<UBorder> WindowBorder;
```

å¦‚æœ UMG ä¸­ç¼ºå°‘ `WindowBorder` ç»„ä»¶æˆ–åç§°é”™è¯¯ï¼Œä¼šåœ¨è¿è¡Œæ—¶æŠ¥é”™ã€‚

### 3. å†…å®¹è‡ªå®šä¹‰

ä½¿ç”¨ `NamedSlot` å®ç°å†…å®¹åŒºåŸŸçš„å®Œå…¨è‡ªå®šä¹‰ï¼š
```cpp
UPROPERTY(BlueprintReadOnly, meta = (BindWidget))
TObjectPtr<UNamedSlot> ContentSlot;
```

åœ¨ Blueprint çš„ UMG Designer ä¸­ï¼Œ`ContentSlot` å¯ä»¥åŒ…å«ä»»ä½•å­ç»„ä»¶ã€‚

### 4. ç»§æ‰¿æ¶æ„

```
UCommonUserWidget (CommonUI)
  â†“
UGaiaDraggableWindow (çª—å£åŸºç±»)
  â†“
UInventoryWindow, UCharacterWindow, etc. (å…·ä½“çª—å£)
```

é€šè¿‡ç»§æ‰¿ `UCommonUserWidget`ï¼Œæœªæ¥å¯ä»¥åˆ©ç”¨ CommonUI çš„ç‰¹æ€§ï¼ˆè¾“å…¥è·¯ç”±ã€æ¿€æ´»æ ˆç­‰ï¼‰ã€‚

### 5. äº‹ä»¶é©±åŠ¨è®¾è®¡

ä½¿ç”¨å§”æ‰˜å®ç°æ¾è€¦åˆï¼š
```cpp
// å®šä¹‰äº‹ä»¶
DECLARE_DYNAMIC_MULTICAST_DELEGATE(FOnWindowClosed);
UPROPERTY(BlueprintAssignable)
FOnWindowClosed OnWindowClosed;

// è§¦å‘äº‹ä»¶
OnWindowClosed.Broadcast();

// ç»‘å®šäº‹ä»¶
Window->OnWindowClosed.AddDynamic(this, &MyClass::HandleWindowClosed);
```

### 6. å±å¹•è¾¹ç•Œä¿æŠ¤

é€šè¿‡ `GaiaDraggableTitleBar` çš„è¾¹ç•Œé™åˆ¶ï¼Œçª—å£æ°¸è¿œä¸ä¼šè¢«æ‹–å‡ºå±å¹•ï¼š
```cpp
// åœ¨ GaiaDraggableTitleBar.cpp ä¸­
NewPosition.X = FMath::Clamp(NewPosition.X, 0.0f, ViewportSize.X - WidgetSize.X);
NewPosition.Y = FMath::Clamp(NewPosition.Y, 0.0f, ViewportSize.Y - WidgetSize.Y);
```

---

## åº”ç”¨åœºæ™¯

### 1. èƒŒåŒ…ç³»ç»Ÿ
```cpp
UInventoryWindow : public UGaiaDraggableWindow
{
    // åœ¨ ContentSlot ä¸­æ˜¾ç¤ºç‰©å“ç½‘æ ¼
};
```

### 2. è§’è‰²é¢æ¿
```cpp
UCharacterWindow : public UGaiaDraggableWindow
{
    // åœ¨ ContentSlot ä¸­æ˜¾ç¤ºè§’è‰²å±æ€§ã€è£…å¤‡æ§½ç­‰
};
```

### 3. ä»»åŠ¡é¢æ¿
```cpp
UQuestWindow : public UGaiaDraggableWindow
{
    // åœ¨ ContentSlot ä¸­æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
};
```

### 4. è®¾ç½®é¢æ¿
```cpp
USettingsWindow : public UGaiaDraggableWindow
{
    // åœ¨ ContentSlot ä¸­æ˜¾ç¤ºè®¾ç½®é€‰é¡¹
};
```

### 5. å¯¹è¯æ¡†
```cpp
UDialogWindow : public UGaiaDraggableWindow
{
    // åœ¨ ContentSlot ä¸­æ˜¾ç¤ºå¯¹è¯å†…å®¹å’Œé€‰é¡¹æŒ‰é’®
};
```

---

## åç»­æ‰©å±•

### å¯èƒ½çš„åŠŸèƒ½æ‰©å±•

1. **çª—å£å¤§å°è°ƒæ•´**
   - åœ¨çª—å£è¾¹ç¼˜æ·»åŠ æ‹–åŠ¨åŒºåŸŸ
   - å®ç° 8 æ–¹å‘çš„å¤§å°è°ƒæ•´

2. **çª—å£æœ€å°åŒ–/æœ€å¤§åŒ–**
   - æ·»åŠ æœ€å°åŒ–æŒ‰é’®
   - å®ç°æœ€å°åŒ–åˆ°ä»»åŠ¡æ /Dock

3. **å¤šçª—å£ç®¡ç†**
   - å®ç°çª—å£ Z-Order ç®¡ç†
   - ç‚¹å‡»çª—å£æ—¶è‡ªåŠ¨ç½®é¡¶
   - çª—å£ç„¦ç‚¹ç®¡ç†

4. **çª—å£åŠ¨ç”»**
   - æ‰“å¼€/å…³é—­åŠ¨ç”»
   - æœ€å°åŒ–/æœ€å¤§åŒ–åŠ¨ç”»
   - ä½¿ç”¨ UMG Animation

5. **çª—å£ä½ç½®ä¿å­˜**
   - å®Œå–„ `LoadWindowPosition()` å’Œ `SaveWindowPosition()`
   - è¿æ¥åˆ° `GameUserSettings` æˆ–å­˜æ¡£ç³»ç»Ÿ
   - æ”¯æŒå¤šæ˜¾ç¤ºå™¨

6. **çª—å£åœé **
   - å®ç°çª—å£åœé åˆ°å±å¹•è¾¹ç¼˜
   - çª—å£ç£æ€§å¸é™„

7. **çª—å£é€æ˜åº¦**
   - æ”¯æŒçª—å£é€æ˜åº¦è®¾ç½®
   - å¤±ç„¦æ—¶è‡ªåŠ¨é™ä½é€æ˜åº¦

---

## æ€»ç»“

### å·²å®ç°åŠŸèƒ½ âœ…

- âœ… å®Œæ•´çš„å¯æ‹–æ‹½çª—å£åŸºç±»
- âœ… è§£å†³ `AddToViewport` æ»¡å±é—®é¢˜
- âœ… è‡ªåŠ¨å¤§å°å’Œä½ç½®æ§åˆ¶
- âœ… å±…ä¸­æ˜¾ç¤ºæ”¯æŒ
- âœ… å†…å®¹è‡ªå®šä¹‰ï¼ˆ`NamedSlot`ï¼‰
- âœ… å…³é—­æŒ‰é’®å’Œäº‹ä»¶
- âœ… å¤§å°é™åˆ¶ï¼ˆæœ€å°/æœ€å¤§ï¼‰
- âœ… å®Œå…¨å¯é…ç½®çš„çª—å£æ ·å¼
- âœ… å±å¹•è¾¹ç•Œä¿æŠ¤
- âœ… Blueprint å‹å¥½
- âœ… äº‹ä»¶é©±åŠ¨è®¾è®¡

### æ ¸å¿ƒä»·å€¼

1. **å¼€ç®±å³ç”¨**ï¼šåˆ›å»º Blueprint ç»§æ‰¿å³å¯ä½¿ç”¨
2. **è§£å†³ç—›ç‚¹**ï¼šå®Œç¾è§£å†³ `AddToViewport` çš„æ»¡å±é—®é¢˜
3. **é«˜åº¦å¯é…ç½®**ï¼šæ‰€æœ‰å±æ€§éƒ½å¯åœ¨ Blueprint ä¸­é…ç½®
4. **æ˜“äºæ‰©å±•**ï¼šé€šè¿‡ç»§æ‰¿å¯ä»¥å¿«é€Ÿåˆ›å»ºå„ç§çª—å£
5. **Blueprint å‹å¥½**ï¼šæ‰€æœ‰åŠŸèƒ½éƒ½æš´éœ²ç»™ Blueprint

### ä½¿ç”¨å»ºè®®

1. **ç»Ÿä¸€ä½¿ç”¨ `ShowWindow()`**ï¼šä¸è¦ç›´æ¥ä½¿ç”¨ `AddToViewport()`
2. **å‘½åè§„èŒƒ**ï¼šUMG ç»„ä»¶å¿…é¡»ä½¿ç”¨ç²¾ç¡®çš„åç§°ï¼ˆ`WindowBorder`, `TitleBar`, `ContentSlot`ï¼‰
3. **å†…å®¹è‡ªå®šä¹‰**ï¼šæ‰€æœ‰å…·ä½“å†…å®¹éƒ½åº”æ”¾åœ¨ `ContentSlot` ä¸­
4. **äº‹ä»¶ç»‘å®š**ï¼šä½¿ç”¨ `OnWindowClosed` å’Œ `OnWindowShown` äº‹ä»¶ç®¡ç†çª—å£ç”Ÿå‘½å‘¨æœŸ

---

## æ–‡æ¡£

- âœ… `GaiaDraggableWindow.h` - å¤´æ–‡ä»¶ï¼ˆ202è¡Œï¼‰
- âœ… `GaiaDraggableWindow.cpp` - å®ç°æ–‡ä»¶ï¼ˆ311è¡Œï¼‰
- âœ… `GaiaDraggableWindowä½¿ç”¨æŒ‡å—.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- âœ… `å¯æ‹–æ‹½çª—å£å®Œæˆæ€»ç»“.md` - æœ¬æ–‡æ¡£

---

ç°åœ¨ä½ å¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„å¯æ‹–æ‹½çª—å£ï¼Œæ„å»ºå®Œæ•´çš„çª—å£åŒ– UI ç³»ç»Ÿï¼ğŸ‰

