# Gaia UI架构说明

> **最后更新：** 2025-10-27

---

## 📐 架构设计

### 核心理念

**GaiaUIManagerSubsystem** 被设计为**游戏所有UI的统一管理器**，而非仅限于库存系统UI。

这样的设计有以下优势：
1. ✅ **统一管理** - 所有UI通过一个入口管理
2. ✅ **易于扩展** - 添加新系统UI时只需扩展此类
3. ✅ **层级清晰** - 使用CommonUI的Layer System统一管理Z-Order
4. ✅ **避免冗余** - 不需要为每个系统创建独立的UI管理器

---

## 🏗️ 系统架构

```
UGaiaUIManagerSubsystem (游戏UI总管理器)
│
├─ 通用Layer操作
│  ├─ PushWidgetToLayer()      - 推入任意Widget到指定Layer
│  └─ RemoveWidgetFromLayer()  - 从Layer移除Widget
│
├─ 库存系统UI
│  ├─ OpenContainerWindow()    - 打开容器窗口
│  ├─ CloseContainerWindow()   - 关闭容器窗口
│  ├─ CloseAllContainerWindows() - 关闭所有容器窗口
│  └─ IsContainerWindowOpen()  - 检查容器窗口是否打开
│
├─ 对话系统UI (待扩展)
│  ├─ OpenDialogueWindow()
│  └─ CloseDialogueWindow()
│
├─ 任务系统UI (待扩展)
│  ├─ OpenQuestPanel()
│  └─ CloseQuestPanel()
│
├─ 商店/交易UI (待扩展)
│  ├─ OpenShopWindow()
│  └─ CloseShopWindow()
│
└─ 角色/装备UI (待扩展)
   ├─ OpenCharacterPanel()
   └─ CloseCharacterPanel()
```

---

## 📦 目录结构

```
Source/Gaia/UI/
│
├─ GaiaUIManagerSubsystem.h/.cpp    - UI总管理器
├─ GaiaUIPolicy.h/.cpp              - UI策略（CommonUI）
├─ GaiaPrimaryGameLayout.h/.cpp     - 主UI布局
│
├─ Inventory/                       - 库存系统UI
│  ├─ GaiaContainerWindowWidget.h/.cpp
│  ├─ GaiaContainerGridWidget.h/.cpp
│  ├─ GaiaItemSlotWidget.h/.cpp
│  ├─ GaiaContainerDebugInfoWidget.h/.cpp
│  └─ GaiaItemDragDropOperation.h/.cpp
│
├─ Dialogue/  (待添加)              - 对话系统UI
├─ Quest/  (待添加)                 - 任务系统UI
├─ Shop/  (待添加)                  - 商店系统UI
└─ Character/  (待添加)             - 角色系统UI
```

---

## 🔌 如何扩展新系统UI

### 示例：添加对话系统UI

#### 1. 在 GaiaUIManagerSubsystem.h 中添加声明

```cpp
// ========================================
// 对话系统UI
// ========================================

/**
 * 打开对话窗口
 * @param DialogueID 对话ID
 * @return 对话窗口实例
 */
UFUNCTION(BlueprintCallable, Category = "Gaia|UI|Dialogue")
UGaiaDialogueWindowWidget* OpenDialogueWindow(const FName& DialogueID);

/**
 * 关闭对话窗口
 */
UFUNCTION(BlueprintCallable, Category = "Gaia|UI|Dialogue")
void CloseDialogueWindow();

protected:
/** 对话窗口Widget类 */
UPROPERTY(config, EditDefaultsOnly, Category = "Gaia|UI|Dialogue")
TSoftClassPtr<UGaiaDialogueWindowWidget> DialogueWindowClass;

/** 当前打开的对话窗口 */
UPROPERTY(Transient)
TObjectPtr<UGaiaDialogueWindowWidget> CurrentDialogueWindow;
```

#### 2. 在 GaiaUIManagerSubsystem.cpp 中实现

```cpp
UGaiaDialogueWindowWidget* UGaiaUIManagerSubsystem::OpenDialogueWindow(const FName& DialogueID)
{
    if (!DialogueID.IsValid())
    {
        UE_LOG(LogGaia, Error, TEXT("[Gaia UI] 打开对话窗口失败：DialogueID无效"));
        return nullptr;
    }

    // 如果已有对话窗口，先关闭
    if (CurrentDialogueWindow)
    {
        CloseDialogueWindow();
    }

    UGaiaPrimaryGameLayout* Layout = GetPrimaryGameLayout();
    if (!Layout)
    {
        return nullptr;
    }

    UClass* WidgetClass = DialogueWindowClass.LoadSynchronous();
    if (!WidgetClass)
    {
        UE_LOG(LogGaia, Error, TEXT("[Gaia UI] 无法加载DialogueWindowClass"));
        return nullptr;
    }

    // 推入到模态层（对话通常是模态的）
    CurrentDialogueWindow = Layout->PushWidgetToLayerStack<UGaiaDialogueWindowWidget>(
        UGaiaPrimaryGameLayout::GetModalLayerTag(),
        WidgetClass,
        [DialogueID](UGaiaDialogueWindowWidget& Widget)
        {
            Widget.InitializeDialogue(DialogueID);
        }
    );

    return CurrentDialogueWindow;
}

void UGaiaUIManagerSubsystem::CloseDialogueWindow()
{
    if (!CurrentDialogueWindow)
    {
        return;
    }

    UGaiaPrimaryGameLayout* Layout = GetPrimaryGameLayout();
    if (Layout)
    {
        Layout->FindAndRemoveWidgetFromLayer(CurrentDialogueWindow);
    }

    CurrentDialogueWindow = nullptr;
}
```

#### 3. 创建对话窗口Widget

在 `Source/Gaia/UI/Dialogue/` 目录下创建：
- `GaiaDialogueWindowWidget.h/.cpp`

#### 4. 在Project Settings中配置

**Edit → Project Settings → Gaia UI Manager Subsystem**
- 设置 `Dialogue Window Class` 为对应的蓝图类

---

## 🎯 Blueprint Category分类

为了保持一致性和易用性，所有UI相关函数的Category遵循以下规则：

```cpp
// 通用UI操作
Category = "Gaia|UI"

// 库存系统UI
Category = "Gaia|UI|Inventory"

// 对话系统UI
Category = "Gaia|UI|Dialogue"

// 任务系统UI
Category = "Gaia|UI|Quest"

// 商店系统UI
Category = "Gaia|UI|Shop"

// 角色系统UI
Category = "Gaia|UI|Character"
```

---

## 📊 Layer使用建议

不同类型的UI应该使用合适的Layer：

| UI类型 | 推荐Layer | GameplayTag | 说明 |
|--------|-----------|-------------|------|
| HUD、玩家背包 | GameLayer | `UI.Layer.Game` | 游戏主界面 |
| 世界容器、NPC背包 | ContainerLayer | `UI.Layer.Container` | 可以多窗口 |
| 右键菜单 | MenuLayer | `UI.Layer.Menu` | 上下文菜单 |
| 对话、确认框 | ModalLayer | `UI.Layer.Modal` | 模态窗口，最高层 |

---

## 🔧 配置说明

### Project Settings位置

**Edit → Project Settings → Game → Gaia UI Manager Subsystem**

### 可配置项

- **Container Window Class** - 容器窗口Widget类
- **Dialogue Window Class** - 对话窗口Widget类（待添加）
- **Quest Panel Class** - 任务面板Widget类（待添加）
- **Shop Window Class** - 商店窗口Widget类（待添加）
- **Character Panel Class** - 角色面板Widget类（待添加）

---

## 📝 设计原则

### 1. 单一职责
- UIManager只负责UI的创建、显示、隐藏、销毁
- 具体的UI逻辑在各自的Widget中实现

### 2. 松耦合
- UIManager不依赖具体的游戏逻辑系统
- 各系统通过配置提供Widget类

### 3. 易扩展
- 添加新系统UI只需：
  1. 添加Widget类
  2. 在UIManager中添加Open/Close函数
  3. 在Project Settings中配置

### 4. 统一管理
- 所有UI通过Layer System统一管理
- Z-Order自动处理
- ESC键自动处理

---

## 🚀 未来扩展方向

### 短期（已规划）
- [ ] 对话系统UI
- [ ] 右键菜单系统
- [ ] 数量输入对话框
- [ ] 物品Tooltip

### 中期
- [ ] 任务系统UI
- [ ] 商店/交易UI
- [ ] 角色面板UI
- [ ] 装备面板UI

### 长期
- [ ] HUD系统
- [ ] 小地图系统
- [ ] 聊天系统UI
- [ ] 队伍/公会UI

---

## 📚 相关文档

- **Inventory/README.md** - 库存系统总文档
- **Inventory/UI系统使用手册.md** - UI系统使用指南
- **Inventory/UI系统架构说明.md** - UI技术架构

---

**总结：** GaiaUIManagerSubsystem是一个可扩展的UI管理框架，当前已实现库存系统UI，未来可以轻松添加其他游戏系统的UI。

