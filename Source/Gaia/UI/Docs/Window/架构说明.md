# Gaia UIæ¶æ„è¯´æ˜

> **æœ€åæ›´æ–°ï¼š** 2025-10-27

---

## ğŸ“ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç†å¿µ

**GaiaUIManagerSubsystem** è¢«è®¾è®¡ä¸º**æ¸¸æˆæ‰€æœ‰UIçš„ç»Ÿä¸€ç®¡ç†å™¨**ï¼Œè€Œéä»…é™äºåº“å­˜ç³»ç»ŸUIã€‚

è¿™æ ·çš„è®¾è®¡æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š
1. âœ… **ç»Ÿä¸€ç®¡ç†** - æ‰€æœ‰UIé€šè¿‡ä¸€ä¸ªå…¥å£ç®¡ç†
2. âœ… **æ˜“äºæ‰©å±•** - æ·»åŠ æ–°ç³»ç»ŸUIæ—¶åªéœ€æ‰©å±•æ­¤ç±»
3. âœ… **å±‚çº§æ¸…æ™°** - ä½¿ç”¨CommonUIçš„Layer Systemç»Ÿä¸€ç®¡ç†Z-Order
4. âœ… **é¿å…å†—ä½™** - ä¸éœ€è¦ä¸ºæ¯ä¸ªç³»ç»Ÿåˆ›å»ºç‹¬ç«‹çš„UIç®¡ç†å™¨

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
UGaiaUIManagerSubsystem (æ¸¸æˆUIæ€»ç®¡ç†å™¨)
â”‚
â”œâ”€ é€šç”¨Layeræ“ä½œ
â”‚  â”œâ”€ PushWidgetToLayer()      - æ¨å…¥ä»»æ„Widgetåˆ°æŒ‡å®šLayer
â”‚  â””â”€ RemoveWidgetFromLayer()  - ä»Layerç§»é™¤Widget
â”‚
â”œâ”€ åº“å­˜ç³»ç»ŸUI
â”‚  â”œâ”€ OpenContainerWindow()    - æ‰“å¼€å®¹å™¨çª—å£
â”‚  â”œâ”€ CloseContainerWindow()   - å…³é—­å®¹å™¨çª—å£
â”‚  â”œâ”€ CloseAllContainerWindows() - å…³é—­æ‰€æœ‰å®¹å™¨çª—å£
â”‚  â””â”€ IsContainerWindowOpen()  - æ£€æŸ¥å®¹å™¨çª—å£æ˜¯å¦æ‰“å¼€
â”‚
â”œâ”€ å¯¹è¯ç³»ç»ŸUI (å¾…æ‰©å±•)
â”‚  â”œâ”€ OpenDialogueWindow()
â”‚  â””â”€ CloseDialogueWindow()
â”‚
â”œâ”€ ä»»åŠ¡ç³»ç»ŸUI (å¾…æ‰©å±•)
â”‚  â”œâ”€ OpenQuestPanel()
â”‚  â””â”€ CloseQuestPanel()
â”‚
â”œâ”€ å•†åº—/äº¤æ˜“UI (å¾…æ‰©å±•)
â”‚  â”œâ”€ OpenShopWindow()
â”‚  â””â”€ CloseShopWindow()
â”‚
â””â”€ è§’è‰²/è£…å¤‡UI (å¾…æ‰©å±•)
   â”œâ”€ OpenCharacterPanel()
   â””â”€ CloseCharacterPanel()
```

---

## ğŸ“¦ ç›®å½•ç»“æ„

```
Source/Gaia/UI/
â”‚
â”œâ”€ GaiaUIManagerSubsystem.h/.cpp    - UIæ€»ç®¡ç†å™¨
â”œâ”€ GaiaUIPolicy.h/.cpp              - UIç­–ç•¥ï¼ˆCommonUIï¼‰
â”œâ”€ GaiaPrimaryGameLayout.h/.cpp     - ä¸»UIå¸ƒå±€
â”‚
â”œâ”€ Inventory/                       - åº“å­˜ç³»ç»ŸUI
â”‚  â”œâ”€ GaiaContainerWindowWidget.h/.cpp
â”‚  â”œâ”€ GaiaContainerGridWidget.h/.cpp
â”‚  â”œâ”€ GaiaItemSlotWidget.h/.cpp
â”‚  â”œâ”€ GaiaContainerDebugInfoWidget.h/.cpp
â”‚  â””â”€ GaiaItemDragDropOperation.h/.cpp
â”‚
â”œâ”€ Dialogue/  (å¾…æ·»åŠ )              - å¯¹è¯ç³»ç»ŸUI
â”œâ”€ Quest/  (å¾…æ·»åŠ )                 - ä»»åŠ¡ç³»ç»ŸUI
â”œâ”€ Shop/  (å¾…æ·»åŠ )                  - å•†åº—ç³»ç»ŸUI
â””â”€ Character/  (å¾…æ·»åŠ )             - è§’è‰²ç³»ç»ŸUI
```

---

## ğŸ”Œ å¦‚ä½•æ‰©å±•æ–°ç³»ç»ŸUI

### ç¤ºä¾‹ï¼šæ·»åŠ å¯¹è¯ç³»ç»ŸUI

#### 1. åœ¨ GaiaUIManagerSubsystem.h ä¸­æ·»åŠ å£°æ˜

```cpp
// ========================================
// å¯¹è¯ç³»ç»ŸUI
// ========================================

/**
 * æ‰“å¼€å¯¹è¯çª—å£
 * @param DialogueID å¯¹è¯ID
 * @return å¯¹è¯çª—å£å®ä¾‹
 */
UFUNCTION(BlueprintCallable, Category = "Gaia|UI|Dialogue")
UGaiaDialogueWindowWidget* OpenDialogueWindow(const FName& DialogueID);

/**
 * å…³é—­å¯¹è¯çª—å£
 */
UFUNCTION(BlueprintCallable, Category = "Gaia|UI|Dialogue")
void CloseDialogueWindow();

protected:
/** å¯¹è¯çª—å£Widgetç±» */
UPROPERTY(config, EditDefaultsOnly, Category = "Gaia|UI|Dialogue")
TSoftClassPtr<UGaiaDialogueWindowWidget> DialogueWindowClass;

/** å½“å‰æ‰“å¼€çš„å¯¹è¯çª—å£ */
UPROPERTY(Transient)
TObjectPtr<UGaiaDialogueWindowWidget> CurrentDialogueWindow;
```

#### 2. åœ¨ GaiaUIManagerSubsystem.cpp ä¸­å®ç°

```cpp
UGaiaDialogueWindowWidget* UGaiaUIManagerSubsystem::OpenDialogueWindow(const FName& DialogueID)
{
    if (!DialogueID.IsValid())
    {
        UE_LOG(LogGaia, Error, TEXT("[Gaia UI] æ‰“å¼€å¯¹è¯çª—å£å¤±è´¥ï¼šDialogueIDæ— æ•ˆ"));
        return nullptr;
    }

    // å¦‚æœå·²æœ‰å¯¹è¯çª—å£ï¼Œå…ˆå…³é—­
    if (CurrentDialogueWindow)
    {
        CloseDialogueWindow();
    }

    UGaiaPrimaryGameLayout* Layout = GetPrimaryGameLayout();
    if (!Layout)
    {
        return nullptr;
    }

    UClass* WidgetClass = DialogueWindowClass.LoadSynchronous();
    if (!WidgetClass)
    {
        UE_LOG(LogGaia, Error, TEXT("[Gaia UI] æ— æ³•åŠ è½½DialogueWindowClass"));
        return nullptr;
    }

    // æ¨å…¥åˆ°æ¨¡æ€å±‚ï¼ˆå¯¹è¯é€šå¸¸æ˜¯æ¨¡æ€çš„ï¼‰
    CurrentDialogueWindow = Layout->PushWidgetToLayerStack<UGaiaDialogueWindowWidget>(
        UGaiaPrimaryGameLayout::GetModalLayerTag(),
        WidgetClass,
        [DialogueID](UGaiaDialogueWindowWidget& Widget)
        {
            Widget.InitializeDialogue(DialogueID);
        }
    );

    return CurrentDialogueWindow;
}

void UGaiaUIManagerSubsystem::CloseDialogueWindow()
{
    if (!CurrentDialogueWindow)
    {
        return;
    }

    UGaiaPrimaryGameLayout* Layout = GetPrimaryGameLayout();
    if (Layout)
    {
        Layout->FindAndRemoveWidgetFromLayer(CurrentDialogueWindow);
    }

    CurrentDialogueWindow = nullptr;
}
```

#### 3. åˆ›å»ºå¯¹è¯çª—å£Widget

åœ¨ `Source/Gaia/UI/Dialogue/` ç›®å½•ä¸‹åˆ›å»ºï¼š
- `GaiaDialogueWindowWidget.h/.cpp`

#### 4. åœ¨Project Settingsä¸­é…ç½®

**Edit â†’ Project Settings â†’ Gaia UI Manager Subsystem**
- è®¾ç½® `Dialogue Window Class` ä¸ºå¯¹åº”çš„è“å›¾ç±»

---

## ğŸ¯ Blueprint Categoryåˆ†ç±»

ä¸ºäº†ä¿æŒä¸€è‡´æ€§å’Œæ˜“ç”¨æ€§ï¼Œæ‰€æœ‰UIç›¸å…³å‡½æ•°çš„Categoryéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

```cpp
// é€šç”¨UIæ“ä½œ
Category = "Gaia|UI"

// åº“å­˜ç³»ç»ŸUI
Category = "Gaia|UI|Inventory"

// å¯¹è¯ç³»ç»ŸUI
Category = "Gaia|UI|Dialogue"

// ä»»åŠ¡ç³»ç»ŸUI
Category = "Gaia|UI|Quest"

// å•†åº—ç³»ç»ŸUI
Category = "Gaia|UI|Shop"

// è§’è‰²ç³»ç»ŸUI
Category = "Gaia|UI|Character"
```

---

## ğŸ“Š Layerä½¿ç”¨å»ºè®®

ä¸åŒç±»å‹çš„UIåº”è¯¥ä½¿ç”¨åˆé€‚çš„Layerï¼š

| UIç±»å‹ | æ¨èLayer | GameplayTag | è¯´æ˜ |
|--------|-----------|-------------|------|
| HUDã€ç©å®¶èƒŒåŒ… | GameLayer | `UI.Layer.Game` | æ¸¸æˆä¸»ç•Œé¢ |
| ä¸–ç•Œå®¹å™¨ã€NPCèƒŒåŒ… | ContainerLayer | `UI.Layer.Container` | å¯ä»¥å¤šçª—å£ |
| å³é”®èœå• | MenuLayer | `UI.Layer.Menu` | ä¸Šä¸‹æ–‡èœå• |
| å¯¹è¯ã€ç¡®è®¤æ¡† | ModalLayer | `UI.Layer.Modal` | æ¨¡æ€çª—å£ï¼Œæœ€é«˜å±‚ |

---

## ğŸ”§ é…ç½®è¯´æ˜

### Project Settingsä½ç½®

**Edit â†’ Project Settings â†’ Game â†’ Gaia UI Manager Subsystem**

### å¯é…ç½®é¡¹

- **Container Window Class** - å®¹å™¨çª—å£Widgetç±»
- **Dialogue Window Class** - å¯¹è¯çª—å£Widgetç±»ï¼ˆå¾…æ·»åŠ ï¼‰
- **Quest Panel Class** - ä»»åŠ¡é¢æ¿Widgetç±»ï¼ˆå¾…æ·»åŠ ï¼‰
- **Shop Window Class** - å•†åº—çª—å£Widgetç±»ï¼ˆå¾…æ·»åŠ ï¼‰
- **Character Panel Class** - è§’è‰²é¢æ¿Widgetç±»ï¼ˆå¾…æ·»åŠ ï¼‰

---

## ğŸ“ è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£
- UIManageråªè´Ÿè´£UIçš„åˆ›å»ºã€æ˜¾ç¤ºã€éšè—ã€é”€æ¯
- å…·ä½“çš„UIé€»è¾‘åœ¨å„è‡ªçš„Widgetä¸­å®ç°

### 2. æ¾è€¦åˆ
- UIManagerä¸ä¾èµ–å…·ä½“çš„æ¸¸æˆé€»è¾‘ç³»ç»Ÿ
- å„ç³»ç»Ÿé€šè¿‡é…ç½®æä¾›Widgetç±»

### 3. æ˜“æ‰©å±•
- æ·»åŠ æ–°ç³»ç»ŸUIåªéœ€ï¼š
  1. æ·»åŠ Widgetç±»
  2. åœ¨UIManagerä¸­æ·»åŠ Open/Closeå‡½æ•°
  3. åœ¨Project Settingsä¸­é…ç½®

### 4. ç»Ÿä¸€ç®¡ç†
- æ‰€æœ‰UIé€šè¿‡Layer Systemç»Ÿä¸€ç®¡ç†
- Z-Orderè‡ªåŠ¨å¤„ç†
- ESCé”®è‡ªåŠ¨å¤„ç†

---

## ğŸš€ æœªæ¥æ‰©å±•æ–¹å‘

### çŸ­æœŸï¼ˆå·²è§„åˆ’ï¼‰
- [ ] å¯¹è¯ç³»ç»ŸUI
- [ ] å³é”®èœå•ç³»ç»Ÿ
- [ ] æ•°é‡è¾“å…¥å¯¹è¯æ¡†
- [ ] ç‰©å“Tooltip

### ä¸­æœŸ
- [ ] ä»»åŠ¡ç³»ç»ŸUI
- [ ] å•†åº—/äº¤æ˜“UI
- [ ] è§’è‰²é¢æ¿UI
- [ ] è£…å¤‡é¢æ¿UI

### é•¿æœŸ
- [ ] HUDç³»ç»Ÿ
- [ ] å°åœ°å›¾ç³»ç»Ÿ
- [ ] èŠå¤©ç³»ç»ŸUI
- [ ] é˜Ÿä¼/å…¬ä¼šUI

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Inventory/README.md** - åº“å­˜ç³»ç»Ÿæ€»æ–‡æ¡£
- **Inventory/UIç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ.md** - UIç³»ç»Ÿä½¿ç”¨æŒ‡å—
- **Inventory/UIç³»ç»Ÿæ¶æ„è¯´æ˜.md** - UIæŠ€æœ¯æ¶æ„

---

**æ€»ç»“ï¼š** GaiaUIManagerSubsystemæ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„UIç®¡ç†æ¡†æ¶ï¼Œå½“å‰å·²å®ç°åº“å­˜ç³»ç»ŸUIï¼Œæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ å…¶ä»–æ¸¸æˆç³»ç»Ÿçš„UIã€‚

